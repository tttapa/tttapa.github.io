<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Pieter P">
    <link rel="stylesheet" type="text/css" href="/CSS/Pages.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- No MathJax -->
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="theme-color" content="#ccc">
    <meta name="keywords" content="arduino,motorized fader,flying fader,pid,controller,midi,control surface">
    <meta name="description" content="Complete C++ implementation for driving up to four motorized faders on an ATmega328P microcontroller, with all kinds of extra features such as capacitive touch sensing for the fader knobs, tuning over the serial port, setpoint changes over I²C, and so on.">
    <title>ATmega328P Code</title>
<style id="MJX-CHTML-styles">
mjx-container[jax="CHTML"] {
  line-height: 0;
}

mjx-container [space="1"] {
  margin-left: .111em;
}

mjx-container [space="2"] {
  margin-left: .167em;
}

mjx-container [space="3"] {
  margin-left: .222em;
}

mjx-container [space="4"] {
  margin-left: .278em;
}

mjx-container [space="5"] {
  margin-left: .333em;
}

mjx-container [rspace="1"] {
  margin-right: .111em;
}

mjx-container [rspace="2"] {
  margin-right: .167em;
}

mjx-container [rspace="3"] {
  margin-right: .222em;
}

mjx-container [rspace="4"] {
  margin-right: .278em;
}

mjx-container [rspace="5"] {
  margin-right: .333em;
}

mjx-container [size="s"] {
  font-size: 70.7%;
}

mjx-container [size="ss"] {
  font-size: 50%;
}

mjx-container [size="Tn"] {
  font-size: 60%;
}

mjx-container [size="sm"] {
  font-size: 85%;
}

mjx-container [size="lg"] {
  font-size: 120%;
}

mjx-container [size="Lg"] {
  font-size: 144%;
}

mjx-container [size="LG"] {
  font-size: 173%;
}

mjx-container [size="hg"] {
  font-size: 207%;
}

mjx-container [size="HG"] {
  font-size: 249%;
}

mjx-container [width="full"] {
  width: 100%;
}

mjx-box {
  display: inline-block;
}

mjx-block {
  display: block;
}

mjx-itable {
  display: inline-table;
}

mjx-row {
  display: table-row;
}

mjx-row > * {
  display: table-cell;
}

mjx-mtext {
  display: inline-block;
}

mjx-mstyle {
  display: inline-block;
}

mjx-merror {
  display: inline-block;
  color: red;
  background-color: yellow;
}

mjx-mphantom {
  visibility: hidden;
}

_::-webkit-full-page-media, _:future, :root mjx-container {
  will-change: opacity;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-math {
  display: inline-block;
  text-align: left;
  line-height: 0;
  text-indent: 0;
  font-style: normal;
  font-weight: normal;
  font-size: 100%;
  font-size-adjust: none;
  letter-spacing: normal;
  word-wrap: normal;
  word-spacing: normal;
  white-space: nowrap;
  direction: ltr;
  padding: 1px 0;
}

mjx-container[jax="CHTML"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="CHTML"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="CHTML"][display="true"] mjx-math {
  padding: 0;
}

mjx-container[jax="CHTML"][justify="left"] {
  text-align: left;
}

mjx-container[jax="CHTML"][justify="right"] {
  text-align: right;
}

mjx-c::before {
  display: block;
  width: 0;
}

.MJX-TEX {
  font-family: MJXZERO, MJXTEX;
}

.TEX-B {
  font-family: MJXZERO, MJXTEX-B;
}

.TEX-I {
  font-family: MJXZERO, MJXTEX-I;
}

.TEX-MI {
  font-family: MJXZERO, MJXTEX-MI;
}

.TEX-BI {
  font-family: MJXZERO, MJXTEX-BI;
}

.TEX-S1 {
  font-family: MJXZERO, MJXTEX-S1;
}

.TEX-S2 {
  font-family: MJXZERO, MJXTEX-S2;
}

.TEX-S3 {
  font-family: MJXZERO, MJXTEX-S3;
}

.TEX-S4 {
  font-family: MJXZERO, MJXTEX-S4;
}

.TEX-A {
  font-family: MJXZERO, MJXTEX-A;
}

.TEX-C {
  font-family: MJXZERO, MJXTEX-C;
}

.TEX-CB {
  font-family: MJXZERO, MJXTEX-CB;
}

.TEX-FR {
  font-family: MJXZERO, MJXTEX-FR;
}

.TEX-FRB {
  font-family: MJXZERO, MJXTEX-FRB;
}

.TEX-SS {
  font-family: MJXZERO, MJXTEX-SS;
}

.TEX-SSB {
  font-family: MJXZERO, MJXTEX-SSB;
}

.TEX-SSI {
  font-family: MJXZERO, MJXTEX-SSI;
}

.TEX-SC {
  font-family: MJXZERO, MJXTEX-SC;
}

.TEX-T {
  font-family: MJXZERO, MJXTEX-T;
}

.TEX-V {
  font-family: MJXZERO, MJXTEX-V;
}

.TEX-VB {
  font-family: MJXZERO, MJXTEX-VB;
}

mjx-stretchy-v mjx-c, mjx-stretchy-h mjx-c {
  font-family: MJXZERO, MJXTEX-S1, MJXTEX-S4, MJXTEX, MJXTEX-A ! important;
}

@font-face /* 0 */ {
  font-family: MJXZERO;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Zero.woff") format("woff");
}

@font-face /* 1 */ {
  font-family: MJXTEX;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff") format("woff");
}

@font-face /* 2 */ {
  font-family: MJXTEX-B;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff") format("woff");
}

@font-face /* 3 */ {
  font-family: MJXTEX-I;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff") format("woff");
}

@font-face /* 4 */ {
  font-family: MJXTEX-MI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff") format("woff");
}

@font-face /* 5 */ {
  font-family: MJXTEX-BI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff") format("woff");
}

@font-face /* 6 */ {
  font-family: MJXTEX-S1;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff") format("woff");
}

@font-face /* 7 */ {
  font-family: MJXTEX-S2;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff") format("woff");
}

@font-face /* 8 */ {
  font-family: MJXTEX-S3;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff") format("woff");
}

@font-face /* 9 */ {
  font-family: MJXTEX-S4;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff") format("woff");
}

@font-face /* 10 */ {
  font-family: MJXTEX-A;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff") format("woff");
}

@font-face /* 11 */ {
  font-family: MJXTEX-C;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff") format("woff");
}

@font-face /* 12 */ {
  font-family: MJXTEX-CB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff") format("woff");
}

@font-face /* 13 */ {
  font-family: MJXTEX-FR;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff") format("woff");
}

@font-face /* 14 */ {
  font-family: MJXTEX-FRB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff") format("woff");
}

@font-face /* 15 */ {
  font-family: MJXTEX-SS;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff") format("woff");
}

@font-face /* 16 */ {
  font-family: MJXTEX-SSB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff") format("woff");
}

@font-face /* 17 */ {
  font-family: MJXTEX-SSI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff") format("woff");
}

@font-face /* 18 */ {
  font-family: MJXTEX-SC;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff") format("woff");
}

@font-face /* 19 */ {
  font-family: MJXTEX-T;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff") format("woff");
}

@font-face /* 20 */ {
  font-family: MJXTEX-V;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff") format("woff");
}

@font-face /* 21 */ {
  font-family: MJXTEX-VB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff") format("woff");
}
</style></head>
<body>
    <nav>
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="position:absolute;top:4px;right: 4px;">
                <path d="M0 0h48v48h-48z" fill="none"></path>
                <path d="M6 36h36v-4h-36v4zm0-10h36v-4h-36v4zm0-14v4h36v-4h-36z"></path>
            </svg>
            <h2><a href="/Pages">Pages</a></h2>
<ul>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/index.html">Raspberry Pi</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/Installation+Setup/index.html">Installation and Setup</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/Installation+Setup/Setting-up-Ubuntu.html">Installing and Setting up Ubuntu</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/Installation+Setup/WiFi-Setup.html">Setting up the WiFi Connection</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/Python-Development/index.html">Python Development</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/index.html">Ubuntu to Raspberry Pi OS Cross C++ Development</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Installation.html">Installation and Setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Development-setup.html">Development setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Building-example-project.html">Building the C++ example project</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Debugging.html">Remote debugging</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/C++-Development-Ubuntu/index.html">Ubuntu to Ubuntu Cross C++ Development</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/C++-Development/index.html">C++ Development using Docker</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Installation.html">Installation and setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Building-The-Toolchain.html">Building the Cross-Compilation Toolchain</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Dependencies.html">Cross-Compiling the Dependencies</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Installing-Dependencies.html">Installing the dependencies on the Pi</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Cpp-Program.html">Cross-Compiling the C++ Example Project</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Debugging.html">Debugging</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Speedrun.html">Speedrun</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/NEON/index.html">NEON</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/NEON/Division.html">Division</a></li>
        </ul>
        </li>
    </ul>
    </li>
    <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../index.html">Arduino</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Audio-and-Signal-Processing/index.html">Audio and Signal Processing</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Audio-and-Signal-Processing/VU-Meters/index.html">VU Meters</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Audio-and-Signal-Processing/VU-Meters/Model.html">Model of a moving-coil galvanometer</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Audio-and-Signal-Processing/VU-Meters/Damped-Harmonic-Oscillator.html">The Damped Harmonic Oscillator</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Control-Surface/index.html">Control Surface</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Control-Surface/Developers/index.html">Developers</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Control-Surface/Developers/Installation.html">Installation</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Control-Surface/Developers/Style.html">Style</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Control-Surface/Developers/Tests.html">Tests</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Control-Surface/Developers/Generating-Documentation.html">Generating Documentation</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../index.html">Control Theory</a>
        <ul>
            <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="index.html">Motorized Faders</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="PID-Controllers.html">PID Controllers</a></li>
                <li><span class="ftriangle"></span><a class="" href="PID-Cpp-Implementation.html">C++ Implementation</a></li>
                <li><span class="ftriangle"></span><a class="" href="PID-Tuning.html">PID Tuning</a></li>
                <li><span class="ftriangle"></span><a class="" href="Architecture.html">Architecture and Design Decisions</a></li>
                <li><span class="ftriangle"></span><a class="" href="Hardware.html">Hardware</a></li>
                <li><span class="ftriangle"></span><a class="openEntry " href="ATmega328P-Code.html">ATmega328P Code</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Bootloaders/index.html">Bootloaders</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../Bootloaders/ATmega328P-custom-frequency.html">Compiling Optiboot - ATmega328P at custom frequency</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../ESP8266/index.html">ESP8266</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../ESP8266/Flashing/index.html">Flashing</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../ESP8266/Flashing/Flashing-With-an-Arduino.html">Flashing the ESP8266 with an Arduino UNO</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/index.html">Mathematics &amp; Engineering</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/index.html">Systems and Control Theory</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Analog-Filters/index.html">Analog Filters &amp; Systems</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Analog-Filters/Butterworth-Filters.html">Butterworth Filters</a></li>
            </ul>
            </li>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/index.html">Digital Filters &amp; Systems</a>
            <ul>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/index.html">DTLTI Systems, Transfer Functions, and the Z-transform</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/DTLTI-Systems.html">DTLTI Systems</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/Impulse-and-Step-Response.html">Impulse and Step Response</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/Convolutions.html">Convolutions</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/The-Z-transform.html">The Z-transform</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/index.html">Exponential Moving Average</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/Exponential-Moving-Average.html">Exponential Moving Average</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/Filtering-in-MATLAB.html">Filtering in MATLAB</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/C++Implementation.html">C++ Implementation</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/index.html">Simple Moving Average</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/Simple-Moving-Average.html">Simple Moving Average</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/C++Implementation.html">C++ Implementation</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/index.html">Discretization</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/Bilinear-transform.html">Bilinear Transform</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/Discretization-of-a-fourth-order-Butterworth-filter.html">Discretization of a Fourth-Order Butterworth Filter</a></li>
                </ul>
                </li>
                <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/FIR-Notch.html">Simple Finite Impulse Response Notch Filter</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Programming/index.html">Programming</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Programming/Cpp/index.html">C++</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Programming/Cpp/Algorithms/index.html">Algorithms</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Programming/Cpp/Algorithms/Max_n_elements.html">Maximum N elements</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Ubuntu/index.html">Ubuntu</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Ubuntu/Software-Installation/index.html">Software Installation</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Ubuntu/Software-Installation/Arduino/index.html">Arduino</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Arduino/Arduino-IDE.html">Arduino IDE</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Arduino/Hairless-MIDI.html">The Hairless MIDI to Serial Bridge</a></li>
            </ul>
            </li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Installing-Locally.html">Installing Locally</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/BlueZ.html">BlueZ with MIDI over BLE Support</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Doxygen.html">Doxygen</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Eclipse.html">Eclipse</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Eigen3.html">Eigen</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/GoogleTest.html">GoogleTest</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Java.html">Java</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Python.html">Python</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/VirtualBox.html">VirtualBox</a></li>
        </ul>
        </li>
    </ul>
    </li>
</ul>

            <i class="material-icons">
                <a href="/" title="Home">home</a>
            </i>
            <i class="material-icons">
                <a href="ATmega328P-Code.pdf" title="Download as PDF">get_app</a>
            </i>
            <!-- <i class="material-icons">
                <a href="javascript:window.print()" title="Print this article" onclick="window.print(); return false;">print</a>
            </i> -->
            <i class="material-icons">
                <a href="https://github.com/tttapa/tttapa.github.io/issues/new" target="_blank" title="Comment or open an issue">feedback</a>
            </i>
        </div>
    </nav>
    <article>
        <h1 class="title">ATmega328P Code</h1>
        <i class="author">Pieter P</i>
        <div class="main-content">

<div style="display: none;">
    <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative" display="true"><mjx-math display="true" style="margin-left: 0; margin-right: 0" class=" MJX-TEX" aria-hidden="true"></mjx-math><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"></math></mjx-assistive-mml></mjx-container>
</div>

<h4 class="snippet-name"><a name="main-cpp" href="#main-cpp">main.cpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments19 .hll { background-color: #ffffcc }
.pygments19 { background: #ffffff; }
.pygments19 .c { color: #008000 } /* Comment */
.pygments19 .err { border: 1px solid #FF0000 } /* Error */
.pygments19 .k { color: #0000ff } /* Keyword */
.pygments19 .l { color: #0000FF } /* Literal */
.pygments19 .ch { color: #008000 } /* Comment.Hashbang */
.pygments19 .cm { color: #008000 } /* Comment.Multiline */
.pygments19 .cp { color: #af00db } /* Comment.Preproc */
.pygments19 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments19 .c1 { color: #008000 } /* Comment.Single */
.pygments19 .cs { color: #008000 } /* Comment.Special */
.pygments19 .ge { font-style: italic } /* Generic.Emph */
.pygments19 .gh { font-weight: bold } /* Generic.Heading */
.pygments19 .gp { font-weight: bold } /* Generic.Prompt */
.pygments19 .gs { font-weight: bold } /* Generic.Strong */
.pygments19 .gu { font-weight: bold } /* Generic.Subheading */
.pygments19 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments19 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments19 .kn { color: #af00db } /* Keyword.Namespace */
.pygments19 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments19 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments19 .kt { color: #2b91af } /* Keyword.Type */
.pygments19 .ld { color: #0000FF } /* Literal.Date */
.pygments19 .m { color: #0000FF } /* Literal.Number */
.pygments19 .s { color: #a31515 } /* Literal.String */
.pygments19 .na { color: #001080 } /* Name.Attribute */
.pygments19 .nb { color: #795e26 } /* Name.Builtin */
.pygments19 .nc { color: #2b91af } /* Name.Class */
.pygments19 .no { color: #0000FF } /* Name.Constant */
.pygments19 .nf { color: #795e26 } /* Name.Function */
.pygments19 .nl { color: #AF00DB } /* Name.Label */
.pygments19 .nn { color: #000000 } /* Name.Namespace */
.pygments19 .nt { color: #800000 } /* Name.Tag */
.pygments19 .nv { color: #0F1E87 } /* Name.Variable */
.pygments19 .ow { color: #0000ff } /* Operator.Word */
.pygments19 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments19 .mf { color: #09885a } /* Literal.Number.Float */
.pygments19 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments19 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments19 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments19 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments19 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments19 .sc { color: #a31515 } /* Literal.String.Char */
.pygments19 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments19 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments19 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments19 .se { color: #a31515 } /* Literal.String.Escape */
.pygments19 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments19 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments19 .sx { color: #a31515 } /* Literal.String.Other */
.pygments19 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments19 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments19 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments19 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments19 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments19 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments19 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments19 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments19 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments19 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments19 pre.snippet19 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/47d8cb6cdc2978d500383387a72d646e62568a16/Motor-Controller/main.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments19"><pre class="lineNumbers snippet19"><code><span></span><span class="c1">// Configuration and initialization of the analog-to-digital converter:</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"ADC.hpp"</span><span class="cp"></span></code>
<code><span class="c1">// Capacitive touch sensing:</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Touch.hpp"</span><span class="cp"></span></code>
<code><span class="c1">// PID controller:</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Controller.hpp"</span><span class="cp"></span></code>
<code><span class="c1">// Configuration of PWM and Timer2/0 for driving the motor:</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Motor.hpp"</span><span class="cp"></span></code>
<code><span class="c1">// Reference signal for testing the performance of the controller:</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Reference.hpp"</span><span class="cp"></span></code>
<code><span class="c1">// Helpers for low-level AVR Timer2/0 and ADC registers:</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Registers.hpp"</span><span class="cp"></span></code>
<code><span class="c1">// Parsing incoming messages over Serial using SLIP packets:</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"SerialSLIP.hpp"</span><span class="cp"></span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span><span class="c1">         // setup, loop, analogRead</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino_Helpers.h&gt;</span><span class="c1"> // EMA.hpp</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Wire.h&gt;</span><span class="c1">            // I²C slave</span><span class="cp"></span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"SMA.hpp"</span><span class="c1">            // SMA filter</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;AH/Filters/EMA.hpp&gt;</span><span class="c1"> // EMA filter</span><span class="cp"></span></code>
<code></code>
<code><span class="c1">// ------------------------------ Description ------------------------------- //</span></code>
<code></code>
<code><span class="c1">// This sketch drives up to four motorized faders using a PID controller. The</span></code>
<code><span class="c1">// motor is disabled when the user touches the knob of the fader.</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// Everything is driven by Timer2, which runs (by default) at a rate of</span></code>
<code><span class="c1">// 31.250 kHz. This high rate is used to eliminate audible tones from the PWM</span></code>
<code><span class="c1">// drive for the motor. Timer0 is used for the PWM outputs of faders 3 and 4.</span></code>
<code><span class="c1">// Every 30 periods of Timer2 (960 µs), each analog input is sampled, and</span></code>
<code><span class="c1">// this causes the PID control loop to run in the main loop function.</span></code>
<code><span class="c1">// Capacitive sensing is implemented by measuring the RC time on the touch pin</span></code>
<code><span class="c1">// in the Timer2 interrupt handler. The “touched” status is sticky for &gt;20 ms</span></code>
<code><span class="c1">// to prevent interference from the 50 Hz mains.</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// There are options to (1) follow a test reference (with ramps and jumps), (2)</span></code>
<code><span class="c1">// to receive a target position over I²C, or (3) to run experiments based on</span></code>
<code><span class="c1">// commands received over the serial port. The latter is used by a Python script</span></code>
<code><span class="c1">// that performs experiments with different tuning parameters for the</span></code>
<code><span class="c1">// controllers.</span></code>
<code></code>
<code><span class="c1">// -------------------------------- Hardware -------------------------------- //</span></code>
<code></code>
<code><span class="c1">// Fader 0:</span></code>
<code><span class="c1">//  - A0:  wiper of the potentiometer          (ADC0)</span></code>
<code><span class="c1">//  - D8:  touch pin of the knob               (PB0)</span></code>
<code><span class="c1">//  - D2:  input 1A of L293D dual H-bridge 1   (PD2)</span></code>
<code><span class="c1">//  - D3:  input 2A of L293D dual H-bridge 1   (OC2B)</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// Fader 1:</span></code>
<code><span class="c1">//  - A1:  wiper of the potentiometer          (ADC1)</span></code>
<code><span class="c1">//  - D9:  touch pin of the knob               (PB1)</span></code>
<code><span class="c1">//  - D13: input 3A of L293D dual H-bridge 1   (PB5)</span></code>
<code><span class="c1">//  - D11: input 4A of L293D dual H-bridge 1   (OC2A)</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// Fader 2:</span></code>
<code><span class="c1">//  - A2:  wiper of the potentiometer          (ADC2)</span></code>
<code><span class="c1">//  - D10: touch pin of the knob               (PB2)</span></code>
<code><span class="c1">//  - D4:  input 1A of L293D dual H-bridge 2   (PD4)</span></code>
<code><span class="c1">//  - D5:  input 2A of L293D dual H-bridge 2   (OC0B)</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// Fader 3:</span></code>
<code><span class="c1">//  - A3:  wiper of the potentiometer          (ADC3)</span></code>
<code><span class="c1">//  - D12: touch pin of the knob               (PB4)</span></code>
<code><span class="c1">//  - D7:  input 3A of L293D dual H-bridge 2   (PD7)</span></code>
<code><span class="c1">//  - D6:  input 4A of L293D dual H-bridge 2   (OC0A)</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// If fader 1 is unused:</span></code>
<code><span class="c1">//  - D13: LED or scope as overrun indicator   (PB5)</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// For communication:</span></code>
<code><span class="c1">//  - D0:  UART TX                             (TXD)</span></code>
<code><span class="c1">//  - D1:  UART RX                             (RXD)</span></code>
<code><span class="c1">//  - A4:  I²C data                            (SDA)</span></code>
<code><span class="c1">//  - A5:  I²C clock                           (SCL)</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// Connect the outer connections of the potentiometers to ground and Vcc, it's</span></code>
<code><span class="c1">// recommended to add a 100 nF capacitor between each wiper and ground.</span></code>
<code><span class="c1">// Connect the 1,2EN and 3,4EN enable pins of the L293D chips to Vcc.</span></code>
<code><span class="c1">// Connect a 500kΩ pull-up resistor between each touch pin and Vcc.</span></code>
<code><span class="c1">// On an Arduino Nano, you can set an option to use pins A6/A7 instead of A2/A3.</span></code>
<code><span class="c1">// Note that D13 is often pulsed by the bootloader, which might cause the fader</span></code>
<code><span class="c1">// to move when resetting the Arduino. You can either disable this behavior in</span></code>
<code><span class="c1">// the bootloader, or use a different pin (e.g. A3 or A4 on an Arduino Nano).</span></code>
<code><span class="c1">// The overrun indicator is only enabled if the number of faders is 1, because</span></code>
<code><span class="c1">// it conflicts with the motor driver pin of Fader 1. You can choose a different</span></code>
<code><span class="c1">// pin instead.</span></code>
<code></code>
<code><span class="c1">// ----------------------------- Configuration ------------------------------ //</span></code>
<code></code>
<code><span class="k">struct</span> <span class="nc">Config</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Print the control loop and interrupt frequencies to Serial at startup:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">print_frequencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Print the setpoint, actual position and control signal to Serial.</span></code>
<code><span class="w">    </span><span class="c1">// Note that this slows down the control loop significantly, it probably</span></code>
<code><span class="w">    </span><span class="c1">// won't work if you are using more than one fader without increasing</span></code>
<code><span class="w">    </span><span class="c1">// `interrupt_divisor`:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">print_controller_signals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">controller_to_print</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Follow the test reference trajectory (true) or receive the target</span></code>
<code><span class="w">    </span><span class="c1">// position over I²C or Serial (false):</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">test_reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Increase this divisor to slow down the test reference:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">test_reference_speed_div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Allow control for tuning and starting experiments over Serial:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">serial_control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// I²C slave address (zero to disable I²C):</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i2c_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Number of faders, must be between 1 and 4:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num_faders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Actually drive the motors:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable_controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Use analog pins (A0, A1, A6, A7) instead of (A0, A1, A2, A3), useful for</span></code>
<code><span class="w">    </span><span class="c1">// saving digital pins on an Arduino Nano:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_A6_A7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Use pin A2 instead of D13 as the motor driver pin for the second fader.</span></code>
<code><span class="w">    </span><span class="c1">// Can only be used if `use_A6_A7` is set to true:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">fader_1_A2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Capacitive touch sensing RC time threshold.</span></code>
<code><span class="w">    </span><span class="c1">// Increase this time constant if the capacitive touch sense is too</span></code>
<code><span class="w">    </span><span class="c1">// sensitive or decrease it if it's not sensitive enough:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">touch_rc_time_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">150e-6</span><span class="p">;</span><span class="w"> </span><span class="c1">// seconds</span></code>
<code><span class="w">    </span><span class="c1">// Bit masks of the touch pins (must be on port B):</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">touch_masks</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PB0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PB1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PB2</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">                                              </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PB4</span><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Use phase-correct PWM (true) or fast PWM (false), this determines the</span></code>
<code><span class="w">    </span><span class="c1">// timer interrupt frequency, prefer phase-correct PWM with prescaler 1 on</span></code>
<code><span class="w">    </span><span class="c1">// 16 MHz boards, and fast PWM with prescaler 1 on 8 MHz boards, both result</span></code>
<code><span class="w">    </span><span class="c1">// in a PWM and interrupt frequency of 31.250 kHz</span></code>
<code><span class="w">    </span><span class="c1">// (fast PWM is twice as fast):</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">phase_correct_pwm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// The fader position will be sampled once per `interrupt_divisor` timer</span></code>
<code><span class="w">    </span><span class="c1">// interrupts, this determines the sampling frequency of the control loop.</span></code>
<code><span class="w">    </span><span class="c1">// Some examples include 20 → 320 µs, 30 → 480 µs, 60 → 960 µs,</span></code>
<code><span class="w">    </span><span class="c1">// 90 → 1,440 µs, 124 → 2,016 µs, 188 → 3,008 µs, 250 → 4,000 µs.</span></code>
<code><span class="w">    </span><span class="c1">// 60 is the default, because it works with four faders. If you only use</span></code>
<code><span class="w">    </span><span class="c1">// a single fader, you can go as low as 20 because you only need a quarter</span></code>
<code><span class="w">    </span><span class="c1">// of the computations and ADC time:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt_divisor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phase_correct_pwm</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// The prescaler for the timer, affects PWM and control loop frequencies:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">prescaler_fac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// The prescaler for the ADC, affects speed of analog readings:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">adc_prescaler_fac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Turn off the motor after this many seconds of inactivity:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// EMA filter factor for fader position filters:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">adc_ema_K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// SMA filter length for setpoint filters, improves tracking of ramps if the</span></code>
<code><span class="w">    </span><span class="c1">// setpoint changes in steps (e.g. when the DAW only updates the reference</span></code>
<code><span class="w">    </span><span class="c1">// every 20 ms). Powers of two are significantly faster (e.g. 32 works well):</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">setpoint_sma_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// ------------------------ Computed Quantities ------------------------- //</span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Sampling time of control loop:</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">prescaler_fac</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">interrupt_divisor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">*</span><span class="w"></span></code>
<code><span class="w">                                </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phase_correct_pwm</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">F_CPU</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Frequency at which the interrupt fires:</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">interrupt_freq</span><span class="w"> </span><span class="o">=</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mf">1.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F_CPU</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">prescaler_fac</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phase_correct_pwm</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Clock speed of the ADC:</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">adc_clock_freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">F_CPU</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">adc_prescaler_fac</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Pulse pin D13 if the control loop took too long:</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable_overrun_indicator</span><span class="w"> </span><span class="o">=</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">num_faders</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">fader_1_A2</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="n">use_A6_A7</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">fader_1_A2</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">                  </span><span class="s">"Cannot use A2 for motor driver "</span><span class="w"></span></code>
<code><span class="w">                  </span><span class="s">"and analog input at the same time"</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">touch_masks</span><span class="p">[];</span><span class="w"></span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">Ts</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ----------------- ADC, Capacitive Touch State and Motors ----------------- //</span></code>
<code></code>
<code><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="w"> </span><span class="n">adc</span><span class="p">;</span><span class="w"></span></code>
<code><span class="n">TouchSense</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="w"> </span><span class="n">touch</span><span class="p">;</span><span class="w"></span></code>
<code><span class="n">Motors</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="w"> </span><span class="n">motors</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ------------------------ Setpoints and References ------------------------ //</span></code>
<code></code>
<code><span class="c1">// Setpoints (target positions) for all faders:</span></code>
<code><span class="n">Reference</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="w"> </span><span class="n">references</span><span class="p">[</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">];</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ------------------------------ Controllers ------------------------------- //</span></code>
<code></code>
<code><span class="c1">// The main PID controllers. Need tuning for your specific setup:</span></code>
<code></code>
<code><span class="n">PID</span><span class="w"> </span><span class="n">controllers</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// This is an example of a controller with very little overshoot</span></code>
<code><span class="w">    </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mi">6</span><span class="p">,</span><span class="w">     </span><span class="c1">// Kp: proportional gain</span></code>
<code><span class="w">        </span><span class="mi">2</span><span class="p">,</span><span class="w">     </span><span class="c1">// Ki: integral gain</span></code>
<code><span class="w">        </span><span class="mf">0.035</span><span class="p">,</span><span class="w"> </span><span class="c1">// Kd: derivative gain</span></code>
<code><span class="w">        </span><span class="n">Ts</span><span class="p">,</span><span class="w">    </span><span class="c1">// Ts: sampling time</span></code>
<code><span class="w">        </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="c1">// fc: cutoff frequency of derivative filter (Hz), zero to disable</span></code>
<code><span class="w">    </span><span class="p">},</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// This one has more overshoot, but less ramp tracking error</span></code>
<code><span class="w">    </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mi">4</span><span class="p">,</span><span class="w">     </span><span class="c1">// Kp: proportional gain</span></code>
<code><span class="w">        </span><span class="mi">11</span><span class="p">,</span><span class="w">    </span><span class="c1">// Ki: integral gain</span></code>
<code><span class="w">        </span><span class="mf">0.028</span><span class="p">,</span><span class="w"> </span><span class="c1">// Kd: derivative gain</span></code>
<code><span class="w">        </span><span class="n">Ts</span><span class="p">,</span><span class="w">    </span><span class="c1">// Ts: sampling time</span></code>
<code><span class="w">        </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="c1">// fc: cutoff frequency of derivative filter (Hz), zero to disable</span></code>
<code><span class="w">    </span><span class="p">},</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// This is a very aggressive controller</span></code>
<code><span class="w">    </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mf">8.55</span><span class="p">,</span><span class="w">  </span><span class="c1">// Kp: proportional gain</span></code>
<code><span class="w">        </span><span class="mi">440</span><span class="p">,</span><span class="w">   </span><span class="c1">// Ki: integral gain</span></code>
<code><span class="w">        </span><span class="mf">0.043</span><span class="p">,</span><span class="w"> </span><span class="c1">// Kd: derivative gain</span></code>
<code><span class="w">        </span><span class="n">Ts</span><span class="p">,</span><span class="w">    </span><span class="c1">// Ts: sampling time</span></code>
<code><span class="w">        </span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="c1">// fc: cutoff frequency of derivative filter (Hz), zero to disable</span></code>
<code><span class="w">    </span><span class="p">},</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Fourth controller</span></code>
<code><span class="w">    </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mi">6</span><span class="p">,</span><span class="w">     </span><span class="c1">// Kp: proportional gain</span></code>
<code><span class="w">        </span><span class="mi">2</span><span class="p">,</span><span class="w">     </span><span class="c1">// Ki: integral gain</span></code>
<code><span class="w">        </span><span class="mf">0.035</span><span class="p">,</span><span class="w"> </span><span class="c1">// Kd: derivative gain</span></code>
<code><span class="w">        </span><span class="n">Ts</span><span class="p">,</span><span class="w">    </span><span class="c1">// Ts: sampling time</span></code>
<code><span class="w">        </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="c1">// fc: cutoff frequency of derivative filter (Hz), zero to disable</span></code>
<code><span class="w">    </span><span class="p">},</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">printControllerSignals</span><span class="p">(</span><span class="kt">int16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">adcval</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">control</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Send (binary) controller signals over Serial to plot in Python</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">serial_control</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">references</span><span class="p">[</span><span class="n">Idx</span><span class="p">].</span><span class="n">experimentInProgress</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="n">setpoint</span><span class="p">,</span><span class="w"> </span><span class="n">adcval</span><span class="p">,</span><span class="w"> </span><span class="n">control</span><span class="p">};</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">SLIPSender</span><span class="p">(</span><span class="n">Serial</span><span class="p">).</span><span class="n">writePacket</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="w"></span></code>
<code><span class="w">                                       </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Print signals as text</span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">print_controller_signals</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span></code>
<code><span class="w">             </span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">controller_to_print</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">setpoint</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">'\t'</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">adcval</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">'\t'</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">((</span><span class="n">control</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">updateController</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">adcval</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">touched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controllers</span><span class="p">[</span><span class="n">Idx</span><span class="p">];</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Prevent the motor from being turned off after being touched</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">touched</span><span class="p">)</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="n">resetActivityCounter</span><span class="p">();</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Set the target position</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">setpoint_sma_length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">SMA</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">::</span><span class="n">setpoint_sma_length</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sma</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">filtsetpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sma</span><span class="p">(</span><span class="n">setpoint</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">controller</span><span class="p">.</span><span class="n">setSetpoint</span><span class="p">(</span><span class="n">filtsetpoint</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">controller</span><span class="p">.</span><span class="n">setSetpoint</span><span class="p">(</span><span class="n">setpoint</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Update the PID controller to get the control action</span></code>
<code><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">adcval</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Apply the control action to the motor</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">enable_controller</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">touched</span><span class="p">)</span><span class="w"> </span><span class="c1">// Turn off motor if knob is touched</span></code>
<code><span class="w">            </span><span class="n">motors</span><span class="p">.</span><span class="n">setSpeed</span><span class="o">&lt;</span><span class="n">Idx</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">motors</span><span class="p">.</span><span class="n">setSpeed</span><span class="o">&lt;</span><span class="n">Idx</span><span class="o">&gt;</span><span class="p">(</span><span class="n">control</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="n">printControllerSignals</span><span class="o">&lt;</span><span class="n">Idx</span><span class="o">&gt;</span><span class="p">(</span><span class="n">controller</span><span class="p">.</span><span class="n">getSetpoint</span><span class="p">(),</span><span class="w"> </span><span class="n">adcval</span><span class="p">,</span><span class="w"> </span><span class="n">control</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">readAndUpdateController</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Read the ADC value for the given fader:</span></code>
<code><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">adcval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adc</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">Idx</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// If the ADC value was updated by the ADC interrupt, run the control loop:</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">adcval</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// Check if the fader knob is touched</span></code>
<code><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">touched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">touch</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">Idx</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// Read the target position</span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">references</span><span class="p">[</span><span class="n">Idx</span><span class="p">].</span><span class="n">getNextSetpoint</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// Run the control loop</span></code>
<code><span class="w">        </span><span class="n">updateController</span><span class="o">&lt;</span><span class="n">Idx</span><span class="o">&gt;</span><span class="p">(</span><span class="n">setpoint</span><span class="p">,</span><span class="w"> </span><span class="n">adcval</span><span class="p">,</span><span class="w"> </span><span class="n">touched</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// Write -1 so the controller doesn't run again until the next value is</span></code>
<code><span class="w">        </span><span class="c1">// available:</span></code>
<code><span class="w">        </span><span class="n">adc</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">Idx</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">enable_overrun_indicator</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">PORTB</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// Clear overrun indicator</span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ------------------------------ Setup &amp; Loop ------------------------------ //</span></code>
<code></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">onRequest</span><span class="p">();</span><span class="w"></span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="nf">onReceive</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span><span class="w"></span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="nf">updateSerialIn</span><span class="p">();</span><span class="w"></span></code>
<code></code>
<code><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Initialize some globals</span></code>
<code><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// all fader positions for the control loop start of as -1 (no reading)</span></code>
<code><span class="w">        </span><span class="n">adc</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// reset the filter to the current fader position to prevent transients</span></code>
<code><span class="w">        </span><span class="n">adc</span><span class="p">.</span><span class="n">writeFiltered</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">analogRead</span><span class="p">(</span><span class="n">adc</span><span class="p">.</span><span class="n">channel_index_to_mux_address</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// after how many seconds of not touching the fader and not changing</span></code>
<code><span class="w">        </span><span class="c1">// the reference do we turn off the motor?</span></code>
<code><span class="w">        </span><span class="n">controllers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setActivityTimeout</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">timeout</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Configure the hardware</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">print_frequencies</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">print_controller_signals</span><span class="w"> </span><span class="o">||</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Config</span><span class="o">::</span><span class="n">serial_control</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">enable_overrun_indicator</span><span class="p">)</span><span class="w"> </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRB</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// Pin 13 output</span></code>
<code></code>
<code><span class="w">    </span><span class="n">adc</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">touch</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">motors</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">print_frequencies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"Interrupt frequency (Hz): "</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_freq</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"Controller sampling time (µs): "</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">Ts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"ADC clock rate (Hz): "</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">adc_clock_freq</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"ADC sampling rate (Sps): "</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">adc</span><span class="p">.</span><span class="n">adc_rate</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">print_controller_signals</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"Reference</span><span class="se">\t</span><span class="s">Actual</span><span class="se">\t</span><span class="s">Control</span><span class="se">\t</span><span class="s">-"</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"0</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0</span><span class="se">\r\n</span><span class="s">0</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">1024"</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Initalize I²C slave and attach callbacks</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">i2c_address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Wire</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">i2c_address</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Wire</span><span class="p">.</span><span class="n">onRequest</span><span class="p">(</span><span class="n">onRequest</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Wire</span><span class="p">.</span><span class="n">onReceive</span><span class="p">(</span><span class="n">onReceive</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Enable Timer2 overflow interrupt, this starts reading the touch sensitive</span></code>
<code><span class="w">    </span><span class="c1">// knobs and sampling the ADC, which causes the controllers to run in the</span></code>
<code><span class="w">    </span><span class="c1">// main loop</span></code>
<code><span class="w">    </span><span class="n">sbi</span><span class="p">(</span><span class="n">TIMSK2</span><span class="p">,</span><span class="w"> </span><span class="n">TOIE2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">readAndUpdateController</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">readAndUpdateController</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">readAndUpdateController</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">readAndUpdateController</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">serial_control</span><span class="p">)</span><span class="w"> </span><span class="n">updateSerialIn</span><span class="p">();</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ------------------------------- Interrupts ------------------------------- //</span></code>
<code></code>
<code><span class="c1">// Fires at a constant rate of `interrupt_freq`.</span></code>
<code><span class="n">ISR</span><span class="p">(</span><span class="n">TIMER2_OVF_vect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// We don't have to take all actions at each interupt, so keep a counter to</span></code>
<code><span class="w">    </span><span class="c1">// know when to take what actions.</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="n">adc</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">touch</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="o">++</span><span class="n">counter</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_divisor</span><span class="p">)</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// Fires when the ADC measurement is complete. Stores the reading, both before</span></code>
<code><span class="c1">// and after filtering (for the controller and for user input respectively).</span></code>
<code><span class="n">ISR</span><span class="p">(</span><span class="n">ADC_vect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">adc</span><span class="p">.</span><span class="n">complete</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ---------------------------------- Wire ---------------------------------- //</span></code>
<code></code>
<code><span class="c1">// Send the touch status and filtered fader positions to the master.</span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">onRequest</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">touched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">touched</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">touch</span><span class="p">.</span><span class="n">touched</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">touched</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">filt_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adc</span><span class="p">.</span><span class="n">filtered_readings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Wire</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filt_read</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// Change the setpoint of the given fader based on the value in the message</span></code>
<code><span class="c1">// received from the master.</span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">onReceive</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Wire</span><span class="p">.</span><span class="n">available</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wire</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="kt">uint16_t</span><span class="p">(</span><span class="n">Wire</span><span class="p">.</span><span class="n">read</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x03FF</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">)</span><span class="w"> </span><span class="n">references</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">setMasterSetpoint</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ---------------------------------- Serial -------------------------------- //</span></code>
<code></code>
<code><span class="c1">// Read SLIP messages from the serial port that allow dynamically updating the</span></code>
<code><span class="c1">// tuning of the controllers. This is used by the Python tuning script.</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// Message format: &lt;command&gt; &lt;fader&gt; &lt;value&gt;</span></code>
<code><span class="c1">// Commands:</span></code>
<code><span class="c1">//   - p: proportional gain Kp</span></code>
<code><span class="c1">//   - i: integral gain Ki</span></code>
<code><span class="c1">//   - d: derivative gain Kd</span></code>
<code><span class="c1">//   - c: derivative filter cutoff frequency f_c (Hz)</span></code>
<code><span class="c1">//   - m: maximum absolute control output</span></code>
<code><span class="c1">//   - s: start an experiment, using getNextExperimentSetpoint</span></code>
<code><span class="c1">// Fader index: up to four faders are addressed using the characters '0' - '3'.</span></code>
<code><span class="c1">// Values: values are sent as 32-bit little Endian floating point numbers.</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// For example the message 'c0\x00\x00\x20\x42' sets the derivative filter</span></code>
<code><span class="c1">// cutoff frequency of the first fader to 40.</span></code>
<code></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">updateSerialIn</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">SLIPParser</span><span class="w"> </span><span class="n">parser</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">'\0'</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">fader_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="s">""</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// This function is called if a new byte of the message arrives:</span></code>
<code><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">on_char_receive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="kt">char</span><span class="w"> </span><span class="n">new_byte</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">index_in_packet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index_in_packet</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_byte</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index_in_packet</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">fader_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_byte</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="sc">'0'</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index_in_packet</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">buf</span><span class="p">[</span><span class="n">index_in_packet</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_byte</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">};</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Convert the 4-byte buffer to a float:</span></code>
<code><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">as_f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">};</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Read and parse incoming packets from Serial:</span></code>
<code><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">msg_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">on_char_receive</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// If a complete message of 6 bytes was received, and if it addresses</span></code>
<code><span class="w">        </span><span class="c1">// a valid fader:</span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fader_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="c1">// Execute the command:</span></code>
<code><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="sc">'p'</span><span class="o">:</span><span class="w"> </span><span class="n">controllers</span><span class="p">[</span><span class="n">fader_idx</span><span class="p">].</span><span class="n">setKp</span><span class="p">(</span><span class="n">as_f32</span><span class="p">());</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="sc">'i'</span><span class="o">:</span><span class="w"> </span><span class="n">controllers</span><span class="p">[</span><span class="n">fader_idx</span><span class="p">].</span><span class="n">setKi</span><span class="p">(</span><span class="n">as_f32</span><span class="p">());</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="sc">'d'</span><span class="o">:</span><span class="w"> </span><span class="n">controllers</span><span class="p">[</span><span class="n">fader_idx</span><span class="p">].</span><span class="n">setKd</span><span class="p">(</span><span class="n">as_f32</span><span class="p">());</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="sc">'c'</span><span class="o">:</span><span class="w"> </span><span class="n">controllers</span><span class="p">[</span><span class="n">fader_idx</span><span class="p">].</span><span class="n">setEMACutoff</span><span class="p">(</span><span class="n">as_f32</span><span class="p">());</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="sc">'m'</span><span class="o">:</span><span class="w"> </span><span class="n">controllers</span><span class="p">[</span><span class="n">fader_idx</span><span class="p">].</span><span class="n">setMaxOutput</span><span class="p">(</span><span class="n">as_f32</span><span class="p">());</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="sc">'s'</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">                    </span><span class="n">references</span><span class="p">[</span><span class="n">fader_idx</span><span class="p">].</span><span class="n">startExperiment</span><span class="p">(</span><span class="n">as_f32</span><span class="p">());</span><span class="w"></span></code>
<code><span class="w">                    </span><span class="n">controllers</span><span class="p">[</span><span class="n">fader_idx</span><span class="p">].</span><span class="n">resetIntegral</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="adc-hpp" href="#adc-hpp">ADC.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments23 .hll { background-color: #ffffcc }
.pygments23 { background: #ffffff; }
.pygments23 .c { color: #008000 } /* Comment */
.pygments23 .err { border: 1px solid #FF0000 } /* Error */
.pygments23 .k { color: #0000ff } /* Keyword */
.pygments23 .l { color: #0000FF } /* Literal */
.pygments23 .ch { color: #008000 } /* Comment.Hashbang */
.pygments23 .cm { color: #008000 } /* Comment.Multiline */
.pygments23 .cp { color: #af00db } /* Comment.Preproc */
.pygments23 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments23 .c1 { color: #008000 } /* Comment.Single */
.pygments23 .cs { color: #008000 } /* Comment.Special */
.pygments23 .ge { font-style: italic } /* Generic.Emph */
.pygments23 .gh { font-weight: bold } /* Generic.Heading */
.pygments23 .gp { font-weight: bold } /* Generic.Prompt */
.pygments23 .gs { font-weight: bold } /* Generic.Strong */
.pygments23 .gu { font-weight: bold } /* Generic.Subheading */
.pygments23 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments23 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments23 .kn { color: #af00db } /* Keyword.Namespace */
.pygments23 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments23 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments23 .kt { color: #2b91af } /* Keyword.Type */
.pygments23 .ld { color: #0000FF } /* Literal.Date */
.pygments23 .m { color: #0000FF } /* Literal.Number */
.pygments23 .s { color: #a31515 } /* Literal.String */
.pygments23 .na { color: #001080 } /* Name.Attribute */
.pygments23 .nb { color: #795e26 } /* Name.Builtin */
.pygments23 .nc { color: #2b91af } /* Name.Class */
.pygments23 .no { color: #0000FF } /* Name.Constant */
.pygments23 .nf { color: #795e26 } /* Name.Function */
.pygments23 .nl { color: #AF00DB } /* Name.Label */
.pygments23 .nn { color: #000000 } /* Name.Namespace */
.pygments23 .nt { color: #800000 } /* Name.Tag */
.pygments23 .nv { color: #0F1E87 } /* Name.Variable */
.pygments23 .ow { color: #0000ff } /* Operator.Word */
.pygments23 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments23 .mf { color: #09885a } /* Literal.Number.Float */
.pygments23 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments23 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments23 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments23 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments23 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments23 .sc { color: #a31515 } /* Literal.String.Char */
.pygments23 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments23 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments23 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments23 .se { color: #a31515 } /* Literal.String.Escape */
.pygments23 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments23 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments23 .sx { color: #a31515 } /* Literal.String.Other */
.pygments23 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments23 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments23 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments23 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments23 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments23 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments23 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments23 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments23 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments23 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments23 pre.snippet23 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/47d8cb6cdc2978d500383387a72d646e62568a16/Motor-Controller/ADC.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments23"><pre class="lineNumbers snippet23"><code><span></span><span class="cp">#pragma once</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Registers.hpp"</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avr/interrupt.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;util/atomic.h&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino_Helpers.h&gt;</span><span class="c1"> // EMA.hpp</span><span class="cp"></span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;AH/Filters/EMA.hpp&gt;</span><span class="c1"> // EMA filter</span><span class="cp"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">struct</span> <span class="nc">ADCManager</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Evenly distribute the analog readings in the control loop period.</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">adc_start_count</span><span class="w"> </span><span class="o">=</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_divisor</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// The rate at which we're sampling using the ADC.</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">adc_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_freq</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">adc_start_count</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Check that this doesn't take more time than the 13 ADC clock cycles it</span></code>
<code><span class="w">    </span><span class="c1">// takes to actually do the conversion. Use 14 instead of 13 just to be safe.</span></code>
<code><span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="n">adc_rate</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">adc_clock_freq</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s">"ADC too slow"</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Enable the ADC with Vcc reference, with the given prescaler, auto</span></code>
<code><span class="w">    </span><span class="c1">/// trigger disabled, ADC interrupt enabled.</span></code>
<code><span class="w">    </span><span class="c1">/// Called from main program, with interrupts enabled.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">begin</span><span class="p">();</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Start an ADC conversion on the given channel.</span></code>
<code><span class="w">    </span><span class="c1">/// Called inside an ISR.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">startConversion</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Start an ADC conversion at the right intervals.</span></code>
<code><span class="w">    </span><span class="c1">/// @param  counter</span></code>
<code><span class="w">    </span><span class="c1">///         Counter that keeps track of how many times the timer interrupt</span></code>
<code><span class="w">    </span><span class="c1">///         fired, between 0 and Config::interrupt_divisor - 1.</span></code>
<code><span class="w">    </span><span class="c1">/// Called inside an ISR.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">counter</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Read the latest ADC result.</span></code>
<code><span class="w">    </span><span class="c1">/// Called inside an ISR.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">complete</span><span class="p">();</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Get the latest ADC reading for the given index.</span></code>
<code><span class="w">    </span><span class="c1">/// Called from main program, with interrupts enabled.</span></code>
<code><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Get the latest filtered ADC reading for the given index.</span></code>
<code><span class="w">    </span><span class="c1">/// Called from main program, with interrupts enabled.</span></code>
<code><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="nf">readFiltered</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Write the ADC reading for the given index.</span></code>
<code><span class="w">    </span><span class="c1">/// Called from main program, with interrupts enabled.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Write the filtered ADC reading for the given index.</span></code>
<code><span class="w">    </span><span class="c1">/// Called only before ADC interrupts are enabled.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeFiltered</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Convert the channel index between 0 and Config::num_faders - 1 to the</span></code>
<code><span class="w">    </span><span class="c1">/// actual ADC multiplexer address.</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"></span></code>
<code><span class="w">    </span><span class="nf">channel_index_to_mux_address</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">adc_mux_idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">use_A6_A7</span><span class="w"></span></code>
<code><span class="w">                   </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">adc_mux_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nl">adc_mux_idx</span> <span class="p">:</span><span class="w"> </span><span class="n">adc_mux_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">                   </span><span class="o">:</span><span class="w"> </span><span class="n">adc_mux_idx</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Index of the ADC channel currently being read.</span></code>
<code><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">channel_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Latest ADC reading of each fader (updated in ADC ISR). Used for the</span></code>
<code><span class="w">    </span><span class="c1">/// control loop.</span></code>
<code><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">readings</span><span class="p">[</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">];</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Filters for ADC readings.</span></code>
<code><span class="w">    </span><span class="n">EMA</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">::</span><span class="n">adc_ema_K</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filters</span><span class="p">[</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">];</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Filtered ADC readings. Used to output over MIDI.</span></code>
<code><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">filtered_readings</span><span class="p">[</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">];</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factorToADCPrescaler</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">adc_prescaler_fac</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="n">prescaler</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">,</span><span class="w"> </span><span class="s">"Invalid prescaler"</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_FORCEON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">cbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADEN</span><span class="p">);</span><span class="w"> </span><span class="c1">// Disable ADC</span></code>
<code></code>
<code><span class="w">        </span><span class="n">cbi</span><span class="p">(</span><span class="n">ADMUX</span><span class="p">,</span><span class="w"> </span><span class="n">REFS1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Vcc reference</span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">ADMUX</span><span class="p">,</span><span class="w"> </span><span class="n">REFS0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Vcc reference</span></code>
<code></code>
<code><span class="w">        </span><span class="n">cbi</span><span class="p">(</span><span class="n">ADMUX</span><span class="p">,</span><span class="w"> </span><span class="n">ADLAR</span><span class="p">);</span><span class="w"> </span><span class="c1">// 8 least significant bits in ADCL</span></code>
<code></code>
<code><span class="w">        </span><span class="n">setADCPrescaler</span><span class="p">(</span><span class="n">prescaler</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="n">cbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADATE</span><span class="p">);</span><span class="w"> </span><span class="c1">// Auto trigger disable</span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADIE</span><span class="p">);</span><span class="w">  </span><span class="c1">// ADC Interrupt Enable</span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADEN</span><span class="p">);</span><span class="w">  </span><span class="c1">// Enable ADC</span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">update</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">adc_start_count</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">startConversion</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">adc_start_count</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">startConversion</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">adc_start_count</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">startConversion</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">adc_start_count</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">startConversion</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">startConversion</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">channel_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ADMUX</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0xF0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ADMUX</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">channel_index_to_mux_address</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">sbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADSC</span><span class="p">);</span><span class="w"> </span><span class="c1">// ADC Start Conversion</span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">complete</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">enable_overrun_indicator</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">readings</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">PORTB</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w">    </span><span class="c1">// Set overrun indicator</span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ADC</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store ADC reading</span></code>
<code><span class="w">    </span><span class="n">readings</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Filter the reading</span></code>
<code><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filters</span><span class="p">[</span><span class="n">channel_index</span><span class="p">];</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">filtered_readings</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">adc_ema_K</span><span class="p">));</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">read</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_FORCEON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readings</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">write</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_FORCEON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">readings</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">readFiltered</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_FORCEON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filtered_readings</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">ADCManager</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">writeFiltered</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">filters</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">reset</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">filtered_readings</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="touch-hpp" href="#touch-hpp">Touch.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments27 .hll { background-color: #ffffcc }
.pygments27 { background: #ffffff; }
.pygments27 .c { color: #008000 } /* Comment */
.pygments27 .err { border: 1px solid #FF0000 } /* Error */
.pygments27 .k { color: #0000ff } /* Keyword */
.pygments27 .l { color: #0000FF } /* Literal */
.pygments27 .ch { color: #008000 } /* Comment.Hashbang */
.pygments27 .cm { color: #008000 } /* Comment.Multiline */
.pygments27 .cp { color: #af00db } /* Comment.Preproc */
.pygments27 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments27 .c1 { color: #008000 } /* Comment.Single */
.pygments27 .cs { color: #008000 } /* Comment.Special */
.pygments27 .ge { font-style: italic } /* Generic.Emph */
.pygments27 .gh { font-weight: bold } /* Generic.Heading */
.pygments27 .gp { font-weight: bold } /* Generic.Prompt */
.pygments27 .gs { font-weight: bold } /* Generic.Strong */
.pygments27 .gu { font-weight: bold } /* Generic.Subheading */
.pygments27 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments27 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments27 .kn { color: #af00db } /* Keyword.Namespace */
.pygments27 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments27 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments27 .kt { color: #2b91af } /* Keyword.Type */
.pygments27 .ld { color: #0000FF } /* Literal.Date */
.pygments27 .m { color: #0000FF } /* Literal.Number */
.pygments27 .s { color: #a31515 } /* Literal.String */
.pygments27 .na { color: #001080 } /* Name.Attribute */
.pygments27 .nb { color: #795e26 } /* Name.Builtin */
.pygments27 .nc { color: #2b91af } /* Name.Class */
.pygments27 .no { color: #0000FF } /* Name.Constant */
.pygments27 .nf { color: #795e26 } /* Name.Function */
.pygments27 .nl { color: #AF00DB } /* Name.Label */
.pygments27 .nn { color: #000000 } /* Name.Namespace */
.pygments27 .nt { color: #800000 } /* Name.Tag */
.pygments27 .nv { color: #0F1E87 } /* Name.Variable */
.pygments27 .ow { color: #0000ff } /* Operator.Word */
.pygments27 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments27 .mf { color: #09885a } /* Literal.Number.Float */
.pygments27 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments27 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments27 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments27 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments27 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments27 .sc { color: #a31515 } /* Literal.String.Char */
.pygments27 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments27 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments27 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments27 .se { color: #a31515 } /* Literal.String.Escape */
.pygments27 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments27 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments27 .sx { color: #a31515 } /* Literal.String.Other */
.pygments27 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments27 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments27 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments27 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments27 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments27 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments27 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments27 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments27 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments27 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments27 pre.snippet27 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/47d8cb6cdc2978d500383387a72d646e62568a16/Motor-Controller/Touch.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments27"><pre class="lineNumbers snippet27"><code><span></span><span class="cp">#pragma once</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avr/interrupt.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avr/io.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;util/atomic.h&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">struct</span> <span class="nc">TouchSense</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// The actual threshold as a number of interrupts instead of seconds:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">touch_sense_thres</span><span class="w"> </span><span class="o">=</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_freq</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">touch_rc_time_threshold</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Ignore mains noise by making the “touched” status stick for longer than</span></code>
<code><span class="w">    </span><span class="c1">/// the mains period:</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">period_50Hz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Keep the “touched” status active for this many periods (see below):</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">touch_sense_stickiness</span><span class="w"> </span><span class="o">=</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_freq</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">period_50Hz</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_divisor</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Check that the threshold is smaller than the control loop period:</span></code>
<code><span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="n">touch_sense_thres</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">interrupt_divisor</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">                  </span><span class="s">"Touch sense threshold too high"</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// The combined bit mask for all touch GPIO pins.</span></code>
<code><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">gpio_mask</span><span class="w"> </span><span class="o">=</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">touch_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">touch_masks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">touch_masks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">touch_masks</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Initialize the GPIO pins for capacitive sensing.</span></code>
<code><span class="w">    </span><span class="c1">/// Called from main program, with interrupts enabled.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">begin</span><span class="p">();</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Check which touch sensing knobs are being touched.</span></code>
<code><span class="w">    </span><span class="c1">/// @param  counter</span></code>
<code><span class="w">    </span><span class="c1">///         Counter that keeps track of how many times the timer interrupt</span></code>
<code><span class="w">    </span><span class="c1">///         fired, between 0 and Config::interrupt_divisor - 1.</span></code>
<code><span class="w">    </span><span class="c1">/// Called inside an ISR.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">counter</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Get the touch status for the given index.</span></code>
<code><span class="w">    </span><span class="c1">/// Called from main program, with interrupts enabled.</span></code>
<code><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Timers to take into account the stickiness.</span></code>
<code><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">touch_timers</span><span class="p">[</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">]</span><span class="w"> </span><span class="p">{};</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Whether the knobs are being touched.</span></code>
<code><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">touched</span><span class="p">[</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">];</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">TouchSense</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_FORCEON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">PORTB</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio_mask</span><span class="p">;</span><span class="w"> </span><span class="c1">// low</span></code>
<code><span class="w">        </span><span class="n">DDRB</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio_mask</span><span class="p">;</span><span class="w">   </span><span class="c1">// output mode</span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// 0. The pin mode is “output”, the value is “low”.</span></code>
<code><span class="c1">// 1. Set the pin mode to “input”, touch_timer = 0.</span></code>
<code><span class="c1">// 2. The pin will start charging through the external pull-up resistor.</span></code>
<code><span class="c1">// 3. After a fixed amount of time, check whether the pin became “high”:</span></code>
<code><span class="c1">//    if this is the case, the RC-time of the knob/pull-up resistor circuit</span></code>
<code><span class="c1">//    was smaller than the given threshold. Since R is fixed, this can be used</span></code>
<code><span class="c1">//    to infer C, the capacitance of the knob: if the capacitance is lower than</span></code>
<code><span class="c1">//    the threshold (i.e. RC-time is lower), this means the knob was not touched.</span></code>
<code><span class="c1">// 5. Set the pin mode to “output”, to start discharging the pin to 0V again.</span></code>
<code><span class="c1">// 6. Some time later, the pin has discharged, so switch to “input” mode and</span></code>
<code><span class="c1">//    start charging again for the next RC-time measurement.</span></code>
<code><span class="c1">//</span></code>
<code><span class="c1">// The “touched” status is sticky: it will remain set for at least</span></code>
<code><span class="c1">// touch_sense_stickiness ticks. If the pin never resulted in another “touched”</span></code>
<code><span class="c1">// measurement during that period, the “touched” status for that pin is cleared.</span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kt">void</span><span class="w"> </span><span class="n">TouchSense</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">update</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">counter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">DDRB</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio_mask</span><span class="p">;</span><span class="w"> </span><span class="c1">// input mode, start charging</span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">touch_sense_thres</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">touched_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PINB</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">DDRB</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio_mask</span><span class="p">;</span><span class="w"> </span><span class="c1">// output mode, start discharging</span></code>
<code><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">touch_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">touched_bits</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">touch_masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">touch_i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">touch_timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">touch_sense_stickiness</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">touched</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">touch_timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                </span><span class="o">--</span><span class="n">touch_timers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">touch_timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">touched</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kt">bool</span><span class="w"> </span><span class="n">TouchSense</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">read</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_FORCEON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">touched</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="controller-hpp" href="#controller-hpp">Controller.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments31 .hll { background-color: #ffffcc }
.pygments31 { background: #ffffff; }
.pygments31 .c { color: #008000 } /* Comment */
.pygments31 .err { border: 1px solid #FF0000 } /* Error */
.pygments31 .k { color: #0000ff } /* Keyword */
.pygments31 .l { color: #0000FF } /* Literal */
.pygments31 .ch { color: #008000 } /* Comment.Hashbang */
.pygments31 .cm { color: #008000 } /* Comment.Multiline */
.pygments31 .cp { color: #af00db } /* Comment.Preproc */
.pygments31 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments31 .c1 { color: #008000 } /* Comment.Single */
.pygments31 .cs { color: #008000 } /* Comment.Special */
.pygments31 .ge { font-style: italic } /* Generic.Emph */
.pygments31 .gh { font-weight: bold } /* Generic.Heading */
.pygments31 .gp { font-weight: bold } /* Generic.Prompt */
.pygments31 .gs { font-weight: bold } /* Generic.Strong */
.pygments31 .gu { font-weight: bold } /* Generic.Subheading */
.pygments31 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments31 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments31 .kn { color: #af00db } /* Keyword.Namespace */
.pygments31 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments31 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments31 .kt { color: #2b91af } /* Keyword.Type */
.pygments31 .ld { color: #0000FF } /* Literal.Date */
.pygments31 .m { color: #0000FF } /* Literal.Number */
.pygments31 .s { color: #a31515 } /* Literal.String */
.pygments31 .na { color: #001080 } /* Name.Attribute */
.pygments31 .nb { color: #795e26 } /* Name.Builtin */
.pygments31 .nc { color: #2b91af } /* Name.Class */
.pygments31 .no { color: #0000FF } /* Name.Constant */
.pygments31 .nf { color: #795e26 } /* Name.Function */
.pygments31 .nl { color: #AF00DB } /* Name.Label */
.pygments31 .nn { color: #000000 } /* Name.Namespace */
.pygments31 .nt { color: #800000 } /* Name.Tag */
.pygments31 .nv { color: #0F1E87 } /* Name.Variable */
.pygments31 .ow { color: #0000ff } /* Operator.Word */
.pygments31 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments31 .mf { color: #09885a } /* Literal.Number.Float */
.pygments31 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments31 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments31 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments31 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments31 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments31 .sc { color: #a31515 } /* Literal.String.Char */
.pygments31 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments31 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments31 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments31 .se { color: #a31515 } /* Literal.String.Escape */
.pygments31 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments31 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments31 .sx { color: #a31515 } /* Literal.String.Other */
.pygments31 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments31 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments31 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments31 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments31 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments31 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments31 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments31 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments31 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments31 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments31 pre.snippet31 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/661955c845f21c097258cf0082112123454a6b01/Motor-Controller/Controller.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments31"><pre class="lineNumbers snippet31"><code><span></span><span class="cp">#pragma once</span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stddef.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="c1">/// @see @ref horner(float,float,const float(&amp;)[N])</span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">horner_impl</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">xa</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">                                   </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nl">t</span></code>
<code>                      <span class="p">:</span><span class="w"> </span><span class="n">horner_impl</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Evaluate a polynomial using</span></code>
<code><span class="c1">/// [Horner's method](https://en.wikipedia.org/wiki/Horner%27s_method).</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">size_t</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">horner</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">)[</span><span class="n">N</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">horner_impl</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Compute the weight factor of a exponential moving average filter</span></code>
<code><span class="c1">/// with the given cutoff frequency.</span></code>
<code><span class="c1">/// @see https://tttapa.github.io/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential%20Moving%20Average/Exponential-Moving-Average.html#cutoff-frequency</span></code>
<code><span class="c1">///      for the formula.</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">calcAlphaEMA</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">f_n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Taylor coefficients of</span></code>
<code><span class="w">    </span><span class="c1">// α(fₙ) = cos(2πfₙ) - 1 + √( cos(2πfₙ)² - 4 cos(2πfₙ) + 3 )</span></code>
<code><span class="w">    </span><span class="c1">// at fₙ = 0.25</span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">coeff</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="o">+</span><span class="mf">7.3205080756887730e-01</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">9.7201214975728490e-01</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mf">-3.7988125051760377e+00</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">9.5168450173968860e+00</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mf">-2.0829320344443730e+01</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mf">3.0074306603814595e+01</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">        </span><span class="mf">-1.6446172139457754e+01</span><span class="p">,</span><span class="w"> </span><span class="mf">-8.0756002564633450e+01</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">        </span><span class="o">+</span><span class="mf">3.2420501524111750e+02</span><span class="p">,</span><span class="w"> </span><span class="mf">-6.5601870948443250e+02</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">};</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">horner</span><span class="p">(</span><span class="n">f_n</span><span class="p">,</span><span class="w"> </span><span class="mf">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">coeff</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Standard PID (proportional, integral, derivative) controller. Derivative</span></code>
<code><span class="c1">/// component is filtered using an exponential moving average filter.</span></code>
<code><span class="k">class</span> <span class="nc">PID</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">PID</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// @param  kp</span></code>
<code><span class="w">    </span><span class="c1">///         Proportional gain</span></code>
<code><span class="w">    </span><span class="c1">/// @param  ki</span></code>
<code><span class="w">    </span><span class="c1">///         Integral gain</span></code>
<code><span class="w">    </span><span class="c1">/// @param  kd</span></code>
<code><span class="w">    </span><span class="c1">///         Derivative gain</span></code>
<code><span class="w">    </span><span class="c1">/// @param  Ts</span></code>
<code><span class="w">    </span><span class="c1">///         Sampling time (seconds)</span></code>
<code><span class="w">    </span><span class="c1">/// @param  fc</span></code>
<code><span class="w">    </span><span class="c1">///         Cutoff frequency of derivative EMA filter (Hertz),</span></code>
<code><span class="w">    </span><span class="c1">///         zero to disable the filter entirely</span></code>
<code><span class="w">    </span><span class="n">PID</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">kp</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ki</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">kd</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">Ts</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">f_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">maxOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">Ts</span><span class="p">(</span><span class="n">Ts</span><span class="p">),</span><span class="w"> </span><span class="n">maxOutput</span><span class="p">(</span><span class="n">maxOutput</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setKp</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setKi</span><span class="p">(</span><span class="n">ki</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setKd</span><span class="p">(</span><span class="n">kd</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setEMACutoff</span><span class="p">(</span><span class="n">f_c</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Update the controller: given the current position, compute the control</span></code>
<code><span class="w">    </span><span class="c1">/// action.</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// The error is the difference between the reference (setpoint) and the</span></code>
<code><span class="w">        </span><span class="c1">// actual position (input)</span></code>
<code><span class="w">        </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// The integral or sum of current and previous errors</span></code>
<code><span class="w">        </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">newIntegral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// Compute the difference between the current and the previous input,</span></code>
<code><span class="w">        </span><span class="c1">// but compute a weighted average using a factor α ∊ (0,1]</span></code>
<code><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emaAlpha</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">prevInput</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">input</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// Update the average</span></code>
<code><span class="w">        </span><span class="n">prevInput</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">diff</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="c1">// Check if we can turn off the motor</span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">activityThres</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">activityThres</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">filtError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prevInput</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filtError</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">-</span><span class="n">errThres</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">filtError</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">errThres</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">errThres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// hysteresis</span></code>
<code><span class="w">                </span><span class="n">integral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newIntegral</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">errThres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="o">++</span><span class="n">activityCount</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">errThres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">backward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">calcIntegral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">backward</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nl">newIntegral</span> <span class="p">:</span><span class="w"> </span><span class="n">integral</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="c1">// Standard PID rule</span></code>
<code><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ki_Ts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">calcIntegral</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kd_Ts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diff</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="c1">// Clamp and anti-windup</span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">output</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxOutput</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxOutput</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">output</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">maxOutput</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">maxOutput</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">integral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newIntegral</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setKp</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">kp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">kp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">               </span><span class="c1">///&lt; Proportional gain</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setKi</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">ki</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">ki_Ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ki</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">Ts</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">///&lt; Integral gain</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setKd</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">kd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">kd_Ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kd</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">Ts</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">///&lt; Derivative gain</span></code>
<code></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">getKp</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">kp</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">         </span><span class="c1">///&lt; Proportional gain</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">getKi</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ki_Ts</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Ts</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">///&lt; Integral gain</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">getKd</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">kd_Ts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Ts</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">///&lt; Derivative gain</span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Set the cutoff frequency (-3 dB point) of the exponential moving average</span></code>
<code><span class="w">    </span><span class="c1">/// filter that is applied to the input before taking the difference for</span></code>
<code><span class="w">    </span><span class="c1">/// computing the derivative term.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setEMACutoff</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">f_c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">f_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f_c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Ts</span><span class="p">;</span><span class="w"> </span><span class="c1">// normalized sampling frequency</span></code>
<code><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">emaAlpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f_c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">calcAlphaEMA</span><span class="p">(</span><span class="n">f_n</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Set the reference/target/setpoint of the controller.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setSetpoint</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">setpoint</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">setpoint</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">activityCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// @see @ref setSetpoint(int16_t)</span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">getSetpoint</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Set the maximum control output magnitude. Default is 255, which clamps</span></code>
<code><span class="w">    </span><span class="c1">/// the control output in [-255, +255].</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setMaxOutput</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">maxOutput</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">maxOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxOutput</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// @see @ref setMaxOutput(float)</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">getMaxOutput</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">maxOutput</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Reset the activity counter to prevent the motor from turning off.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">resetActivityCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">activityCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Set the number of seconds after which the motor is turned off, zero to</span></code>
<code><span class="w">    </span><span class="c1">/// keep it on indefinitely.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setActivityTimeout</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">activityThres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">activityThres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint16_t</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Ts</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Ts</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Reset the sum of the previous errors to zero.</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">resetIntegral</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">Ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">               </span><span class="c1">///&lt; Sampling time (seconds)</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">maxOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span><span class="w">      </span><span class="c1">///&lt; Maximum control output magnitude</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">kp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">               </span><span class="c1">///&lt; Proportional gain</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">ki_Ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">            </span><span class="c1">///&lt; Integral gain times Ts</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">kd_Ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">            </span><span class="c1">///&lt; Derivative gain divided by Ts</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">emaAlpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">         </span><span class="c1">///&lt; Weight factor of derivative EMA filter.</span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">prevInput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">        </span><span class="c1">///&lt; (Filtered) previous input for derivative.</span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">activityCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; How many ticks since last setpoint change.</span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">activityThres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; Threshold for turning off the output.</span></code>
<code><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">errThres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">       </span><span class="c1">///&lt; Threshold with hysteresis.</span></code>
<code><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">integral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">       </span><span class="c1">///&lt; Sum of previous errors for integral.</span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">      </span><span class="c1">///&lt; Position reference.</span></code>
<code><span class="p">};</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="motor-hpp" href="#motor-hpp">Motor.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments35 .hll { background-color: #ffffcc }
.pygments35 { background: #ffffff; }
.pygments35 .c { color: #008000 } /* Comment */
.pygments35 .err { border: 1px solid #FF0000 } /* Error */
.pygments35 .k { color: #0000ff } /* Keyword */
.pygments35 .l { color: #0000FF } /* Literal */
.pygments35 .ch { color: #008000 } /* Comment.Hashbang */
.pygments35 .cm { color: #008000 } /* Comment.Multiline */
.pygments35 .cp { color: #af00db } /* Comment.Preproc */
.pygments35 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments35 .c1 { color: #008000 } /* Comment.Single */
.pygments35 .cs { color: #008000 } /* Comment.Special */
.pygments35 .ge { font-style: italic } /* Generic.Emph */
.pygments35 .gh { font-weight: bold } /* Generic.Heading */
.pygments35 .gp { font-weight: bold } /* Generic.Prompt */
.pygments35 .gs { font-weight: bold } /* Generic.Strong */
.pygments35 .gu { font-weight: bold } /* Generic.Subheading */
.pygments35 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments35 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments35 .kn { color: #af00db } /* Keyword.Namespace */
.pygments35 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments35 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments35 .kt { color: #2b91af } /* Keyword.Type */
.pygments35 .ld { color: #0000FF } /* Literal.Date */
.pygments35 .m { color: #0000FF } /* Literal.Number */
.pygments35 .s { color: #a31515 } /* Literal.String */
.pygments35 .na { color: #001080 } /* Name.Attribute */
.pygments35 .nb { color: #795e26 } /* Name.Builtin */
.pygments35 .nc { color: #2b91af } /* Name.Class */
.pygments35 .no { color: #0000FF } /* Name.Constant */
.pygments35 .nf { color: #795e26 } /* Name.Function */
.pygments35 .nl { color: #AF00DB } /* Name.Label */
.pygments35 .nn { color: #000000 } /* Name.Namespace */
.pygments35 .nt { color: #800000 } /* Name.Tag */
.pygments35 .nv { color: #0F1E87 } /* Name.Variable */
.pygments35 .ow { color: #0000ff } /* Operator.Word */
.pygments35 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments35 .mf { color: #09885a } /* Literal.Number.Float */
.pygments35 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments35 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments35 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments35 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments35 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments35 .sc { color: #a31515 } /* Literal.String.Char */
.pygments35 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments35 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments35 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments35 .se { color: #a31515 } /* Literal.String.Escape */
.pygments35 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments35 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments35 .sx { color: #a31515 } /* Literal.String.Other */
.pygments35 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments35 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments35 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments35 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments35 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments35 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments35 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments35 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments35 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments35 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments35 pre.snippet35 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/661955c845f21c097258cf0082112123454a6b01/Motor-Controller/Motor.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments35"><pre class="lineNumbers snippet35"><code><span></span><span class="cp">#pragma once</span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Registers.hpp"</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avr/interrupt.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;util/atomic.h&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="c1">/// Configure Timer0 in either phase correct or fast PWM mode with the given</span></code>
<code><span class="c1">/// prescaler, enable output compare B.</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setupMotorTimer0</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">phase_correct</span><span class="p">,</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="w"> </span><span class="n">prescaler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setTimer0WGMode</span><span class="p">(</span><span class="n">phase_correct</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Timer0WGMode</span><span class="o">::</span><span class="nl">PWM</span></code>
<code>                                      <span class="p">:</span><span class="w"> </span><span class="n">Timer0WGMode</span><span class="o">::</span><span class="n">FastPWM</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setTimer0Prescaler</span><span class="p">(</span><span class="n">prescaler</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">COM0B1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Table 14-6, 14-7 Compare Output Mode</span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">COM0A1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Table 14-6, 14-7 Compare Output Mode</span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Configure Timer2 in either phase correct or fast PWM mode with the given</span></code>
<code><span class="c1">/// prescaler, enable output compare B.</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setupMotorTimer2</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">phase_correct</span><span class="p">,</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="w"> </span><span class="n">prescaler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setTimer2WGMode</span><span class="p">(</span><span class="n">phase_correct</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2WGMode</span><span class="o">::</span><span class="nl">PWM</span></code>
<code>                                      <span class="p">:</span><span class="w"> </span><span class="n">Timer2WGMode</span><span class="o">::</span><span class="n">FastPWM</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setTimer2Prescaler</span><span class="p">(</span><span class="n">prescaler</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">COM2B1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Table 14-6, 14-7 Compare Output Mode</span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">COM2A1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Table 14-6, 14-7 Compare Output Mode</span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Configure the timers for the PWM outputs.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">setupMotorTimers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">prescaler0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factorToTimer0Prescaler</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">prescaler_fac</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="n">prescaler0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">,</span><span class="w"> </span><span class="s">"Invalid prescaler"</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">prescaler2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factorToTimer2Prescaler</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">prescaler_fac</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="n">prescaler2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">,</span><span class="w"> </span><span class="s">"Invalid prescaler"</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setupMotorTimer2</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">phase_correct_pwm</span><span class="p">,</span><span class="w"> </span><span class="n">prescaler2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">setupMotorTimer0</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">phase_correct_pwm</span><span class="p">,</span><span class="w"> </span><span class="n">prescaler0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Class for driving up to 4 DC motors using PWM.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">struct</span> <span class="nc">Motors</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">begin</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setSpeed</span><span class="p">(</span><span class="kt">int16_t</span><span class="w"> </span><span class="n">speed</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setupGPIO</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">forward</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">speed</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">backward</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">speed</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Motors</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">setupMotorTimers</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRD</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRD</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">fader_1_A2</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRC</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRB</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRB</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRD</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRD</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRD</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sbi</span><span class="p">(</span><span class="n">DDRD</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// Fast PWM (Table 14-6):</span></code>
<code><span class="c1">//   Clear OC0B on Compare Match, set OC0B at BOTTOM (non-inverting mode).</span></code>
<code><span class="c1">// Phase Correct PWM (Table 14-7):</span></code>
<code><span class="c1">//   Clear OC0B on compare match when up-counting. Set OC0B on compare match</span></code>
<code><span class="c1">//   when down-counting.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Motors</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">forward</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">speed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">COM2B0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">PORTD</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR2B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">COM2A0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">fader_1_A2</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">cbi</span><span class="p">(</span><span class="n">PORTC</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">cbi</span><span class="p">(</span><span class="n">PORTB</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR2A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">COM0B0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">PORTD</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR0B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">COM0A0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">cbi</span><span class="p">(</span><span class="n">PORTD</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR0A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// Fast PWM (Table 14-6):</span></code>
<code><span class="c1">//   Set OC0B on Compare Match, clear OC0B at BOTTOM (inverting mode).</span></code>
<code><span class="c1">// Phase Correct PWM (Table 14-7):</span></code>
<code><span class="c1">//   Set OC0B on compare match when up-counting. Clear OC0B on compare match</span></code>
<code><span class="c1">//   when down-counting.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Motors</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">backward</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">speed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">num_faders</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">COM2B0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">PORTD</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR2B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">COM2A0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">fader_1_A2</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">sbi</span><span class="p">(</span><span class="n">PORTC</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">sbi</span><span class="p">(</span><span class="n">PORTB</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR2A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">COM0B0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">PORTD</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR0B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_RESTORESTATE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">COM0A0</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">sbi</span><span class="p">(</span><span class="n">PORTD</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">OCR0A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Idx</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Motors</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;::</span><span class="n">setSpeed</span><span class="p">(</span><span class="kt">int16_t</span><span class="w"> </span><span class="n">speed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Idx</span><span class="o">&gt;</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">backward</span><span class="o">&lt;</span><span class="n">Idx</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="n">speed</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="reference-hpp" href="#reference-hpp">Reference.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments39 .hll { background-color: #ffffcc }
.pygments39 { background: #ffffff; }
.pygments39 .c { color: #008000 } /* Comment */
.pygments39 .err { border: 1px solid #FF0000 } /* Error */
.pygments39 .k { color: #0000ff } /* Keyword */
.pygments39 .l { color: #0000FF } /* Literal */
.pygments39 .ch { color: #008000 } /* Comment.Hashbang */
.pygments39 .cm { color: #008000 } /* Comment.Multiline */
.pygments39 .cp { color: #af00db } /* Comment.Preproc */
.pygments39 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments39 .c1 { color: #008000 } /* Comment.Single */
.pygments39 .cs { color: #008000 } /* Comment.Special */
.pygments39 .ge { font-style: italic } /* Generic.Emph */
.pygments39 .gh { font-weight: bold } /* Generic.Heading */
.pygments39 .gp { font-weight: bold } /* Generic.Prompt */
.pygments39 .gs { font-weight: bold } /* Generic.Strong */
.pygments39 .gu { font-weight: bold } /* Generic.Subheading */
.pygments39 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments39 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments39 .kn { color: #af00db } /* Keyword.Namespace */
.pygments39 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments39 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments39 .kt { color: #2b91af } /* Keyword.Type */
.pygments39 .ld { color: #0000FF } /* Literal.Date */
.pygments39 .m { color: #0000FF } /* Literal.Number */
.pygments39 .s { color: #a31515 } /* Literal.String */
.pygments39 .na { color: #001080 } /* Name.Attribute */
.pygments39 .nb { color: #795e26 } /* Name.Builtin */
.pygments39 .nc { color: #2b91af } /* Name.Class */
.pygments39 .no { color: #0000FF } /* Name.Constant */
.pygments39 .nf { color: #795e26 } /* Name.Function */
.pygments39 .nl { color: #AF00DB } /* Name.Label */
.pygments39 .nn { color: #000000 } /* Name.Namespace */
.pygments39 .nt { color: #800000 } /* Name.Tag */
.pygments39 .nv { color: #0F1E87 } /* Name.Variable */
.pygments39 .ow { color: #0000ff } /* Operator.Word */
.pygments39 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments39 .mf { color: #09885a } /* Literal.Number.Float */
.pygments39 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments39 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments39 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments39 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments39 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments39 .sc { color: #a31515 } /* Literal.String.Char */
.pygments39 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments39 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments39 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments39 .se { color: #a31515 } /* Literal.String.Escape */
.pygments39 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments39 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments39 .sx { color: #a31515 } /* Literal.String.Other */
.pygments39 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments39 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments39 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments39 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments39 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments39 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments39 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments39 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments39 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments39 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments39 pre.snippet39 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/661955c845f21c097258cf0082112123454a6b01/Motor-Controller/Reference.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments39"><pre class="lineNumbers snippet39"><code><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avr/pgmspace.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stddef.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;util/atomic.h&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="c1">/// Reference signal for testing the controller.</span></code>
<code><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">reference_signal</span><span class="p">[]</span><span class="w"> </span><span class="n">PROGMEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Ramp up</span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="mi">37</span><span class="p">,</span><span class="w"> </span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">39</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">43</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="mi">66</span><span class="p">,</span><span class="w"> </span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span><span class="w"> </span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="mi">72</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="mi">74</span><span class="p">,</span><span class="w"> </span><span class="mi">75</span><span class="p">,</span><span class="w"> </span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">78</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">81</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">83</span><span class="p">,</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w"> </span><span class="mi">86</span><span class="p">,</span><span class="w"> </span><span class="mi">87</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">91</span><span class="p">,</span><span class="w"> </span><span class="mi">92</span><span class="p">,</span><span class="w"> </span><span class="mi">93</span><span class="p">,</span><span class="w"> </span><span class="mi">94</span><span class="p">,</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mi">96</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">98</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"> </span><span class="mi">103</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">106</span><span class="p">,</span><span class="w"> </span><span class="mi">107</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">109</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">115</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">118</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">121</span><span class="p">,</span><span class="w"> </span><span class="mi">122</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="mi">124</span><span class="p">,</span><span class="w"> </span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="mi">126</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">129</span><span class="p">,</span><span class="w"> </span><span class="mi">130</span><span class="p">,</span><span class="w"> </span><span class="mi">131</span><span class="p">,</span><span class="w"> </span><span class="mi">132</span><span class="p">,</span><span class="w"> </span><span class="mi">133</span><span class="p">,</span><span class="w"> </span><span class="mi">134</span><span class="p">,</span><span class="w"> </span><span class="mi">135</span><span class="p">,</span><span class="w"> </span><span class="mi">136</span><span class="p">,</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span><span class="w"> </span><span class="mi">138</span><span class="p">,</span><span class="w"> </span><span class="mi">139</span><span class="p">,</span><span class="w"> </span><span class="mi">140</span><span class="p">,</span><span class="w"> </span><span class="mi">141</span><span class="p">,</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">143</span><span class="p">,</span><span class="w"> </span><span class="mi">144</span><span class="p">,</span><span class="w"> </span><span class="mi">145</span><span class="p">,</span><span class="w"> </span><span class="mi">146</span><span class="p">,</span><span class="w"> </span><span class="mi">147</span><span class="p">,</span><span class="w"> </span><span class="mi">148</span><span class="p">,</span><span class="w"> </span><span class="mi">149</span><span class="p">,</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="mi">151</span><span class="p">,</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="w"> </span><span class="mi">153</span><span class="p">,</span><span class="w"> </span><span class="mi">154</span><span class="p">,</span><span class="w"> </span><span class="mi">155</span><span class="p">,</span><span class="w"> </span><span class="mi">156</span><span class="p">,</span><span class="w"> </span><span class="mi">157</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">158</span><span class="p">,</span><span class="w"> </span><span class="mi">159</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="mi">161</span><span class="p">,</span><span class="w"> </span><span class="mi">162</span><span class="p">,</span><span class="w"> </span><span class="mi">163</span><span class="p">,</span><span class="w"> </span><span class="mi">164</span><span class="p">,</span><span class="w"> </span><span class="mi">165</span><span class="p">,</span><span class="w"> </span><span class="mi">166</span><span class="p">,</span><span class="w"> </span><span class="mi">167</span><span class="p">,</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="mi">169</span><span class="p">,</span><span class="w"> </span><span class="mi">170</span><span class="p">,</span><span class="w"> </span><span class="mi">171</span><span class="p">,</span><span class="w"> </span><span class="mi">172</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">173</span><span class="p">,</span><span class="w"> </span><span class="mi">174</span><span class="p">,</span><span class="w"> </span><span class="mi">175</span><span class="p">,</span><span class="w"> </span><span class="mi">176</span><span class="p">,</span><span class="w"> </span><span class="mi">177</span><span class="p">,</span><span class="w"> </span><span class="mi">178</span><span class="p">,</span><span class="w"> </span><span class="mi">179</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">181</span><span class="p">,</span><span class="w"> </span><span class="mi">182</span><span class="p">,</span><span class="w"> </span><span class="mi">183</span><span class="p">,</span><span class="w"> </span><span class="mi">184</span><span class="p">,</span><span class="w"> </span><span class="mi">185</span><span class="p">,</span><span class="w"> </span><span class="mi">186</span><span class="p">,</span><span class="w"> </span><span class="mi">187</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">188</span><span class="p">,</span><span class="w"> </span><span class="mi">189</span><span class="p">,</span><span class="w"> </span><span class="mi">190</span><span class="p">,</span><span class="w"> </span><span class="mi">191</span><span class="p">,</span><span class="w"> </span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">193</span><span class="p">,</span><span class="w"> </span><span class="mi">194</span><span class="p">,</span><span class="w"> </span><span class="mi">195</span><span class="p">,</span><span class="w"> </span><span class="mi">196</span><span class="p">,</span><span class="w"> </span><span class="mi">197</span><span class="p">,</span><span class="w"> </span><span class="mi">198</span><span class="p">,</span><span class="w"> </span><span class="mi">199</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">201</span><span class="p">,</span><span class="w"> </span><span class="mi">202</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">203</span><span class="p">,</span><span class="w"> </span><span class="mi">204</span><span class="p">,</span><span class="w"> </span><span class="mi">205</span><span class="p">,</span><span class="w"> </span><span class="mi">206</span><span class="p">,</span><span class="w"> </span><span class="mi">207</span><span class="p">,</span><span class="w"> </span><span class="mi">208</span><span class="p">,</span><span class="w"> </span><span class="mi">209</span><span class="p">,</span><span class="w"> </span><span class="mi">210</span><span class="p">,</span><span class="w"> </span><span class="mi">211</span><span class="p">,</span><span class="w"> </span><span class="mi">212</span><span class="p">,</span><span class="w"> </span><span class="mi">213</span><span class="p">,</span><span class="w"> </span><span class="mi">214</span><span class="p">,</span><span class="w"> </span><span class="mi">215</span><span class="p">,</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w"> </span><span class="mi">217</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">218</span><span class="p">,</span><span class="w"> </span><span class="mi">219</span><span class="p">,</span><span class="w"> </span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="mi">221</span><span class="p">,</span><span class="w"> </span><span class="mi">222</span><span class="p">,</span><span class="w"> </span><span class="mi">223</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p">,</span><span class="w"> </span><span class="mi">225</span><span class="p">,</span><span class="w"> </span><span class="mi">226</span><span class="p">,</span><span class="w"> </span><span class="mi">227</span><span class="p">,</span><span class="w"> </span><span class="mi">228</span><span class="p">,</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="mi">230</span><span class="p">,</span><span class="w"> </span><span class="mi">231</span><span class="p">,</span><span class="w"> </span><span class="mi">232</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">233</span><span class="p">,</span><span class="w"> </span><span class="mi">234</span><span class="p">,</span><span class="w"> </span><span class="mi">235</span><span class="p">,</span><span class="w"> </span><span class="mi">236</span><span class="p">,</span><span class="w"> </span><span class="mi">237</span><span class="p">,</span><span class="w"> </span><span class="mi">238</span><span class="p">,</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="mi">240</span><span class="p">,</span><span class="w"> </span><span class="mi">241</span><span class="p">,</span><span class="w"> </span><span class="mi">242</span><span class="p">,</span><span class="w"> </span><span class="mi">243</span><span class="p">,</span><span class="w"> </span><span class="mi">244</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">246</span><span class="p">,</span><span class="w"> </span><span class="mi">247</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">248</span><span class="p">,</span><span class="w"> </span><span class="mi">249</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="mi">251</span><span class="p">,</span><span class="w"> </span><span class="mi">252</span><span class="p">,</span><span class="w"> </span><span class="mi">253</span><span class="p">,</span><span class="w"> </span><span class="mi">254</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Max</span></code>
<code><span class="w">    </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Ramp down</span></code>
<code><span class="w">    </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">254</span><span class="p">,</span><span class="w"> </span><span class="mi">253</span><span class="p">,</span><span class="w"> </span><span class="mi">252</span><span class="p">,</span><span class="w"> </span><span class="mi">251</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="mi">249</span><span class="p">,</span><span class="w"> </span><span class="mi">248</span><span class="p">,</span><span class="w"> </span><span class="mi">247</span><span class="p">,</span><span class="w"> </span><span class="mi">246</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">244</span><span class="p">,</span><span class="w"> </span><span class="mi">243</span><span class="p">,</span><span class="w"> </span><span class="mi">242</span><span class="p">,</span><span class="w"> </span><span class="mi">241</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">240</span><span class="p">,</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="mi">238</span><span class="p">,</span><span class="w"> </span><span class="mi">237</span><span class="p">,</span><span class="w"> </span><span class="mi">236</span><span class="p">,</span><span class="w"> </span><span class="mi">235</span><span class="p">,</span><span class="w"> </span><span class="mi">234</span><span class="p">,</span><span class="w"> </span><span class="mi">233</span><span class="p">,</span><span class="w"> </span><span class="mi">232</span><span class="p">,</span><span class="w"> </span><span class="mi">231</span><span class="p">,</span><span class="w"> </span><span class="mi">230</span><span class="p">,</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="mi">228</span><span class="p">,</span><span class="w"> </span><span class="mi">227</span><span class="p">,</span><span class="w"> </span><span class="mi">226</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">225</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p">,</span><span class="w"> </span><span class="mi">223</span><span class="p">,</span><span class="w"> </span><span class="mi">222</span><span class="p">,</span><span class="w"> </span><span class="mi">221</span><span class="p">,</span><span class="w"> </span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="mi">219</span><span class="p">,</span><span class="w"> </span><span class="mi">218</span><span class="p">,</span><span class="w"> </span><span class="mi">217</span><span class="p">,</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w"> </span><span class="mi">215</span><span class="p">,</span><span class="w"> </span><span class="mi">214</span><span class="p">,</span><span class="w"> </span><span class="mi">213</span><span class="p">,</span><span class="w"> </span><span class="mi">212</span><span class="p">,</span><span class="w"> </span><span class="mi">211</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">210</span><span class="p">,</span><span class="w"> </span><span class="mi">209</span><span class="p">,</span><span class="w"> </span><span class="mi">208</span><span class="p">,</span><span class="w"> </span><span class="mi">207</span><span class="p">,</span><span class="w"> </span><span class="mi">206</span><span class="p">,</span><span class="w"> </span><span class="mi">205</span><span class="p">,</span><span class="w"> </span><span class="mi">204</span><span class="p">,</span><span class="w"> </span><span class="mi">203</span><span class="p">,</span><span class="w"> </span><span class="mi">202</span><span class="p">,</span><span class="w"> </span><span class="mi">201</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">199</span><span class="p">,</span><span class="w"> </span><span class="mi">198</span><span class="p">,</span><span class="w"> </span><span class="mi">197</span><span class="p">,</span><span class="w"> </span><span class="mi">196</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">195</span><span class="p">,</span><span class="w"> </span><span class="mi">194</span><span class="p">,</span><span class="w"> </span><span class="mi">193</span><span class="p">,</span><span class="w"> </span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">191</span><span class="p">,</span><span class="w"> </span><span class="mi">190</span><span class="p">,</span><span class="w"> </span><span class="mi">189</span><span class="p">,</span><span class="w"> </span><span class="mi">188</span><span class="p">,</span><span class="w"> </span><span class="mi">187</span><span class="p">,</span><span class="w"> </span><span class="mi">186</span><span class="p">,</span><span class="w"> </span><span class="mi">185</span><span class="p">,</span><span class="w"> </span><span class="mi">184</span><span class="p">,</span><span class="w"> </span><span class="mi">183</span><span class="p">,</span><span class="w"> </span><span class="mi">182</span><span class="p">,</span><span class="w"> </span><span class="mi">181</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">179</span><span class="p">,</span><span class="w"> </span><span class="mi">178</span><span class="p">,</span><span class="w"> </span><span class="mi">177</span><span class="p">,</span><span class="w"> </span><span class="mi">176</span><span class="p">,</span><span class="w"> </span><span class="mi">175</span><span class="p">,</span><span class="w"> </span><span class="mi">174</span><span class="p">,</span><span class="w"> </span><span class="mi">173</span><span class="p">,</span><span class="w"> </span><span class="mi">172</span><span class="p">,</span><span class="w"> </span><span class="mi">171</span><span class="p">,</span><span class="w"> </span><span class="mi">170</span><span class="p">,</span><span class="w"> </span><span class="mi">169</span><span class="p">,</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="mi">167</span><span class="p">,</span><span class="w"> </span><span class="mi">166</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">165</span><span class="p">,</span><span class="w"> </span><span class="mi">164</span><span class="p">,</span><span class="w"> </span><span class="mi">163</span><span class="p">,</span><span class="w"> </span><span class="mi">162</span><span class="p">,</span><span class="w"> </span><span class="mi">161</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="mi">159</span><span class="p">,</span><span class="w"> </span><span class="mi">158</span><span class="p">,</span><span class="w"> </span><span class="mi">157</span><span class="p">,</span><span class="w"> </span><span class="mi">156</span><span class="p">,</span><span class="w"> </span><span class="mi">155</span><span class="p">,</span><span class="w"> </span><span class="mi">154</span><span class="p">,</span><span class="w"> </span><span class="mi">153</span><span class="p">,</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="w"> </span><span class="mi">151</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="mi">149</span><span class="p">,</span><span class="w"> </span><span class="mi">148</span><span class="p">,</span><span class="w"> </span><span class="mi">147</span><span class="p">,</span><span class="w"> </span><span class="mi">146</span><span class="p">,</span><span class="w"> </span><span class="mi">145</span><span class="p">,</span><span class="w"> </span><span class="mi">144</span><span class="p">,</span><span class="w"> </span><span class="mi">143</span><span class="p">,</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span><span class="w"> </span><span class="mi">141</span><span class="p">,</span><span class="w"> </span><span class="mi">140</span><span class="p">,</span><span class="w"> </span><span class="mi">139</span><span class="p">,</span><span class="w"> </span><span class="mi">138</span><span class="p">,</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span><span class="w"> </span><span class="mi">136</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">135</span><span class="p">,</span><span class="w"> </span><span class="mi">134</span><span class="p">,</span><span class="w"> </span><span class="mi">133</span><span class="p">,</span><span class="w"> </span><span class="mi">132</span><span class="p">,</span><span class="w"> </span><span class="mi">131</span><span class="p">,</span><span class="w"> </span><span class="mi">130</span><span class="p">,</span><span class="w"> </span><span class="mi">129</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Middle</span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Jump low</span></code>
<code><span class="w">    </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Jump middle</span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Jump high</span></code>
<code><span class="w">    </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Jump middle</span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">// Ramp down</span></code>
<code><span class="w">    </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">126</span><span class="p">,</span><span class="w"> </span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="mi">124</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="mi">122</span><span class="p">,</span><span class="w"> </span><span class="mi">121</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">118</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">115</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">109</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">107</span><span class="p">,</span><span class="w"> </span><span class="mi">106</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">103</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">98</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mi">94</span><span class="p">,</span><span class="w"> </span><span class="mi">93</span><span class="p">,</span><span class="w"> </span><span class="mi">92</span><span class="p">,</span><span class="w"> </span><span class="mi">91</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="mi">87</span><span class="p">,</span><span class="w"> </span><span class="mi">86</span><span class="p">,</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="mi">83</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">81</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">78</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">77</span><span class="p">,</span><span class="w"> </span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="mi">75</span><span class="p">,</span><span class="w"> </span><span class="mi">74</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="mi">72</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span><span class="w"> </span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">66</span><span class="p">,</span><span class="w"> </span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">43</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">39</span><span class="p">,</span><span class="w"> </span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">37</span><span class="p">,</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// Low</span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Get the number of elements in the given array.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="p">)[</span><span class="n">N</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Class that handles the three main references/setpoints:</span></code>
<code><span class="c1">///   1. Sequence programmed in PROGMEM</span></code>
<code><span class="c1">///   2. Test sequence for tuning experiments (activated over Serial)</span></code>
<code><span class="c1">///   3. Setpoint set by the I²C master (for real-world use)</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Config</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">class</span> <span class="nc">Reference</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Called from ISR</span></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setMasterSetpoint</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">master_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">startExperiment</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">speed_div</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">experiment_speed_div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speed_div</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">seq_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">experimentInProgress</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">experiment_speed_div</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">getNextProgmemSetpoint</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgm_read_byte</span><span class="p">(</span><span class="n">reference_signal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="o">++</span><span class="n">seq_idx</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seq_idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Config</span><span class="o">::</span><span class="n">test_reference_speed_div</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">seq_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="o">++</span><span class="n">index</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">reference_signal</span><span class="p">))</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">getNextExperimentSetpoint</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">RAMPUP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rampup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[](</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kt">uint32_t</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">duration</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">};</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">RAMPDOWN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFE</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rampdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1023</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rampup</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">};</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">struct</span> <span class="nc">TestSeq</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">duration</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">};</span><span class="w"></span></code>
<code><span class="w">        </span><span class="c1">// This array defines the test sequence</span></code>
<code><span class="w">        </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TestSeq</span><span class="w"> </span><span class="n">seqs</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">},</span><span class="w">  </span><span class="p">{</span><span class="n">RAMPUP</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">1023</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">},</span><span class="w">    </span><span class="p">{</span><span class="mi">333</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">},</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">{</span><span class="mi">666</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">333</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">},</span><span class="w">     </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">},</span><span class="w">    </span><span class="p">{</span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">},</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">seq_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seqs</span><span class="p">[</span><span class="n">seq_index</span><span class="p">].</span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">experiment_speed_div</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">seq_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seqs</span><span class="p">[</span><span class="n">seq_index</span><span class="p">].</span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">seq_setpoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nl">RAMPUP</span><span class="p">:</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rampup</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nl">RAMPDOWN</span><span class="p">:</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rampdown</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq_setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="o">++</span><span class="n">index</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="o">++</span><span class="n">seq_index</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seq_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">len</span><span class="p">(</span><span class="n">seqs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">seq_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">experiment_speed_div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Called from main program with interrupts enabled</span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">getNextSetpoint</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">serial_control</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">experiment_speed_div</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">            </span><span class="c1">// from the tuning experiment reference</span></code>
<code><span class="w">            </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNextExperimentSetpoint</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">test_reference</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">            </span><span class="c1">// from the test reference</span></code>
<code><span class="w">            </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getNextProgmemSetpoint</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">else</span><span class="w"></span></code>
<code><span class="w">            </span><span class="c1">// from the I²C master</span></code>
<code><span class="w">            </span><span class="n">ATOMIC_BLOCK</span><span class="p">(</span><span class="n">ATOMIC_FORCEON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">master_setpoint</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">setpoint</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">seq_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">experiment_speed_div</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">master_setpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="registers-hpp" href="#registers-hpp">Registers.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments43 .hll { background-color: #ffffcc }
.pygments43 { background: #ffffff; }
.pygments43 .c { color: #008000 } /* Comment */
.pygments43 .err { border: 1px solid #FF0000 } /* Error */
.pygments43 .k { color: #0000ff } /* Keyword */
.pygments43 .l { color: #0000FF } /* Literal */
.pygments43 .ch { color: #008000 } /* Comment.Hashbang */
.pygments43 .cm { color: #008000 } /* Comment.Multiline */
.pygments43 .cp { color: #af00db } /* Comment.Preproc */
.pygments43 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments43 .c1 { color: #008000 } /* Comment.Single */
.pygments43 .cs { color: #008000 } /* Comment.Special */
.pygments43 .ge { font-style: italic } /* Generic.Emph */
.pygments43 .gh { font-weight: bold } /* Generic.Heading */
.pygments43 .gp { font-weight: bold } /* Generic.Prompt */
.pygments43 .gs { font-weight: bold } /* Generic.Strong */
.pygments43 .gu { font-weight: bold } /* Generic.Subheading */
.pygments43 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments43 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments43 .kn { color: #af00db } /* Keyword.Namespace */
.pygments43 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments43 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments43 .kt { color: #2b91af } /* Keyword.Type */
.pygments43 .ld { color: #0000FF } /* Literal.Date */
.pygments43 .m { color: #0000FF } /* Literal.Number */
.pygments43 .s { color: #a31515 } /* Literal.String */
.pygments43 .na { color: #001080 } /* Name.Attribute */
.pygments43 .nb { color: #795e26 } /* Name.Builtin */
.pygments43 .nc { color: #2b91af } /* Name.Class */
.pygments43 .no { color: #0000FF } /* Name.Constant */
.pygments43 .nf { color: #795e26 } /* Name.Function */
.pygments43 .nl { color: #AF00DB } /* Name.Label */
.pygments43 .nn { color: #000000 } /* Name.Namespace */
.pygments43 .nt { color: #800000 } /* Name.Tag */
.pygments43 .nv { color: #0F1E87 } /* Name.Variable */
.pygments43 .ow { color: #0000ff } /* Operator.Word */
.pygments43 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments43 .mf { color: #09885a } /* Literal.Number.Float */
.pygments43 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments43 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments43 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments43 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments43 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments43 .sc { color: #a31515 } /* Literal.String.Char */
.pygments43 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments43 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments43 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments43 .se { color: #a31515 } /* Literal.String.Escape */
.pygments43 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments43 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments43 .sx { color: #a31515 } /* Literal.String.Other */
.pygments43 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments43 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments43 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments43 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments43 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments43 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments43 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments43 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments43 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments43 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments43 pre.snippet43 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/661955c845f21c097258cf0082112123454a6b01/Motor-Controller/Registers.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments43"><pre class="lineNumbers snippet43"><code><span></span><span class="cp">#pragma once</span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avr/io.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avr/sfr_defs.h&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;util/delay.h&gt;</span><span class="c1"> // F_CPU</span><span class="cp"></span></code>
<code></code>
<code><span class="c1">// --------------------------------- Utils ---------------------------------- //</span></code>
<code></code>
<code><span class="cp">#ifndef ARDUINO </span><span class="c1">// Ensures that my IDE sees the correct frequency</span></code>
<code><span class="cp">#undef F_CPU</span></code>
<code><span class="cp">#define F_CPU 16000000UL</span></code>
<code><span class="cp">#endif</span></code>
<code></code>
<code><span class="cp">#ifndef sbi</span></code>
<code><span class="c1">/// Set bit in register.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">sbi</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">reg</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bit</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code><span class="cp">#define sbi sbi</span></code>
<code><span class="cp">#endif</span></code>
<code><span class="cp">#ifndef cbi</span></code>
<code><span class="c1">/// Clear bit in register.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">cbi</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">reg</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bit</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code><span class="cp">#define cbi cbi</span></code>
<code><span class="cp">#endif</span></code>
<code><span class="c1">/// Write bit in register.</span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">R</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">wbi</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">bit</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">sbi</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="n">bit</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cbi</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="w"> </span><span class="n">bit</span><span class="p">);</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// --------------------------------- Timer0 --------------------------------- //</span></code>
<code></code>
<code><span class="c1">/// Timer 0 clock select (Table 14-9).</span></code>
<code><span class="k">enum</span> <span class="k">class</span><span class="w"> </span><span class="nc">Timer0Prescaler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">None</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b000</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b010</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b011</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S256</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b100</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S1024</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b101</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ExtFall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b110</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">ExtRise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b111</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">Invalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">,</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Timer 0 waveform generation mode (Table 14-8).</span></code>
<code><span class="k">enum</span> <span class="k">class</span><span class="w"> </span><span class="nc">Timer0WGMode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">Normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b000</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">PWM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">CTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b010</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">FastPWM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b011</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">PWM_OCRA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b101</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">FastPWM_OCRA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b111</span><span class="p">,</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// Convert the prescaler factor to the correct bit pattern to write to the</span></code>
<code><span class="c1">// TCCR0B register (Table 14-9).</span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="w"> </span><span class="nf">factorToTimer0Prescaler</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">factor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="nl">S1</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="nl">S8</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">64</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="nl">S64</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">256</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="nl">S256</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="nl">S1024</span></code>
<code>                            <span class="p">:</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Set the clock source/prescaler of Timer0 (Table 14-9).</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setTimer0Prescaler</span><span class="p">(</span><span class="n">Timer0Prescaler</span><span class="w"> </span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Timer0Prescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR0B</span><span class="p">,</span><span class="w"> </span><span class="n">CS02</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR0B</span><span class="p">,</span><span class="w"> </span><span class="n">CS01</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR0B</span><span class="p">,</span><span class="w"> </span><span class="n">CS00</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Set the wavefrom generation mode of Timer0 (Table 14-8).</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setTimer0WGMode</span><span class="p">(</span><span class="n">Timer0WGMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR0B</span><span class="p">,</span><span class="w"> </span><span class="n">WGM02</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">WGM01</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR0A</span><span class="p">,</span><span class="w"> </span><span class="n">WGM00</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// --------------------------------- Timer2 --------------------------------- //</span></code>
<code></code>
<code><span class="c1">/// Timer 0 clock select (Table 17-9).</span></code>
<code><span class="k">enum</span> <span class="k">class</span><span class="w"> </span><span class="nc">Timer2Prescaler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">None</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b000</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b010</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b011</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b100</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S128</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b101</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S256</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b110</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S1024</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b111</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">Invalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">,</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Timer 0 waveform generation mode (Table 17-8).</span></code>
<code><span class="k">enum</span> <span class="k">class</span><span class="w"> </span><span class="nc">Timer2WGMode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">Normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b000</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">PWM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">CTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b010</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">FastPWM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b011</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">PWM_OCRA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b101</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">FastPWM_OCRA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b111</span><span class="p">,</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// Convert the prescaler factor to the correct bit pattern to write to the</span></code>
<code><span class="c1">// TCCR0B register (Table 17-9).</span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="w"> </span><span class="nf">factorToTimer2Prescaler</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">factor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="nl">S1</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="nl">S8</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="nl">S32</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">64</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="nl">S64</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">128</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="nl">S128</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">256</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="nl">S256</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="nl">S1024</span></code>
<code>                            <span class="p">:</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Set the clock source/prescaler of Timer2 (Table 17-9).</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setTimer2Prescaler</span><span class="p">(</span><span class="n">Timer2Prescaler</span><span class="w"> </span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Timer2Prescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR2B</span><span class="p">,</span><span class="w"> </span><span class="n">CS22</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR2B</span><span class="p">,</span><span class="w"> </span><span class="n">CS21</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR2B</span><span class="p">,</span><span class="w"> </span><span class="n">CS20</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Set the wavefrom generation mode of Timer2 (Table 17-8).</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setTimer2WGMode</span><span class="p">(</span><span class="n">Timer2WGMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR2B</span><span class="p">,</span><span class="w"> </span><span class="n">WGM22</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">WGM21</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">TCCR2A</span><span class="p">,</span><span class="w"> </span><span class="n">WGM20</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// ---------------------------------- ADC ----------------------------------- //</span></code>
<code></code>
<code><span class="c1">/// ADC prescaler select (Table 23-5).</span></code>
<code><span class="k">enum</span> <span class="k">class</span><span class="w"> </span><span class="nc">ADCPrescaler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b000</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S2_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b010</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b011</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b100</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b101</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b110</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">S128</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b111</span><span class="p">,</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">Invalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">,</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="c1">// Convert the prescaler factor to the correct bit pattern to write to the</span></code>
<code><span class="c1">// ADCSRA register (Table 23-5).</span></code>
<code><span class="k">constexpr</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="w"> </span><span class="nf">factorToADCPrescaler</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">factor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w">     </span><span class="o">?</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="nl">S2_2</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="nl">S4</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="nl">S8</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">16</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="nl">S16</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">32</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="nl">S32</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">64</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="nl">S64</span></code>
<code>           <span class="p">:</span><span class="w"> </span><span class="n">factor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="nl">S128</span></code>
<code>                           <span class="p">:</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Set the prescaler of the ADC (Table 23-5).</span></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setADCPrescaler</span><span class="p">(</span><span class="n">ADCPrescaler</span><span class="w"> </span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ADCPrescaler</span><span class="o">::</span><span class="n">Invalid</span><span class="p">)</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADPS2</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADPS1</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">wbi</span><span class="p">(</span><span class="n">ADCSRA</span><span class="p">,</span><span class="w"> </span><span class="n">ADPS0</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1u</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="serialslip-hpp" href="#serialslip-hpp">SerialSLIP.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments47 .hll { background-color: #ffffcc }
.pygments47 { background: #ffffff; }
.pygments47 .c { color: #008000 } /* Comment */
.pygments47 .err { border: 1px solid #FF0000 } /* Error */
.pygments47 .k { color: #0000ff } /* Keyword */
.pygments47 .l { color: #0000FF } /* Literal */
.pygments47 .ch { color: #008000 } /* Comment.Hashbang */
.pygments47 .cm { color: #008000 } /* Comment.Multiline */
.pygments47 .cp { color: #af00db } /* Comment.Preproc */
.pygments47 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments47 .c1 { color: #008000 } /* Comment.Single */
.pygments47 .cs { color: #008000 } /* Comment.Special */
.pygments47 .ge { font-style: italic } /* Generic.Emph */
.pygments47 .gh { font-weight: bold } /* Generic.Heading */
.pygments47 .gp { font-weight: bold } /* Generic.Prompt */
.pygments47 .gs { font-weight: bold } /* Generic.Strong */
.pygments47 .gu { font-weight: bold } /* Generic.Subheading */
.pygments47 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments47 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments47 .kn { color: #af00db } /* Keyword.Namespace */
.pygments47 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments47 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments47 .kt { color: #2b91af } /* Keyword.Type */
.pygments47 .ld { color: #0000FF } /* Literal.Date */
.pygments47 .m { color: #0000FF } /* Literal.Number */
.pygments47 .s { color: #a31515 } /* Literal.String */
.pygments47 .na { color: #001080 } /* Name.Attribute */
.pygments47 .nb { color: #795e26 } /* Name.Builtin */
.pygments47 .nc { color: #2b91af } /* Name.Class */
.pygments47 .no { color: #0000FF } /* Name.Constant */
.pygments47 .nf { color: #795e26 } /* Name.Function */
.pygments47 .nl { color: #AF00DB } /* Name.Label */
.pygments47 .nn { color: #000000 } /* Name.Namespace */
.pygments47 .nt { color: #800000 } /* Name.Tag */
.pygments47 .nv { color: #0F1E87 } /* Name.Variable */
.pygments47 .ow { color: #0000ff } /* Operator.Word */
.pygments47 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments47 .mf { color: #09885a } /* Literal.Number.Float */
.pygments47 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments47 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments47 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments47 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments47 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments47 .sc { color: #a31515 } /* Literal.String.Char */
.pygments47 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments47 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments47 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments47 .se { color: #a31515 } /* Literal.String.Escape */
.pygments47 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments47 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments47 .sx { color: #a31515 } /* Literal.String.Other */
.pygments47 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments47 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments47 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments47 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments47 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments47 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments47 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments47 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments47 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments47 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments47 pre.snippet47 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/661955c845f21c097258cf0082112123454a6b01/Motor-Controller/SerialSLIP.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments47"><pre class="lineNumbers snippet47"><code><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="k">namespace</span><span class="w"> </span><span class="nn">SLIP_Constants</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0300</span><span class="p">;</span><span class="w"></span></code>
<code><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ESC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0333</span><span class="p">;</span><span class="w"></span></code>
<code><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ESC_END</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0334</span><span class="p">;</span><span class="w"></span></code>
<code><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ESC_ESC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0335</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"> </span><span class="c1">// namespace SLIP_Constants</span></code>
<code></code>
<code><span class="c1">/// Parses SLIP packets: https://datatracker.ietf.org/doc/html/rfc1055</span></code>
<code><span class="k">class</span> <span class="nc">SLIPParser</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Callback</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">parse</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">Callback</span><span class="w"> </span><span class="n">callback</span><span class="p">);</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Callback</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="kt">size_t</span><span class="w"> </span><span class="n">SLIPParser</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">Callback</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">SLIP_Constants</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="cm">/*</span></code>
<code><span class="cm">     * handle bytestuffing if necessary</span></code>
<code><span class="cm">     */</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="cm">/*</span></code>
<code><span class="cm">         * if it's an END character then we're done with</span></code>
<code><span class="cm">         * the packet</span></code>
<code><span class="cm">         */</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">END</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="cm">/* </span></code>
<code><span class="cm">             * a minor optimization: if there is no</span></code>
<code><span class="cm">             * data in the packet, ignore it. This is</span></code>
<code><span class="cm">             * meant to avoid bothering IP with all</span></code>
<code><span class="cm">             * the empty packets generated by the</span></code>
<code><span class="cm">             * duplicate END characters which are in</span></code>
<code><span class="cm">             * turn sent to try to detect line noise.</span></code>
<code><span class="cm">             */</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">packetLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">reset</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">packetLen</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">packetLen</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="cm">/*</span></code>
<code><span class="cm">         * if it's the same code as an ESC character, wait</span></code>
<code><span class="cm">         * and get another character and then figure out</span></code>
<code><span class="cm">         * what to store in the packet based on that.</span></code>
<code><span class="cm">         */</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">ESC</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">        </span><span class="cm">/*</span></code>
<code><span class="cm">         * here we fall into the default handler and let</span></code>
<code><span class="cm">         * it store the character for us</span></code>
<code><span class="cm">         */</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                </span><span class="cm">/*</span></code>
<code><span class="cm">                 * if "c" is not one of these two, then we</span></code>
<code><span class="cm">                 * have a protocol violation.  The best bet</span></code>
<code><span class="cm">                 * seems to be to leave the byte alone and</span></code>
<code><span class="cm">                 * just stuff it into the packet</span></code>
<code><span class="cm">                 */</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="nl">ESC_END</span><span class="p">:</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">END</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="nl">ESC_ESC</span><span class="p">:</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESC</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">                    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// LCOV_EXCL_LINE (protocol violation)</span></code>
<code><span class="w">                </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">            </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">            </span><span class="n">callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">            </span><span class="o">++</span><span class="n">size</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="c1">/// Sends SLIP packets: https://datatracker.ietf.org/doc/html/rfc1055</span></code>
<code><span class="k">class</span> <span class="nc">SLIPSender</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">SLIPSender</span><span class="p">(</span><span class="n">Stream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">beginPacket</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">SLIP_Constants</span><span class="o">::</span><span class="n">END</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">endPacket</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">SLIP_Constants</span><span class="o">::</span><span class="n">END</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">writePacket</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">beginPacket</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">endPacket</span><span class="p">();</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sent</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">Stream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stream</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code>
<code></code>
<code><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">SLIPSender::write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">// https://datatracker.ietf.org/doc/html/rfc1055</span></code>
<code><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">SLIP_Constants</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="cm">/* </span></code>
<code><span class="cm">     * for each byte in the packet, send the appropriate character</span></code>
<code><span class="cm">     * sequence</span></code>
<code><span class="cm">     */</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">            </span><span class="cm">/*</span></code>
<code><span class="cm">             * if it's the same code as an END character, we send a</span></code>
<code><span class="cm">             * special two character code so as not to make the</span></code>
<code><span class="cm">             * receiver think we sent an END</span></code>
<code><span class="cm">             */</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nl">END</span><span class="p">:</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">ESC</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">ESC_END</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">            </span><span class="cm">/*</span></code>
<code><span class="cm">             * if it's the same code as an ESC character,</span></code>
<code><span class="cm">             * we send a special two character code so as not</span></code>
<code><span class="cm">             * to make the receiver think we sent an ESC</span></code>
<code><span class="cm">             */</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="nl">ESC</span><span class="p">:</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">ESC</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">                </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">ESC_ESC</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">            </span><span class="cm">/*</span></code>
<code><span class="cm">             * otherwise, we just send the character</span></code>
<code><span class="cm">             */</span><span class="w"></span></code>
<code><span class="w">            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">        </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">data</span><span class="o">++</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sent</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">}</span><span class="w"></span></code></pre></div>
</div>
<h4 class="snippet-name"><a name="sma-hpp" href="#sma-hpp">SMA.hpp</a></h4>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments51 .hll { background-color: #ffffcc }
.pygments51 { background: #ffffff; }
.pygments51 .c { color: #008000 } /* Comment */
.pygments51 .err { border: 1px solid #FF0000 } /* Error */
.pygments51 .k { color: #0000ff } /* Keyword */
.pygments51 .l { color: #0000FF } /* Literal */
.pygments51 .ch { color: #008000 } /* Comment.Hashbang */
.pygments51 .cm { color: #008000 } /* Comment.Multiline */
.pygments51 .cp { color: #af00db } /* Comment.Preproc */
.pygments51 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments51 .c1 { color: #008000 } /* Comment.Single */
.pygments51 .cs { color: #008000 } /* Comment.Special */
.pygments51 .ge { font-style: italic } /* Generic.Emph */
.pygments51 .gh { font-weight: bold } /* Generic.Heading */
.pygments51 .gp { font-weight: bold } /* Generic.Prompt */
.pygments51 .gs { font-weight: bold } /* Generic.Strong */
.pygments51 .gu { font-weight: bold } /* Generic.Subheading */
.pygments51 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments51 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments51 .kn { color: #af00db } /* Keyword.Namespace */
.pygments51 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments51 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments51 .kt { color: #2b91af } /* Keyword.Type */
.pygments51 .ld { color: #0000FF } /* Literal.Date */
.pygments51 .m { color: #0000FF } /* Literal.Number */
.pygments51 .s { color: #a31515 } /* Literal.String */
.pygments51 .na { color: #001080 } /* Name.Attribute */
.pygments51 .nb { color: #795e26 } /* Name.Builtin */
.pygments51 .nc { color: #2b91af } /* Name.Class */
.pygments51 .no { color: #0000FF } /* Name.Constant */
.pygments51 .nf { color: #795e26 } /* Name.Function */
.pygments51 .nl { color: #AF00DB } /* Name.Label */
.pygments51 .nn { color: #000000 } /* Name.Namespace */
.pygments51 .nt { color: #800000 } /* Name.Tag */
.pygments51 .nv { color: #0F1E87 } /* Name.Variable */
.pygments51 .ow { color: #0000ff } /* Operator.Word */
.pygments51 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments51 .mf { color: #09885a } /* Literal.Number.Float */
.pygments51 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments51 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments51 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments51 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments51 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments51 .sc { color: #a31515 } /* Literal.String.Char */
.pygments51 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments51 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments51 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments51 .se { color: #a31515 } /* Literal.String.Escape */
.pygments51 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments51 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments51 .sx { color: #a31515 } /* Literal.String.Other */
.pygments51 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments51 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments51 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments51 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments51 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments51 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments51 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments51 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments51 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments51 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments51 pre.snippet51 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/Control-Surface-Motor-Fader/blob/661955c845f21c097258cf0082112123454a6b01/Motor-Controller/SMA.hpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>
<div class="pygments51"><pre class="lineNumbers snippet51"><code><span></span><span class="cp">#pragma once</span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino_Helpers.h&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;AH/Math/Divide.hpp&gt;</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;AH/STL/algorithm&gt;</span><span class="c1"> // std::fill</span><span class="cp"></span></code>
<code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;AH/STL/cstdint&gt;</span><span class="cp"></span></code>
<code></code>
<code><span class="cm">/** </span></code>
<code><span class="cm"> * @brief   Simple Moving Average filter.</span></code>
<code><span class="cm"> * </span></code>
<code><span class="cm"> * Returns the average of the N most recent input values.</span></code>
<code><span class="cm"> * </span></code>
<code><span class="cm"> * @f[</span></code>
<code><span class="cm"> * y[n] = \frac{1}{N} \sum_{i=0}^{N-1}x[n-i]</span></code>
<code><span class="cm"> * @f]</span></code>
<code><span class="cm"> * </span></code>
<code><span class="cm"> * @see     https://tttapa.github.io/Pages/Mathematics/Systems-and-Control-Theory/Digital-filters/Simple%20Moving%20Average/Simple-Moving-Average.html</span></code>
<code><span class="cm"> * </span></code>
<code><span class="cm"> * @tparam  N</span></code>
<code><span class="cm"> *          The number of samples to average.</span></code>
<code><span class="cm"> * @tparam  input_t</span></code>
<code><span class="cm"> *          The type of the input (and output) of the filter.</span></code>
<code><span class="cm"> * @tparam  sum_t</span></code>
<code><span class="cm"> *          The type to use for the accumulator, must be large enough to fit</span></code>
<code><span class="cm"> *          N times the maximum input value.</span></code>
<code><span class="cm"> */</span><span class="w"></span></code>
<code><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">input_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint16_t</span><span class="p">,</span><span class="w"> </span><span class="k">class</span> <span class="nc">sum_t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"></span></code>
<code><span class="k">class</span> <span class="nc">SMA</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="c1">/// Default constructor (initial state is initialized to all zeros).</span></code>
<code><span class="w">    </span><span class="n">SMA</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Constructor (initial state is initialized to given value).</span></code>
<code><span class="w">    </span><span class="c1">///</span></code>
<code><span class="w">    </span><span class="c1">/// @param  initialValue</span></code>
<code><span class="w">    </span><span class="c1">///         Determines the initial state of the filter:</span></code>
<code><span class="w">    </span><span class="c1">///         @f$ x[-N] =\ \ldots\ = x[-2] = x[-1] = \text{initialValue} @f$</span></code>
<code><span class="w">    </span><span class="c1">///</span></code>
<code><span class="w">    </span><span class="n">SMA</span><span class="p">(</span><span class="n">input_t</span><span class="w"> </span><span class="n">initialValue</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sum_t</span><span class="p">)</span><span class="n">initialValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">previousInputs</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">previousInputs</span><span class="p">),</span><span class="w"></span></code>
<code><span class="w">                  </span><span class="n">initialValue</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">    </span><span class="c1">/// Update the internal state with the new input @f$ x[n] @f$ and return the</span></code>
<code><span class="w">    </span><span class="c1">/// new output @f$ y[n] @f$.</span></code>
<code><span class="w">    </span><span class="c1">///</span></code>
<code><span class="w">    </span><span class="c1">/// @param  input</span></code>
<code><span class="w">    </span><span class="c1">///         The new input @f$ x[n] @f$.</span></code>
<code><span class="w">    </span><span class="c1">/// @return The new output @f$ y[n] @f$.</span></code>
<code><span class="w">    </span><span class="n">input_t</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">input_t</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">previousInputs</span><span class="p">[</span><span class="n">index</span><span class="p">];</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="n">previousInputs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AH</span><span class="o">::</span><span class="n">round_div</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sum</span><span class="p">);</span><span class="w"></span></code>
<code><span class="w">    </span><span class="p">}</span><span class="w"></span></code>
<code></code>
<code><span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span></code>
<code><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">input_t</span><span class="w"> </span><span class="n">previousInputs</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="w"> </span><span class="p">{};</span><span class="w"></span></code>
<code><span class="w">    </span><span class="n">sum_t</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span></code>
<code><span class="p">};</span><span class="w"></span></code></pre></div>
</div>

</div>
        <hr id="end-of-article">
        <div class="nextupprev"><div class="prevpage"><a href="Hardware.html" title="Hardware"><i class="material-icons" style="vertical-align: middle; text-decoration: none">chevron_left </i>Previous Page</a></div><div class="uppage"><a href="index.html" title="Motorized Faders">Index</a></div><div class="nextpage"></div></div>
    </article>
    <footer>Last edited: Monday, 19 July 2021 20:40 UTC</footer>
</body>

</html>
