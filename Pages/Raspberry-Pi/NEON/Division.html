<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Pieter P">
    <link rel="stylesheet" type="text/css" href="/CSS/Pages.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- No MathJax -->
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="theme-color" content="#ccc">
    <meta name="keywords" content="Division,NEON,integer,power of two,signed,unsigned,255,shift">
    <meta name="description" content="Snippets for dividing integers using NEON.">
    <title>Division</title>
    <script>
        function copyTextBelow(button) {
            const txt = button.nextElementSibling.innerText;
            navigator.clipboard.writeText(txt).then(() => {
                button.classList.add("copied");
                setTimeout(() => {
                    button.classList.remove("copied");
                }, 2000);
            }).catch(err => {
                console.error("Error copying text: ", err);
            });
        }
    </script>
<style id="MJX-CHTML-styles">
mjx-container[jax="CHTML"] {
  line-height: 0;
}

mjx-container [space="1"] {
  margin-left: .111em;
}

mjx-container [space="2"] {
  margin-left: .167em;
}

mjx-container [space="3"] {
  margin-left: .222em;
}

mjx-container [space="4"] {
  margin-left: .278em;
}

mjx-container [space="5"] {
  margin-left: .333em;
}

mjx-container [rspace="1"] {
  margin-right: .111em;
}

mjx-container [rspace="2"] {
  margin-right: .167em;
}

mjx-container [rspace="3"] {
  margin-right: .222em;
}

mjx-container [rspace="4"] {
  margin-right: .278em;
}

mjx-container [rspace="5"] {
  margin-right: .333em;
}

mjx-container [size="s"] {
  font-size: 70.7%;
}

mjx-container [size="ss"] {
  font-size: 50%;
}

mjx-container [size="Tn"] {
  font-size: 60%;
}

mjx-container [size="sm"] {
  font-size: 85%;
}

mjx-container [size="lg"] {
  font-size: 120%;
}

mjx-container [size="Lg"] {
  font-size: 144%;
}

mjx-container [size="LG"] {
  font-size: 173%;
}

mjx-container [size="hg"] {
  font-size: 207%;
}

mjx-container [size="HG"] {
  font-size: 249%;
}

mjx-container [width="full"] {
  width: 100%;
}

mjx-box {
  display: inline-block;
}

mjx-block {
  display: block;
}

mjx-itable {
  display: inline-table;
}

mjx-row {
  display: table-row;
}

mjx-row > * {
  display: table-cell;
}

mjx-mtext {
  display: inline-block;
  text-align: left;
}

mjx-mstyle {
  display: inline-block;
}

mjx-merror {
  display: inline-block;
  color: red;
  background-color: yellow;
}

mjx-mphantom {
  visibility: hidden;
}

_::-webkit-full-page-media, _:future, :root mjx-container {
  will-change: opacity;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-math {
  display: inline-block;
  text-align: left;
  line-height: 0;
  text-indent: 0;
  font-style: normal;
  font-weight: normal;
  font-size: 100%;
  font-size-adjust: none;
  letter-spacing: normal;
  border-collapse: collapse;
  word-wrap: normal;
  word-spacing: normal;
  white-space: nowrap;
  direction: ltr;
  padding: 1px 0;
}

mjx-container[jax="CHTML"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="CHTML"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="CHTML"][display="true"] mjx-math {
  padding: 0;
}

mjx-container[jax="CHTML"][justify="left"] {
  text-align: left;
}

mjx-container[jax="CHTML"][justify="right"] {
  text-align: right;
}

mjx-msup {
  display: inline-block;
  text-align: left;
}

mjx-mn {
  display: inline-block;
  text-align: left;
}

mjx-c {
  display: inline-block;
}

mjx-utext {
  display: inline-block;
  padding: .75em 0 .2em 0;
}

mjx-mi {
  display: inline-block;
  text-align: left;
}

mjx-mo {
  display: inline-block;
  text-align: left;
}

mjx-stretchy-h {
  display: inline-table;
  width: 100%;
}

mjx-stretchy-h > * {
  display: table-cell;
  width: 0;
}

mjx-stretchy-h > * > mjx-c {
  display: inline-block;
  transform: scalex(1.0000001);
}

mjx-stretchy-h > * > mjx-c::before {
  display: inline-block;
  width: initial;
}

mjx-stretchy-h > mjx-ext {
  /* IE */ overflow: hidden;
  /* others */ overflow: clip visible;
  width: 100%;
}

mjx-stretchy-h > mjx-ext > mjx-c::before {
  transform: scalex(500);
}

mjx-stretchy-h > mjx-ext > mjx-c {
  width: 0;
}

mjx-stretchy-h > mjx-beg > mjx-c {
  margin-right: -.1em;
}

mjx-stretchy-h > mjx-end > mjx-c {
  margin-left: -.1em;
}

mjx-stretchy-v {
  display: inline-block;
}

mjx-stretchy-v > * {
  display: block;
}

mjx-stretchy-v > mjx-beg {
  height: 0;
}

mjx-stretchy-v > mjx-end > mjx-c {
  display: block;
}

mjx-stretchy-v > * > mjx-c {
  transform: scaley(1.0000001);
  transform-origin: left center;
  overflow: hidden;
}

mjx-stretchy-v > mjx-ext {
  display: block;
  height: 100%;
  box-sizing: border-box;
  border: 0px solid transparent;
  /* IE */ overflow: hidden;
  /* others */ overflow: visible clip;
}

mjx-stretchy-v > mjx-ext > mjx-c::before {
  width: initial;
  box-sizing: border-box;
}

mjx-stretchy-v > mjx-ext > mjx-c {
  transform: scaleY(500) translateY(.075em);
  overflow: visible;
}

mjx-mark {
  display: inline-block;
  height: 0px;
}

mjx-TeXAtom {
  display: inline-block;
  text-align: left;
}

mjx-c::before {
  display: block;
  width: 0;
}

.MJX-TEX {
  font-family: MJXZERO, MJXTEX;
}

.TEX-B {
  font-family: MJXZERO, MJXTEX-B;
}

.TEX-I {
  font-family: MJXZERO, MJXTEX-I;
}

.TEX-MI {
  font-family: MJXZERO, MJXTEX-MI;
}

.TEX-BI {
  font-family: MJXZERO, MJXTEX-BI;
}

.TEX-S1 {
  font-family: MJXZERO, MJXTEX-S1;
}

.TEX-S2 {
  font-family: MJXZERO, MJXTEX-S2;
}

.TEX-S3 {
  font-family: MJXZERO, MJXTEX-S3;
}

.TEX-S4 {
  font-family: MJXZERO, MJXTEX-S4;
}

.TEX-A {
  font-family: MJXZERO, MJXTEX-A;
}

.TEX-C {
  font-family: MJXZERO, MJXTEX-C;
}

.TEX-CB {
  font-family: MJXZERO, MJXTEX-CB;
}

.TEX-FR {
  font-family: MJXZERO, MJXTEX-FR;
}

.TEX-FRB {
  font-family: MJXZERO, MJXTEX-FRB;
}

.TEX-SS {
  font-family: MJXZERO, MJXTEX-SS;
}

.TEX-SSB {
  font-family: MJXZERO, MJXTEX-SSB;
}

.TEX-SSI {
  font-family: MJXZERO, MJXTEX-SSI;
}

.TEX-SC {
  font-family: MJXZERO, MJXTEX-SC;
}

.TEX-T {
  font-family: MJXZERO, MJXTEX-T;
}

.TEX-V {
  font-family: MJXZERO, MJXTEX-V;
}

.TEX-VB {
  font-family: MJXZERO, MJXTEX-VB;
}

mjx-stretchy-v mjx-c, mjx-stretchy-h mjx-c {
  font-family: MJXZERO, MJXTEX-S1, MJXTEX-S4, MJXTEX, MJXTEX-A ! important;
}

@font-face /* 0 */ {
  font-family: MJXZERO;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Zero.woff") format("woff");
}

@font-face /* 1 */ {
  font-family: MJXTEX;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff") format("woff");
}

@font-face /* 2 */ {
  font-family: MJXTEX-B;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff") format("woff");
}

@font-face /* 3 */ {
  font-family: MJXTEX-I;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff") format("woff");
}

@font-face /* 4 */ {
  font-family: MJXTEX-MI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff") format("woff");
}

@font-face /* 5 */ {
  font-family: MJXTEX-BI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff") format("woff");
}

@font-face /* 6 */ {
  font-family: MJXTEX-S1;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff") format("woff");
}

@font-face /* 7 */ {
  font-family: MJXTEX-S2;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff") format("woff");
}

@font-face /* 8 */ {
  font-family: MJXTEX-S3;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff") format("woff");
}

@font-face /* 9 */ {
  font-family: MJXTEX-S4;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff") format("woff");
}

@font-face /* 10 */ {
  font-family: MJXTEX-A;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff") format("woff");
}

@font-face /* 11 */ {
  font-family: MJXTEX-C;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff") format("woff");
}

@font-face /* 12 */ {
  font-family: MJXTEX-CB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff") format("woff");
}

@font-face /* 13 */ {
  font-family: MJXTEX-FR;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff") format("woff");
}

@font-face /* 14 */ {
  font-family: MJXTEX-FRB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff") format("woff");
}

@font-face /* 15 */ {
  font-family: MJXTEX-SS;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff") format("woff");
}

@font-face /* 16 */ {
  font-family: MJXTEX-SSB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff") format("woff");
}

@font-face /* 17 */ {
  font-family: MJXTEX-SSI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff") format("woff");
}

@font-face /* 18 */ {
  font-family: MJXTEX-SC;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff") format("woff");
}

@font-face /* 19 */ {
  font-family: MJXTEX-T;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff") format("woff");
}

@font-face /* 20 */ {
  font-family: MJXTEX-V;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff") format("woff");
}

@font-face /* 21 */ {
  font-family: MJXTEX-VB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff") format("woff");
}

mjx-c.mjx-c32::before {
  padding: 0.666em 0.5em 0 0;
  content: "2";
}

mjx-c.mjx-c1D458.TEX-I::before {
  padding: 0.694em 0.521em 0.011em 0;
  content: "k";
}

mjx-c.mjx-c2212::before {
  padding: 0.583em 0.778em 0.082em 0;
  content: "\2212";
}

mjx-c.mjx-c37::before {
  padding: 0.676em 0.5em 0.022em 0;
  content: "7";
}

mjx-c.mjx-c2F::before {
  padding: 0.75em 0.5em 0.25em 0;
  content: "/";
}

mjx-c.mjx-c31::before {
  padding: 0.666em 0.5em 0 0;
  content: "1";
}

mjx-c.mjx-c36::before {
  padding: 0.666em 0.5em 0.022em 0;
  content: "6";
}

mjx-c.mjx-c30::before {
  padding: 0.666em 0.5em 0.022em 0;
  content: "0";
}

mjx-c.mjx-c226B::before {
  padding: 0.567em 1em 0.067em 0;
  content: "\226B";
}

mjx-c.mjx-c34::before {
  padding: 0.677em 0.5em 0 0;
  content: "4";
}

mjx-c.mjx-c1D7F6.TEX-T::before {
  padding: 0.621em 0.525em 0.01em 0;
  content: "0";
}

mjx-c.mjx-c1D6A1.TEX-T::before {
  padding: 0.431em 0.525em 0 0;
  content: "x";
}

mjx-c.mjx-c1D675.TEX-T::before {
  padding: 0.611em 0.525em 0 0;
  content: "F";
}

mjx-c.mjx-c1D687.TEX-T::before {
  padding: 0.611em 0.525em 0 0;
  content: "X";
}

mjx-c.mjx-c1D688.TEX-T::before {
  padding: 0.611em 0.525em 0 0;
  content: "Y";
}

mjx-c.mjx-c3D::before {
  padding: 0.583em 0.778em 0.082em 0;
  content: "=";
}

mjx-c.mjx-c1D7F7.TEX-T::before {
  padding: 0.622em 0.525em 0 0;
  content: "1";
}

mjx-c.mjx-c35::before {
  padding: 0.666em 0.5em 0.022em 0;
  content: "5";
}

mjx-c.mjx-c33::before {
  padding: 0.665em 0.5em 0.022em 0;
  content: "3";
}

mjx-c.mjx-c2C::before {
  padding: 0.121em 0.278em 0.194em 0;
  content: ",";
}

mjx-c.mjx-c21A6::before {
  padding: 0.511em 1em 0.011em 0;
  content: "\21A6";
}

mjx-c.mjx-c22C5::before {
  padding: 0.31em 0.278em 0 0;
  content: "\22C5";
}

mjx-c.mjx-c2248::before {
  padding: 0.483em 0.778em 0 0;
  content: "\2248";
}

mjx-c.mjx-c2E::before {
  padding: 0.12em 0.278em 0 0;
  content: ".";
}

mjx-c.mjx-c2260::before {
  padding: 0.716em 0.778em 0.215em 0;
  content: "\2260";
}

mjx-c.mjx-c1D7FE.TEX-T::before {
  padding: 0.621em 0.525em 0.01em 0;
  content: "8";
}

mjx-c.mjx-c39::before {
  padding: 0.666em 0.5em 0.022em 0;
  content: "9";
}

mjx-c.mjx-c38::before {
  padding: 0.666em 0.5em 0.022em 0;
  content: "8";
}

mjx-c.mjx-c25::before {
  padding: 0.75em 0.833em 0.056em 0;
  content: "%";
}

mjx-c.mjx-c3E::before {
  padding: 0.54em 0.778em 0.04em 0;
  content: ">";
}
</style></head>

<body>
    <nav>
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="position:absolute;top:4px;right: 4px;">
                <path d="M0 0h48v48h-48z" fill="none"></path>
                <path d="M6 36h36v-4h-36v4zm0-10h36v-4h-36v4zm0-14v4h36v-4h-36z"></path>
            </svg>
            <h2><a href="/Pages">Pages</a></h2>
<ul>
    <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../index.html">Raspberry Pi</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../Installation+Setup/index.html">Installation and Setup</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../Installation+Setup/Setting-up-Ubuntu.html">Installing and Setting up Ubuntu</a></li>
            <li><span class="ftriangle"></span><a class="" href="../Installation+Setup/WiFi-Setup.html">Setting up the WiFi Connection</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../Python-Development/index.html">Python Development</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../C++-Development-RPiOS/index.html">Ubuntu to Raspberry Pi OS Cross C++ Development</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development-RPiOS/Installation.html">Installation and Setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development-RPiOS/Development-setup.html">Development setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development-RPiOS/Building-example-project.html">Building the C++ example project</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development-RPiOS/Debugging.html">Remote debugging</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../C++-Development-Ubuntu/index.html">Ubuntu to Ubuntu Cross C++ Development</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../C++-Development/index.html">C++ Development using Docker</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development/Installation.html">Installation and setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development/Building-The-Toolchain.html">Building the Cross-Compilation Toolchain</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development/Dependencies.html">Cross-Compiling the Dependencies</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development/Installing-Dependencies.html">Installing the dependencies on the Pi</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development/Cpp-Program.html">Cross-Compiling the C++ Example Project</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development/Debugging.html">Debugging</a></li>
            <li><span class="ftriangle"></span><a class="" href="../C++-Development/Speedrun.html">Speedrun</a></li>
        </ul>
        </li>
        <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="index.html">NEON</a>
        <ul>
            <li><span class="ftriangle"></span><a class="openEntry " href="Division.html">Division</a></li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/index.html">Arduino</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/Audio-and-Signal-Processing/index.html">Audio and Signal Processing</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/Audio-and-Signal-Processing/VU-Meters/index.html">VU Meters</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Audio-and-Signal-Processing/VU-Meters/Model.html">Model of a moving-coil galvanometer</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Audio-and-Signal-Processing/VU-Meters/Damped-Harmonic-Oscillator.html">The Damped Harmonic Oscillator</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/Control-Surface/index.html">Control Surface</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/Control-Surface/Developers/index.html">Developers</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Surface/Developers/Installation.html">Installation</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Surface/Developers/Style.html">Style</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Surface/Developers/Tests.html">Tests</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Surface/Developers/Generating-Documentation.html">Generating Documentation</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/Control-Theory/index.html">Control Theory</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/index.html">Motorized Faders</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/PID-Controllers.html">1. PID Controllers</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/PID-Cpp-Implementation.html">2. C++ Implementation</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/PID-Tuning.html">3. PID Tuning</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/Architecture.html">4. Architecture and Design Decisions</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/Hardware.html">5. Hardware</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/Configuration.html">6. Configuration options and common use cases</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/Control-Theory/Motor-Fader/ATmega328P-Code.html">7. ATmega328P Code</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/Bootloaders/index.html">Bootloaders</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../Arduino/Bootloaders/ATmega328P-custom-frequency.html">Compiling Optiboot - ATmega328P at custom frequency</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/ESP8266/index.html">ESP8266</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Arduino/ESP8266/Flashing/index.html">Flashing</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Arduino/ESP8266/Flashing/Flashing-With-an-Arduino.html">Flashing the ESP8266 with an Arduino UNO</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/index.html">Mathematics &amp; Engineering</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/index.html">Systems and Control Theory</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Analog-Filters/index.html">Analog Filters &amp; Systems</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Analog-Filters/Butterworth-Filters.html">Butterworth Filters</a></li>
            </ul>
            </li>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/index.html">Digital Filters &amp; Systems</a>
            <ul>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/index.html">DTLTI Systems, Transfer Functions, and the Z-transform</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/DTLTI-Systems.html">DTLTI Systems</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/Impulse-and-Step-Response.html">Impulse and Step Response</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/Convolutions.html">Convolutions</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/The-Z-transform.html">The Z-transform</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/index.html">Exponential Moving Average</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/Exponential-Moving-Average.html">Exponential Moving Average</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/Filtering-in-MATLAB.html">Filtering in MATLAB</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/C++Implementation.html">C++ Implementation</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/index.html">Simple Moving Average</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/Simple-Moving-Average.html">Simple Moving Average</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/C++Implementation.html">C++ Implementation</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/index.html">Discretization</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/Bilinear-transform.html">Bilinear Transform</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/Discretization-of-a-fourth-order-Butterworth-filter.html">Discretization of a Fourth-Order Butterworth Filter</a></li>
                </ul>
                </li>
                <li><span class="ftriangle"></span><a class="" href="../../Mathematics/Systems-and-Control-Theory/Digital-filters/FIR-Notch.html">Simple Finite Impulse Response Notch Filter</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Programming/index.html">Programming</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Programming/Snippets/index.html">Snippets</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Programming/Cpp/index.html">C++</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Programming/Cpp/Practices/index.html">Best Practices</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Programming/Cpp/Practices/type-punning.html">Don't use unions or pointer casts for type punning</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Programming/Cpp/Practices/c-style-casts.html">Don't use C-style casts</a></li>
            </ul>
            </li>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Programming/Cpp/Algorithms/index.html">Algorithms</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Programming/Cpp/Algorithms/Max_n_elements.html">Maximum N elements</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Ubuntu/index.html">Ubuntu</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Ubuntu/Software-Installation/index.html">Software Installation</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Installing-Locally.html">Installing Locally</a></li>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../Ubuntu/Software-Installation/Arduino/index.html">Arduino</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Arduino/Arduino-IDE.html">Arduino IDE</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Arduino/Hairless-MIDI.html">The Hairless MIDI to Serial Bridge</a></li>
            </ul>
            </li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/BlueZ.html">BlueZ with MIDI over BLE Support</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Doxygen.html">Doxygen</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Eclipse.html">Eclipse</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Eigen3.html">Eigen</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/GoogleTest.html">GoogleTest</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Java.html">Java</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/Python.html">Python</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../Ubuntu/Software-Installation/VirtualBox.html">VirtualBox</a></li>
        </ul>
        </li>
    </ul>
    </li>
</ul>

            <i class="material-icons">
                <a href="/" title="Home">home</a>
            </i>
            <i class="material-icons">
                <a href="Division.pdf" title="Download as PDF">get_app</a>
            </i>
            <!-- <i class="material-icons">
                <a href="javascript:window.print()" title="Print this article" onclick="window.print(); return false;">print</a>
            </i> -->
            <i class="material-icons">
                <a href="https://github.com/tttapa/tttapa.github.io/issues/new" target="_blank" title="Comment or open an issue">feedback</a>
            </i>
        </div>
    </nav>
    <article>
        <h1 class="title">Division</h1>
        <i class="author">Pieter P</i>
        <div class="main-content">
<div class="toc" id="toc">
  <script>
  function updateTocSize() {
    let toc = document.getElementById("toc");
    toc.style.maxHeight = toc.scrollHeight + 'px';
  }
  </script>  <h4 class="toc" onclick="if (this.parentElement.classList.toggle('expanded')) {updateTocSize();window.addEventListener('resize', updateTocSize);} else {this.parentElement.style = undefined;window.removeEventListener('resize', updateTocSize);}">Table of Contents <i class="material-icons">list</i></h4>
  <ul>
        <li><a href="#dividing-by-powers-of-two">Dividing by powers of two</a></li>
          <ul>
            <li><a href="#unsigned-integers">Unsigned integers</a></li>
              <ul>
                <li><a href="#flooring">Flooring</a></li>
                <li><a href="#rounding">Rounding</a></li>
              </ul>
            <li><a href="#signed-integers">Signed integers</a></li>
              <ul>
                <li><a href="#flooring1">Flooring</a></li>
                <li><a href="#rounding1">Rounding</a></li>
              </ul>
          </ul>
        <li><a href="#dividing-by-255">Dividing by 255</a></li>
          <ul>
            <li><a href="#approximating-by-a-division-by-256">Approximating by a division by 256</a></li>
            <li><a href="#true-division-by-255">True division by 255</a></li>
              <ul>
                <li><a href="#flooring2">Flooring</a></li>
                <li><a href="#rounding2">Rounding</a></li>
                </ul>
            </ul>
  </ul></div>


<p>
    NEON doesn't have any integer division instructions, because they are expensive to implement in hardware. Luckily,
    you can often replace divisions by other instructions, like bit shifts and multiplications.
</p>

<h2><a name="dividing-by-powers-of-two" href="#dividing-by-powers-of-two">Dividing by powers of two</a></h2>

<h3><a name="unsigned-integers" href="#unsigned-integers">Unsigned integers</a></h3>

<h4><a name="flooring" href="#flooring">Flooring</a></h4>

<p>
    To divide an unsigned integer by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-msup><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c></mjx-mn><mjx-script style="vertical-align: 0.363em;"><mjx-mi class="mjx-i" size="s"><mjx-c class="mjx-c1D458 TEX-I"></mjx-c></mjx-mi></mjx-script></mjx-msup></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mi>k</mi></msup></math></mjx-assistive-mml></mjx-container>, you can just use a bit shift by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mi class="mjx-i"><mjx-c class="mjx-c1D458 TEX-I"></mjx-c></mjx-mi></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi></math></mjx-assistive-mml></mjx-container> bits to the right.
</p>

<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments27 .hll { background-color: #ffffcc }
.pygments27 { background: #ffffff; }
.pygments27 .c { color: #008000 } /* Comment */
.pygments27 .err { border: 1px solid #FF0000 } /* Error */
.pygments27 .k { color: #0000ff } /* Keyword */
.pygments27 .l { color: #0000FF } /* Literal */
.pygments27 .ch { color: #008000 } /* Comment.Hashbang */
.pygments27 .cm { color: #008000 } /* Comment.Multiline */
.pygments27 .cp { color: #af00db } /* Comment.Preproc */
.pygments27 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments27 .c1 { color: #008000 } /* Comment.Single */
.pygments27 .cs { color: #008000 } /* Comment.Special */
.pygments27 .ge { font-style: italic } /* Generic.Emph */
.pygments27 .gh { font-weight: bold } /* Generic.Heading */
.pygments27 .gp { font-weight: bold } /* Generic.Prompt */
.pygments27 .gs { font-weight: bold } /* Generic.Strong */
.pygments27 .gu { font-weight: bold } /* Generic.Subheading */
.pygments27 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments27 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments27 .kn { color: #af00db } /* Keyword.Namespace */
.pygments27 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments27 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments27 .kt { color: #2b91af } /* Keyword.Type */
.pygments27 .ld { color: #0000FF } /* Literal.Date */
.pygments27 .m { color: #0000FF } /* Literal.Number */
.pygments27 .s { color: #a31515 } /* Literal.String */
.pygments27 .na { color: #001080 } /* Name.Attribute */
.pygments27 .nb { color: #795e26 } /* Name.Builtin */
.pygments27 .nc { color: #2b91af } /* Name.Class */
.pygments27 .no { color: #0000FF } /* Name.Constant */
.pygments27 .nf { color: #795e26 } /* Name.Function */
.pygments27 .nl { color: #AF00DB } /* Name.Label */
.pygments27 .nn { color: #000000 } /* Name.Namespace */
.pygments27 .nt { color: #800000 } /* Name.Tag */
.pygments27 .nv { color: #0F1E87 } /* Name.Variable */
.pygments27 .ow { color: #0000ff } /* Operator.Word */
.pygments27 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments27 .mf { color: #09885a } /* Literal.Number.Float */
.pygments27 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments27 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments27 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments27 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments27 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments27 .sc { color: #a31515 } /* Literal.String.Char */
.pygments27 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments27 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments27 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments27 .se { color: #a31515 } /* Literal.String.Escape */
.pygments27 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments27 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments27 .sx { color: #a31515 } /* Literal.String.Other */
.pygments27 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments27 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments27 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments27 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments27 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments27 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments27 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments27 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments27 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments27 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments27 pre.snippet27 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_16_unsigned.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments27"><pre class="lineNumbers snippet27"><code><span></span><span class="kt">uint16_t</span><span class="w"> </span><span class="nf">div_by_16_a</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span></code>
<code><span class="p">}</span></code>
<code></code>
<code><span class="kt">uint16_t</span><span class="w"> </span><span class="nf">div_by_16_b</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code></pre></div>
</div>

<p>
    Of course, any half-decent compiler will produce the same instructions for both of the functions above, so it's much
    better to write <code>x / 16</code>, because it clearly shows your intent.
</p>

<p>
    To write the same division for NEON, you can use the <code>vshr_n_u16</code> intrinsic:
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments39 .hll { background-color: #ffffcc }
.pygments39 { background: #ffffff; }
.pygments39 .c { color: #008000 } /* Comment */
.pygments39 .err { border: 1px solid #FF0000 } /* Error */
.pygments39 .k { color: #0000ff } /* Keyword */
.pygments39 .l { color: #0000FF } /* Literal */
.pygments39 .ch { color: #008000 } /* Comment.Hashbang */
.pygments39 .cm { color: #008000 } /* Comment.Multiline */
.pygments39 .cp { color: #af00db } /* Comment.Preproc */
.pygments39 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments39 .c1 { color: #008000 } /* Comment.Single */
.pygments39 .cs { color: #008000 } /* Comment.Special */
.pygments39 .ge { font-style: italic } /* Generic.Emph */
.pygments39 .gh { font-weight: bold } /* Generic.Heading */
.pygments39 .gp { font-weight: bold } /* Generic.Prompt */
.pygments39 .gs { font-weight: bold } /* Generic.Strong */
.pygments39 .gu { font-weight: bold } /* Generic.Subheading */
.pygments39 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments39 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments39 .kn { color: #af00db } /* Keyword.Namespace */
.pygments39 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments39 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments39 .kt { color: #2b91af } /* Keyword.Type */
.pygments39 .ld { color: #0000FF } /* Literal.Date */
.pygments39 .m { color: #0000FF } /* Literal.Number */
.pygments39 .s { color: #a31515 } /* Literal.String */
.pygments39 .na { color: #001080 } /* Name.Attribute */
.pygments39 .nb { color: #795e26 } /* Name.Builtin */
.pygments39 .nc { color: #2b91af } /* Name.Class */
.pygments39 .no { color: #0000FF } /* Name.Constant */
.pygments39 .nf { color: #795e26 } /* Name.Function */
.pygments39 .nl { color: #AF00DB } /* Name.Label */
.pygments39 .nn { color: #000000 } /* Name.Namespace */
.pygments39 .nt { color: #800000 } /* Name.Tag */
.pygments39 .nv { color: #0F1E87 } /* Name.Variable */
.pygments39 .ow { color: #0000ff } /* Operator.Word */
.pygments39 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments39 .mf { color: #09885a } /* Literal.Number.Float */
.pygments39 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments39 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments39 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments39 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments39 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments39 .sc { color: #a31515 } /* Literal.String.Char */
.pygments39 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments39 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments39 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments39 .se { color: #a31515 } /* Literal.String.Escape */
.pygments39 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments39 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments39 .sx { color: #a31515 } /* Literal.String.Other */
.pygments39 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments39 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments39 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments39 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments39 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments39 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments39 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments39 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments39 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments39 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments39 pre.snippet39 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_16_unsigned_vector.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments39"><pre class="lineNumbers snippet39"><code><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;arm_neon.h&gt;</span></code>
<code></code>
<code><span class="n">uint16x4_t</span><span class="w"> </span><span class="nf">div_by_16</span><span class="p">(</span><span class="n">uint16x4_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshr_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code>
<code></code>
<code><span class="n">uint16x8_t</span><span class="w"> </span><span class="nf">div_by_16</span><span class="p">(</span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshrq_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code></pre></div>
</div>
<p>
    The name is derived from <u>v</u>ector <u>sh</u>ift <u>r</u>ight, <code>n</code> indicates a fixed number of bits is
    used, and <code>u16</code> is the type of elements in the vector (16-bit unsigned integers in this example).<br>
    There are two versions, the one without the <code>q</code> suffix operates on double-word vector registers (2×32
    bits), and the one with the <code>q</code> suffix operates on quad-word vector registers (4×32 bits).
</p>

<h4><a name="rounding" href="#rounding">Rounding</a></h4>

<p>
    NEON also has instructions for rounding right shifts, for example, <code>vrshr_n_u16</code> (note the <code>r</code>
    prefix):
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments55 .hll { background-color: #ffffcc }
.pygments55 { background: #ffffff; }
.pygments55 .c { color: #008000 } /* Comment */
.pygments55 .err { border: 1px solid #FF0000 } /* Error */
.pygments55 .k { color: #0000ff } /* Keyword */
.pygments55 .l { color: #0000FF } /* Literal */
.pygments55 .ch { color: #008000 } /* Comment.Hashbang */
.pygments55 .cm { color: #008000 } /* Comment.Multiline */
.pygments55 .cp { color: #af00db } /* Comment.Preproc */
.pygments55 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments55 .c1 { color: #008000 } /* Comment.Single */
.pygments55 .cs { color: #008000 } /* Comment.Special */
.pygments55 .ge { font-style: italic } /* Generic.Emph */
.pygments55 .gh { font-weight: bold } /* Generic.Heading */
.pygments55 .gp { font-weight: bold } /* Generic.Prompt */
.pygments55 .gs { font-weight: bold } /* Generic.Strong */
.pygments55 .gu { font-weight: bold } /* Generic.Subheading */
.pygments55 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments55 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments55 .kn { color: #af00db } /* Keyword.Namespace */
.pygments55 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments55 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments55 .kt { color: #2b91af } /* Keyword.Type */
.pygments55 .ld { color: #0000FF } /* Literal.Date */
.pygments55 .m { color: #0000FF } /* Literal.Number */
.pygments55 .s { color: #a31515 } /* Literal.String */
.pygments55 .na { color: #001080 } /* Name.Attribute */
.pygments55 .nb { color: #795e26 } /* Name.Builtin */
.pygments55 .nc { color: #2b91af } /* Name.Class */
.pygments55 .no { color: #0000FF } /* Name.Constant */
.pygments55 .nf { color: #795e26 } /* Name.Function */
.pygments55 .nl { color: #AF00DB } /* Name.Label */
.pygments55 .nn { color: #000000 } /* Name.Namespace */
.pygments55 .nt { color: #800000 } /* Name.Tag */
.pygments55 .nv { color: #0F1E87 } /* Name.Variable */
.pygments55 .ow { color: #0000ff } /* Operator.Word */
.pygments55 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments55 .mf { color: #09885a } /* Literal.Number.Float */
.pygments55 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments55 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments55 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments55 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments55 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments55 .sc { color: #a31515 } /* Literal.String.Char */
.pygments55 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments55 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments55 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments55 .se { color: #a31515 } /* Literal.String.Escape */
.pygments55 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments55 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments55 .sx { color: #a31515 } /* Literal.String.Other */
.pygments55 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments55 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments55 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments55 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments55 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments55 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments55 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments55 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments55 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments55 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments55 pre.snippet55 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_16_unsigned_vector_round.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments55"><pre class="lineNumbers snippet55"><code><span></span><span class="n">uint16x8_t</span><span class="w"> </span><span class="nf">div_by_16_round</span><span class="p">(</span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vrshrq_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code></pre></div>
</div>

<h3><a name="signed-integers" href="#signed-integers">Signed integers</a></h3>

<h4><a name="flooring1" href="#flooring1">Flooring</a></h4>

<p>
    Dividing signed integers by a power of two is a little bit trickier than dividing unsigned integers, because you
    cannot simply use a bit shift.
    Consider <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n"><mjx-c class="mjx-c37"></mjx-c></mjx-mn><mjx-TeXAtom texclass="ORD"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2F"></mjx-c></mjx-mo></mjx-TeXAtom><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>−</mo><mn>7</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mn>16</mn></math></mjx-assistive-mml></mjx-container> as an example: you would expect the result to be <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c30"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>0</mn></math></mjx-assistive-mml></mjx-container>. However, <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n"><mjx-c class="mjx-c37"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c226B"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c34"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>−</mo><mn>7</mn><mo>≫</mo><mn>4</mn></math></mjx-assistive-mml></mjx-container> turns out to be
    <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>−</mo><mn>1</mn></math></mjx-assistive-mml></mjx-container>.
</p>
<p>
    To get around this problem, you have to add the divisor minus one if the dividend is negative:
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments72 .hll { background-color: #ffffcc }
.pygments72 { background: #ffffff; }
.pygments72 .c { color: #008000 } /* Comment */
.pygments72 .err { border: 1px solid #FF0000 } /* Error */
.pygments72 .k { color: #0000ff } /* Keyword */
.pygments72 .l { color: #0000FF } /* Literal */
.pygments72 .ch { color: #008000 } /* Comment.Hashbang */
.pygments72 .cm { color: #008000 } /* Comment.Multiline */
.pygments72 .cp { color: #af00db } /* Comment.Preproc */
.pygments72 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments72 .c1 { color: #008000 } /* Comment.Single */
.pygments72 .cs { color: #008000 } /* Comment.Special */
.pygments72 .ge { font-style: italic } /* Generic.Emph */
.pygments72 .gh { font-weight: bold } /* Generic.Heading */
.pygments72 .gp { font-weight: bold } /* Generic.Prompt */
.pygments72 .gs { font-weight: bold } /* Generic.Strong */
.pygments72 .gu { font-weight: bold } /* Generic.Subheading */
.pygments72 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments72 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments72 .kn { color: #af00db } /* Keyword.Namespace */
.pygments72 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments72 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments72 .kt { color: #2b91af } /* Keyword.Type */
.pygments72 .ld { color: #0000FF } /* Literal.Date */
.pygments72 .m { color: #0000FF } /* Literal.Number */
.pygments72 .s { color: #a31515 } /* Literal.String */
.pygments72 .na { color: #001080 } /* Name.Attribute */
.pygments72 .nb { color: #795e26 } /* Name.Builtin */
.pygments72 .nc { color: #2b91af } /* Name.Class */
.pygments72 .no { color: #0000FF } /* Name.Constant */
.pygments72 .nf { color: #795e26 } /* Name.Function */
.pygments72 .nl { color: #AF00DB } /* Name.Label */
.pygments72 .nn { color: #000000 } /* Name.Namespace */
.pygments72 .nt { color: #800000 } /* Name.Tag */
.pygments72 .nv { color: #0F1E87 } /* Name.Variable */
.pygments72 .ow { color: #0000ff } /* Operator.Word */
.pygments72 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments72 .mf { color: #09885a } /* Literal.Number.Float */
.pygments72 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments72 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments72 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments72 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments72 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments72 .sc { color: #a31515 } /* Literal.String.Char */
.pygments72 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments72 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments72 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments72 .se { color: #a31515 } /* Literal.String.Escape */
.pygments72 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments72 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments72 .sx { color: #a31515 } /* Literal.String.Other */
.pygments72 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments72 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments72 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments72 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments72 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments72 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments72 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments72 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments72 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments72 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments72 pre.snippet72 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_16_signed.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments72"><pre class="lineNumbers snippet72"><code><span></span><span class="kt">int16_t</span><span class="w"> </span><span class="nf">div_by_16_a</span><span class="p">(</span><span class="kt">int16_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span></code>
<code><span class="p">}</span></code>
<code></code>
<code><span class="kt">int16_t</span><span class="w"> </span><span class="nf">div_by_16_b</span><span class="p">(</span><span class="kt">int16_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span></code>
<code><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code></pre></div>
</div>

<p>
    NEON doesn't have any conditional instructions, but it does have compare instructions that can be used to generate
    a mask.
    The compare instructions return either all zeros (<mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x0000</mtext></math></mjx-assistive-mml></mjx-container>) or all ones (<mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0xFFFF</mtext></math></mjx-assistive-mml></mjx-container>), so by
    using a bitwise AND, they can be used to conditionally enable or disable the correction term.
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments82 .hll { background-color: #ffffcc }
.pygments82 { background: #ffffff; }
.pygments82 .c { color: #008000 } /* Comment */
.pygments82 .err { border: 1px solid #FF0000 } /* Error */
.pygments82 .k { color: #0000ff } /* Keyword */
.pygments82 .l { color: #0000FF } /* Literal */
.pygments82 .ch { color: #008000 } /* Comment.Hashbang */
.pygments82 .cm { color: #008000 } /* Comment.Multiline */
.pygments82 .cp { color: #af00db } /* Comment.Preproc */
.pygments82 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments82 .c1 { color: #008000 } /* Comment.Single */
.pygments82 .cs { color: #008000 } /* Comment.Special */
.pygments82 .ge { font-style: italic } /* Generic.Emph */
.pygments82 .gh { font-weight: bold } /* Generic.Heading */
.pygments82 .gp { font-weight: bold } /* Generic.Prompt */
.pygments82 .gs { font-weight: bold } /* Generic.Strong */
.pygments82 .gu { font-weight: bold } /* Generic.Subheading */
.pygments82 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments82 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments82 .kn { color: #af00db } /* Keyword.Namespace */
.pygments82 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments82 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments82 .kt { color: #2b91af } /* Keyword.Type */
.pygments82 .ld { color: #0000FF } /* Literal.Date */
.pygments82 .m { color: #0000FF } /* Literal.Number */
.pygments82 .s { color: #a31515 } /* Literal.String */
.pygments82 .na { color: #001080 } /* Name.Attribute */
.pygments82 .nb { color: #795e26 } /* Name.Builtin */
.pygments82 .nc { color: #2b91af } /* Name.Class */
.pygments82 .no { color: #0000FF } /* Name.Constant */
.pygments82 .nf { color: #795e26 } /* Name.Function */
.pygments82 .nl { color: #AF00DB } /* Name.Label */
.pygments82 .nn { color: #000000 } /* Name.Namespace */
.pygments82 .nt { color: #800000 } /* Name.Tag */
.pygments82 .nv { color: #0F1E87 } /* Name.Variable */
.pygments82 .ow { color: #0000ff } /* Operator.Word */
.pygments82 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments82 .mf { color: #09885a } /* Literal.Number.Float */
.pygments82 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments82 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments82 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments82 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments82 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments82 .sc { color: #a31515 } /* Literal.String.Char */
.pygments82 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments82 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments82 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments82 .se { color: #a31515 } /* Literal.String.Escape */
.pygments82 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments82 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments82 .sx { color: #a31515 } /* Literal.String.Other */
.pygments82 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments82 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments82 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments82 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments82 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments82 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments82 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments82 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments82 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments82 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments82 pre.snippet82 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_16_signed_vector.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments82"><pre class="lineNumbers snippet82"><code><span></span><span class="n">int16x8_t</span><span class="w"> </span><span class="nf">div_by_16</span><span class="p">(</span><span class="n">int16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="n">int16x8_t</span><span class="w"> </span><span class="n">negative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcltzq_s16</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// compare less than zero</span></code>
<code><span class="w">    </span><span class="n">int16x8_t</span><span class="w"> </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vdupq_n_s16</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vandq_s16</span><span class="p">(</span><span class="n">negative</span><span class="p">,</span><span class="w"> </span><span class="n">correction</span><span class="p">);</span><span class="w"> </span><span class="c1">// only add correction if &lt; 0</span></code>
<code><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vaddq_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">correction</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshrq_n_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code></pre></div>
</div>
<p>
    In this snippet, <code>vdupq_n_s16</code> is used to duplicate a single value across all lanes of a vector register.
    Sadly, we cannot use the correction (<mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="3"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="3"><mjx-c class="mjx-c31"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>16</mn><mo>−</mo><mn>1</mn></math></mjx-assistive-mml></mjx-container>) as an immediate argument to the AND instruction, because you can only
    set one of the bytes of the immediate value at a time. The other byte is always implicitly <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0xFF</mtext></math></mjx-assistive-mml></mjx-container>. In
    other words, the only possible immediate operands to AND for 16-bit numbers are <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D687 TEX-T"></mjx-c><mjx-c class="mjx-c1D688 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0xFFXY</mtext></math></mjx-assistive-mml></mjx-container> and
    <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D687 TEX-T"></mjx-c><mjx-c class="mjx-c1D688 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0xXYFF</mtext></math></mjx-assistive-mml></mjx-container>. <br>
    <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="3"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="3"><mjx-c class="mjx-c31"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c3D"></mjx-c></mjx-mo><mjx-mtext class="mjx-ty" space="4"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>16</mn><mo>−</mo><mn>1</mn><mo>=</mo><mtext mathvariant="monospace">0x000F</mtext></math></mjx-assistive-mml></mjx-container> doesn't fit this pattern. However, <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="3"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="3"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c3D"></mjx-c></mjx-mo><mjx-mtext class="mjx-ty" space="4"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F7 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mo>−</mo><mn>16</mn><mo>=</mo><mtext mathvariant="monospace">0xFFF1</mtext></math></mjx-assistive-mml></mjx-container> does. By replacing the
    addition of 15 by a subtraction of -15, we can save one move instruction (<code>vdupq_n_s16</code>), and use an
    immediate AND instruction instead.
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments95 .hll { background-color: #ffffcc }
.pygments95 { background: #ffffff; }
.pygments95 .c { color: #008000 } /* Comment */
.pygments95 .err { border: 1px solid #FF0000 } /* Error */
.pygments95 .k { color: #0000ff } /* Keyword */
.pygments95 .l { color: #0000FF } /* Literal */
.pygments95 .ch { color: #008000 } /* Comment.Hashbang */
.pygments95 .cm { color: #008000 } /* Comment.Multiline */
.pygments95 .cp { color: #af00db } /* Comment.Preproc */
.pygments95 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments95 .c1 { color: #008000 } /* Comment.Single */
.pygments95 .cs { color: #008000 } /* Comment.Special */
.pygments95 .ge { font-style: italic } /* Generic.Emph */
.pygments95 .gh { font-weight: bold } /* Generic.Heading */
.pygments95 .gp { font-weight: bold } /* Generic.Prompt */
.pygments95 .gs { font-weight: bold } /* Generic.Strong */
.pygments95 .gu { font-weight: bold } /* Generic.Subheading */
.pygments95 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments95 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments95 .kn { color: #af00db } /* Keyword.Namespace */
.pygments95 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments95 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments95 .kt { color: #2b91af } /* Keyword.Type */
.pygments95 .ld { color: #0000FF } /* Literal.Date */
.pygments95 .m { color: #0000FF } /* Literal.Number */
.pygments95 .s { color: #a31515 } /* Literal.String */
.pygments95 .na { color: #001080 } /* Name.Attribute */
.pygments95 .nb { color: #795e26 } /* Name.Builtin */
.pygments95 .nc { color: #2b91af } /* Name.Class */
.pygments95 .no { color: #0000FF } /* Name.Constant */
.pygments95 .nf { color: #795e26 } /* Name.Function */
.pygments95 .nl { color: #AF00DB } /* Name.Label */
.pygments95 .nn { color: #000000 } /* Name.Namespace */
.pygments95 .nt { color: #800000 } /* Name.Tag */
.pygments95 .nv { color: #0F1E87 } /* Name.Variable */
.pygments95 .ow { color: #0000ff } /* Operator.Word */
.pygments95 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments95 .mf { color: #09885a } /* Literal.Number.Float */
.pygments95 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments95 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments95 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments95 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments95 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments95 .sc { color: #a31515 } /* Literal.String.Char */
.pygments95 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments95 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments95 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments95 .se { color: #a31515 } /* Literal.String.Escape */
.pygments95 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments95 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments95 .sx { color: #a31515 } /* Literal.String.Other */
.pygments95 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments95 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments95 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments95 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments95 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments95 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments95 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments95 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments95 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments95 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments95 pre.snippet95 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_16_signed_vector_immediate.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments95"><pre class="lineNumbers snippet95"><code><span></span><span class="cp">#define vandq_n_u16(a, b)                                                      \</span></code>
<code><span class="cp">    __extension__({                                                            \</span></code>
<code><span class="cp">        uint16x8_t a_ = (a);                                                   \</span></code>
<code><span class="cp">        uint16_t b_ = ~(b);                                                    \</span></code>
<code><span class="cp">        __asm__("bic %0.8h, #%1" : "+w"(a_) : "i"(b_) : </span><span class="cm">/* No clobbers */</span><span class="cp">);    \</span></code>
<code><span class="cp">        a_;                                                                    \</span></code>
<code><span class="cp">    })</span></code>
<code></code>
<code><span class="n">int16x8_t</span><span class="w"> </span><span class="nf">div_by_16</span><span class="p">(</span><span class="n">int16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">negative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcltzq_s16</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// compare less than zero</span></code>
<code><span class="w">    </span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vandq_n_u16</span><span class="p">(</span><span class="n">negative</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vsubq_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">correction</span><span class="p">));</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshrq_n_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code></pre></div>
</div>
<p>
    There is no actual AND instruction, the BIC (bit clear) instruction is used instead. There's no intrinsic for it, so
    we have to add a line of inline assembly. A compiler extension is used, because parameter <code>b</code> should be 
    a compile-time constant, it is used to compute the immediate field of the instruction, so it cannot change at 
    run-time.
</p>
<p>
    This trick will only work for divisors less than or equal to 256, since the immediate field of the BIC instruction
    is only 8 bits wide. For divisors 512 and larger, the correction term will be 9 bits or more, so it doesn't fit 
    anymore. Luckily, in that case, the low byte of the correction term will always be <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0xFF</mtext></math></mjx-assistive-mml></mjx-container>, which means 
    that we can use the second variant of the immediate AND, where the immediate is <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D687 TEX-T"></mjx-c><mjx-c class="mjx-c1D688 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0xXYFF</mtext></math></mjx-assistive-mml></mjx-container>. In practice,
    this is done by setting the LSL (logical shift left) amount of the BIC instruction to 8, so we can set the high 
    byte of the immediate.
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments112 .hll { background-color: #ffffcc }
.pygments112 { background: #ffffff; }
.pygments112 .c { color: #008000 } /* Comment */
.pygments112 .err { border: 1px solid #FF0000 } /* Error */
.pygments112 .k { color: #0000ff } /* Keyword */
.pygments112 .l { color: #0000FF } /* Literal */
.pygments112 .ch { color: #008000 } /* Comment.Hashbang */
.pygments112 .cm { color: #008000 } /* Comment.Multiline */
.pygments112 .cp { color: #af00db } /* Comment.Preproc */
.pygments112 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments112 .c1 { color: #008000 } /* Comment.Single */
.pygments112 .cs { color: #008000 } /* Comment.Special */
.pygments112 .ge { font-style: italic } /* Generic.Emph */
.pygments112 .gh { font-weight: bold } /* Generic.Heading */
.pygments112 .gp { font-weight: bold } /* Generic.Prompt */
.pygments112 .gs { font-weight: bold } /* Generic.Strong */
.pygments112 .gu { font-weight: bold } /* Generic.Subheading */
.pygments112 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments112 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments112 .kn { color: #af00db } /* Keyword.Namespace */
.pygments112 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments112 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments112 .kt { color: #2b91af } /* Keyword.Type */
.pygments112 .ld { color: #0000FF } /* Literal.Date */
.pygments112 .m { color: #0000FF } /* Literal.Number */
.pygments112 .s { color: #a31515 } /* Literal.String */
.pygments112 .na { color: #001080 } /* Name.Attribute */
.pygments112 .nb { color: #795e26 } /* Name.Builtin */
.pygments112 .nc { color: #2b91af } /* Name.Class */
.pygments112 .no { color: #0000FF } /* Name.Constant */
.pygments112 .nf { color: #795e26 } /* Name.Function */
.pygments112 .nl { color: #AF00DB } /* Name.Label */
.pygments112 .nn { color: #000000 } /* Name.Namespace */
.pygments112 .nt { color: #800000 } /* Name.Tag */
.pygments112 .nv { color: #0F1E87 } /* Name.Variable */
.pygments112 .ow { color: #0000ff } /* Operator.Word */
.pygments112 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments112 .mf { color: #09885a } /* Literal.Number.Float */
.pygments112 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments112 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments112 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments112 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments112 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments112 .sc { color: #a31515 } /* Literal.String.Char */
.pygments112 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments112 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments112 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments112 .se { color: #a31515 } /* Literal.String.Escape */
.pygments112 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments112 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments112 .sx { color: #a31515 } /* Literal.String.Other */
.pygments112 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments112 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments112 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments112 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments112 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments112 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments112 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments112 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments112 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments112 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments112 pre.snippet112 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_512_signed_vector_immediate.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments112"><pre class="lineNumbers snippet112"><code><span></span><span class="cp">#define vandq_n_high_u16(a, b)                                                 \</span></code>
<code><span class="cp">    __extension__({                                                            \</span></code>
<code><span class="cp">        uint16x8_t a_ = (a);                                                   \</span></code>
<code><span class="cp">        uint16_t b_ = (~(b)) &gt;&gt; 8;                                             \</span></code>
<code><span class="cp">        __asm__("bic %0.8h, #%1, LSL #8" : "+w"(a_) : "i"(b_) :);              \</span></code>
<code><span class="cp">        a_;                                                                    \</span></code>
<code><span class="cp">    })</span></code>
<code></code>
<code><span class="n">int16x8_t</span><span class="w"> </span><span class="nf">div_by_512</span><span class="p">(</span><span class="n">int16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">negative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcltzq_s16</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// compare less than zero</span></code>
<code><span class="w">    </span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vandq_n_high_u16</span><span class="p">(</span><span class="n">negative</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vaddq_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">correction</span><span class="p">));</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshrq_n_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span><span class="w"> </span><span class="c1">// 512 = 2⁹</span></code>
<code><span class="p">}</span></code></pre></div>
</div>

<h4><a name="rounding1" href="#rounding1">Rounding</a></h4>

<p>
    For the rounding division by a power of two, we'll again use the rounding right shift. If the dividend is negative,
    we still need a correction. This time we just have to subtract one as a correction.
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments122 .hll { background-color: #ffffcc }
.pygments122 { background: #ffffff; }
.pygments122 .c { color: #008000 } /* Comment */
.pygments122 .err { border: 1px solid #FF0000 } /* Error */
.pygments122 .k { color: #0000ff } /* Keyword */
.pygments122 .l { color: #0000FF } /* Literal */
.pygments122 .ch { color: #008000 } /* Comment.Hashbang */
.pygments122 .cm { color: #008000 } /* Comment.Multiline */
.pygments122 .cp { color: #af00db } /* Comment.Preproc */
.pygments122 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments122 .c1 { color: #008000 } /* Comment.Single */
.pygments122 .cs { color: #008000 } /* Comment.Special */
.pygments122 .ge { font-style: italic } /* Generic.Emph */
.pygments122 .gh { font-weight: bold } /* Generic.Heading */
.pygments122 .gp { font-weight: bold } /* Generic.Prompt */
.pygments122 .gs { font-weight: bold } /* Generic.Strong */
.pygments122 .gu { font-weight: bold } /* Generic.Subheading */
.pygments122 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments122 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments122 .kn { color: #af00db } /* Keyword.Namespace */
.pygments122 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments122 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments122 .kt { color: #2b91af } /* Keyword.Type */
.pygments122 .ld { color: #0000FF } /* Literal.Date */
.pygments122 .m { color: #0000FF } /* Literal.Number */
.pygments122 .s { color: #a31515 } /* Literal.String */
.pygments122 .na { color: #001080 } /* Name.Attribute */
.pygments122 .nb { color: #795e26 } /* Name.Builtin */
.pygments122 .nc { color: #2b91af } /* Name.Class */
.pygments122 .no { color: #0000FF } /* Name.Constant */
.pygments122 .nf { color: #795e26 } /* Name.Function */
.pygments122 .nl { color: #AF00DB } /* Name.Label */
.pygments122 .nn { color: #000000 } /* Name.Namespace */
.pygments122 .nt { color: #800000 } /* Name.Tag */
.pygments122 .nv { color: #0F1E87 } /* Name.Variable */
.pygments122 .ow { color: #0000ff } /* Operator.Word */
.pygments122 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments122 .mf { color: #09885a } /* Literal.Number.Float */
.pygments122 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments122 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments122 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments122 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments122 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments122 .sc { color: #a31515 } /* Literal.String.Char */
.pygments122 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments122 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments122 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments122 .se { color: #a31515 } /* Literal.String.Escape */
.pygments122 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments122 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments122 .sx { color: #a31515 } /* Literal.String.Other */
.pygments122 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments122 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments122 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments122 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments122 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments122 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments122 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments122 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments122 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments122 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments122 pre.snippet122 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_16_signed_vector_round.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments122"><pre class="lineNumbers snippet122"><code><span></span><span class="n">int16x8_t</span><span class="w"> </span><span class="nf">div_by_16_round</span><span class="p">(</span><span class="n">int16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vshrq_n_u16</span><span class="p">(</span><span class="n">vreinterpretq_u16_s16</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="mi">15</span><span class="p">);</span><span class="w"> </span><span class="c1">// sign bit</span></code>
<code><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vqsubq_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">vreinterpretq_s16_u16</span><span class="p">(</span><span class="n">sign</span><span class="p">));</span><span class="w"> </span><span class="c1">// subtract 1 if &lt; 0</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vrshrq_n_s16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w">                      </span><span class="c1">// 16 = 2⁴</span></code>
<code><span class="p">}</span></code></pre></div>
</div>
<p>
    Subtracting one from a negative number has an annoying edge case: if the dividend is <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n"><mjx-c class="mjx-c36"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c33"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-mo class="mjx-n"><mjx-c class="mjx-c2C"></mjx-c></mjx-mo></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>−</mo><mn>65536</mn><mo>,</mo></math></mjx-assistive-mml></mjx-container> subtracting one
    will wrap around to <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c36"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c33"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn><mjx-mo class="mjx-n"><mjx-c class="mjx-c2C"></mjx-c></mjx-mo></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>65535</mn><mo>,</mo></math></mjx-assistive-mml></mjx-container> which is not what we want.<br>
    The solution is to use a saturating subtraction, such that <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n"><mjx-c class="mjx-c36"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c33"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="3"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="3"><mjx-c class="mjx-c31"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c21A6"></mjx-c></mjx-mo><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n"><mjx-c class="mjx-c36"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c33"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>−</mo><mn>65536</mn><mo>−</mo><mn>1</mn><mo stretchy="false">↦</mo><mo>−</mo><mn>65536</mn></math></mjx-assistive-mml></mjx-container>. Saturating intrinsics have
    a <code>q</code> prefix.
</p>
<p>
    To determine the sign of the dividend, we just extract the sign bit by shifting it 15 bits to the right. It's
    important to use an unsigned bit shift, because a signed shift would sign extend the number after shifting,
    resulting in <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c><mjx-c class="mjx-c1D675 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0xFFFF</mtext></math></mjx-assistive-mml></mjx-container> instead of <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F7 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x0001</mtext></math></mjx-assistive-mml></mjx-container>.<br>
    The sign bit is one if the number is negative, zero if it's positive or zero.
</p>

<h2><a name="dividing-by-255" href="#dividing-by-255">Dividing by 255</a></h2>

<p>
    When working with images, most data is represented by 8-bit bytes, as a value from 0 to 255. For example, when
    alpha blending two images, you'll often need to multiply two 8-bit values together, and afterwards, you have to
    re-normalize 16-bit products by dividing by 255.
</p>

<h3><a name="approximating-by-a-division-by-256" href="#approximating-by-a-division-by-256">Approximating by a division by 256</a></h3>
<p>
    As a first approximation, you could start by dividing by 256, because this is simply a right bit shift by 8, as
    discussed above. To convert from the 16-bit product back to an 8-bit number, you can use a narrowing bit shift:
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments151 .hll { background-color: #ffffcc }
.pygments151 { background: #ffffff; }
.pygments151 .c { color: #008000 } /* Comment */
.pygments151 .err { border: 1px solid #FF0000 } /* Error */
.pygments151 .k { color: #0000ff } /* Keyword */
.pygments151 .l { color: #0000FF } /* Literal */
.pygments151 .ch { color: #008000 } /* Comment.Hashbang */
.pygments151 .cm { color: #008000 } /* Comment.Multiline */
.pygments151 .cp { color: #af00db } /* Comment.Preproc */
.pygments151 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments151 .c1 { color: #008000 } /* Comment.Single */
.pygments151 .cs { color: #008000 } /* Comment.Special */
.pygments151 .ge { font-style: italic } /* Generic.Emph */
.pygments151 .gh { font-weight: bold } /* Generic.Heading */
.pygments151 .gp { font-weight: bold } /* Generic.Prompt */
.pygments151 .gs { font-weight: bold } /* Generic.Strong */
.pygments151 .gu { font-weight: bold } /* Generic.Subheading */
.pygments151 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments151 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments151 .kn { color: #af00db } /* Keyword.Namespace */
.pygments151 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments151 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments151 .kt { color: #2b91af } /* Keyword.Type */
.pygments151 .ld { color: #0000FF } /* Literal.Date */
.pygments151 .m { color: #0000FF } /* Literal.Number */
.pygments151 .s { color: #a31515 } /* Literal.String */
.pygments151 .na { color: #001080 } /* Name.Attribute */
.pygments151 .nb { color: #795e26 } /* Name.Builtin */
.pygments151 .nc { color: #2b91af } /* Name.Class */
.pygments151 .no { color: #0000FF } /* Name.Constant */
.pygments151 .nf { color: #795e26 } /* Name.Function */
.pygments151 .nl { color: #AF00DB } /* Name.Label */
.pygments151 .nn { color: #000000 } /* Name.Namespace */
.pygments151 .nt { color: #800000 } /* Name.Tag */
.pygments151 .nv { color: #0F1E87 } /* Name.Variable */
.pygments151 .ow { color: #0000ff } /* Operator.Word */
.pygments151 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments151 .mf { color: #09885a } /* Literal.Number.Float */
.pygments151 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments151 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments151 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments151 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments151 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments151 .sc { color: #a31515 } /* Literal.String.Char */
.pygments151 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments151 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments151 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments151 .se { color: #a31515 } /* Literal.String.Escape */
.pygments151 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments151 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments151 .sx { color: #a31515 } /* Literal.String.Other */
.pygments151 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments151 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments151 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments151 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments151 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments151 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments151 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments151 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments151 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments151 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments151 pre.snippet151 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_256_vector_narrow.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments151"><pre class="lineNumbers snippet151"><code><span></span><span class="n">uint8x8_t</span><span class="w"> </span><span class="nf">div_by_256</span><span class="p">(</span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshrn_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"> </span><span class="c1">// 256 = 2⁸</span></code>
<code><span class="p">}</span></code></pre></div>
</div>
<p>
    Narrowing intrinsics have an <code>n</code> suffix. You can also realize a rounding division by using
    <code>v<b>r</b>shrn_n_u16</code>.
</p>
<p>
    The main problem with this approach is that it will produce a result that's one unit too low, about 50% of the
    time. For example, blending white with white will result in really light gray, but not quite white
    (<mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="3"><mjx-c class="mjx-c22C5"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="3"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn><mjx-TeXAtom texclass="ORD"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2F"></mjx-c></mjx-mo></mjx-TeXAtom><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c2248"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c34"></mjx-c><mjx-c class="mjx-c2E"></mjx-c><mjx-c class="mjx-c30"></mjx-c><mjx-c class="mjx-c30"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c2260"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>255</mn><mo>⋅</mo><mn>255</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mn>256</mn><mo>≈</mo><mn>254.00</mn><mo>≠</mo><mn>255</mn></math></mjx-assistive-mml></mjx-container>). In this case, rounding won't help either.<br>
    For most real-time applications, this is not an issue, and speed might be more important than perfect
    accuracy.
</p>

<h3><a name="true-division-by-255" href="#true-division-by-255">True division by 255</a></h3>

<h4><a name="flooring2" href="#flooring2">Flooring</a></h4>

<p>
    The divisor of <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>255</mn></math></mjx-assistive-mml></mjx-container> can be approximated by the fraction
    <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c></mjx-mtext><mjx-TeXAtom texclass="ORD"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2F"></mjx-c></mjx-mo></mjx-TeXAtom><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F7 TEX-T"></mjx-c></mjx-mtext><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c3D"></mjx-c></mjx-mo><mjx-msup space="4"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c></mjx-mn><mjx-script style="vertical-align: 0.363em;"><mjx-TeXAtom size="s" texclass="ORD"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c33"></mjx-c></mjx-mn></mjx-TeXAtom></mjx-script></mjx-msup><mjx-TeXAtom texclass="ORD"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2F"></mjx-c></mjx-mo></mjx-TeXAtom><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F7 TEX-T"></mjx-c></mjx-mtext><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c2248"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c34"></mjx-c><mjx-c class="mjx-c2E"></mjx-c><mjx-c class="mjx-c39"></mjx-c><mjx-c class="mjx-c39"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x800000</mtext><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mtext mathvariant="monospace">0x8081</mtext><mo>=</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>23</mn></mrow></msup><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mtext mathvariant="monospace">0x8081</mtext><mo>≈</mo><mn>254.996</mn></math></mjx-assistive-mml></mjx-container>.
    This means that you can replace the division by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>255</mn></math></mjx-assistive-mml></mjx-container> by a multiplication by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F7 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x8081</mtext></math></mjx-assistive-mml></mjx-container>, followed by a
    right bit shift by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c33"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>23</mn></math></mjx-assistive-mml></mjx-container> bits.
</p>
<p>
    The downside of this approach is that a 32-bit multiplication is required. NEON doesn't have any multiplication
    instructions that return the high half of the product. It does have an instruction that can be used to extract
    all high half-words from two vector registers and merge them into a single register, as a deinterleaving or
    unzip operation.
    This is equivalent with a right bitshift of 16 bits. The instruction is <code>uzp2</code>, we'll use the
    <code>vuzp2q_u16</code> intrinsic.
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments184 .hll { background-color: #ffffcc }
.pygments184 { background: #ffffff; }
.pygments184 .c { color: #008000 } /* Comment */
.pygments184 .err { border: 1px solid #FF0000 } /* Error */
.pygments184 .k { color: #0000ff } /* Keyword */
.pygments184 .l { color: #0000FF } /* Literal */
.pygments184 .ch { color: #008000 } /* Comment.Hashbang */
.pygments184 .cm { color: #008000 } /* Comment.Multiline */
.pygments184 .cp { color: #af00db } /* Comment.Preproc */
.pygments184 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments184 .c1 { color: #008000 } /* Comment.Single */
.pygments184 .cs { color: #008000 } /* Comment.Special */
.pygments184 .ge { font-style: italic } /* Generic.Emph */
.pygments184 .gh { font-weight: bold } /* Generic.Heading */
.pygments184 .gp { font-weight: bold } /* Generic.Prompt */
.pygments184 .gs { font-weight: bold } /* Generic.Strong */
.pygments184 .gu { font-weight: bold } /* Generic.Subheading */
.pygments184 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments184 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments184 .kn { color: #af00db } /* Keyword.Namespace */
.pygments184 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments184 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments184 .kt { color: #2b91af } /* Keyword.Type */
.pygments184 .ld { color: #0000FF } /* Literal.Date */
.pygments184 .m { color: #0000FF } /* Literal.Number */
.pygments184 .s { color: #a31515 } /* Literal.String */
.pygments184 .na { color: #001080 } /* Name.Attribute */
.pygments184 .nb { color: #795e26 } /* Name.Builtin */
.pygments184 .nc { color: #2b91af } /* Name.Class */
.pygments184 .no { color: #0000FF } /* Name.Constant */
.pygments184 .nf { color: #795e26 } /* Name.Function */
.pygments184 .nl { color: #AF00DB } /* Name.Label */
.pygments184 .nn { color: #000000 } /* Name.Namespace */
.pygments184 .nt { color: #800000 } /* Name.Tag */
.pygments184 .nv { color: #0F1E87 } /* Name.Variable */
.pygments184 .ow { color: #0000ff } /* Operator.Word */
.pygments184 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments184 .mf { color: #09885a } /* Literal.Number.Float */
.pygments184 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments184 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments184 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments184 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments184 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments184 .sc { color: #a31515 } /* Literal.String.Char */
.pygments184 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments184 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments184 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments184 .se { color: #a31515 } /* Literal.String.Escape */
.pygments184 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments184 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments184 .sx { color: #a31515 } /* Literal.String.Other */
.pygments184 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments184 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments184 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments184 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments184 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments184 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments184 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments184 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments184 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments184 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments184 pre.snippet184 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_255_vector.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments184"><pre class="lineNumbers snippet184"><code><span></span><span class="n">uint8x8_t</span><span class="w"> </span><span class="nf">div_by_255</span><span class="p">(</span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="c1">// Multiply by 0x8081 as 32-bit integers (high and low elements separately)</span></code>
<code><span class="w">    </span><span class="c1">// 0x800000/0x8081 ≃ 255</span></code>
<code><span class="w">    </span><span class="n">uint32x4_t</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmull_high_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8081</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="n">uint32x4_t</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmull_n_u16</span><span class="p">(</span><span class="n">vget_low_u16</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="mh">0x8081</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="c1">// Extract the 16 high bits of all 32-bit products (division by 0x10000)</span></code>
<code><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vuzp2q_u16</span><span class="p">(</span><span class="n">vreinterpretq_u16_u32</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="w"> </span><span class="n">vreinterpretq_u16_u32</span><span class="p">(</span><span class="n">h</span><span class="p">));</span></code>
<code><span class="w">    </span><span class="c1">// Divide by 0x80 and narrow from 16 bits to 8 bits</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshrn_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span></code>
<code><span class="p">}</span></code></pre></div>
</div>
<p>
    The effect of the <code>uzp2</code> instruction is visualized in the following diagram. Each cell is a 16-bit
    half-word.
    The two rows on the left represent the two 128-bit vector registers containing the products of the four high and low
    elements respectively (variables <code>h</code> and <code>l</code> in the code). Two 16-bit cells make up one of
    the eight 32-bit products.
</p>

<style>
    table.border {
        border-collapse: collapse;
        border-spacing: 0;
        padding: 0.8em;
    }

    table.border td {
        border: 1px solid black;
        padding: 0.4em 0;
        width: 2.1em;
        text-align: center;
    }

    table.half td:nth-child(even) {
        border-left: 1px dotted #aaa;
    }

    table.half td:nth-child(odd) {
        border-right: none;
    }

    .flex_container {
        display: flex;
        justify-content: space-around;
        align-items: center;
        flex-flow: row wrap;
    }
</style>
<div class="flex_container">
    <table class="border half">
        <tr>
            <td>H<sub>7</sub></td>
            <td>L<sub>7</sub></td>
            <td>H<sub>6</sub>
            <td>L<sub>6</sub></td>
            <td>H<sub>5</sub></td>
            <td>L<sub>5</sub></td>
            <td>H<sub>4</sub>
            <td>L<sub>4</sub></td>
        </td></td></tr>
        <tr>
            <td>H<sub>3</sub></td>
            <td>L<sub>3</sub></td>
            <td>H<sub>2</sub>
            <td>L<sub>3</sub></td>
            <td>H<sub>1</sub></td>
            <td>L<sub>1</sub></td>
            <td>H<sub>0</sub>
            <td>L<sub>0</sub></td>
        </td></td></tr>
    </table>
    <div style="text-align: center; padding: 1em;">UZP2<br>→</div>
    <table class="border">
        <tr>
            <td>H<sub>7</sub></td>
            <td>H<sub>6</sub>
            <td>H<sub>5</sub></td>
            <td>H<sub>4</sub>
            <td>H<sub>3</sub></td>
            <td>H<sub>2</sub>
            <td>H<sub>1</sub></td>
            <td>H<sub>0</sub>
        </td></td></td></td></tr>
    </table>
</div>
<p>
    <code><span style="border: 1px solid black; padding: 2px;">H<sub>7</sub> L<sub>7</sub></span> = x[7] * 0x8081</code>,
    where <code>x[7]</code> is the seventh element of the input, 16 bits wide. <code>0x8081</code> is the constant
    factor and is also 16 bits wide.
    Their product will be 32 bits wide, it consists of a high half-word (<code>H<sub>7</sub></code>) and a low
    half-word (<code>L<sub>7</sub></code>). The low half-words will be discarded by the unzip operation, effectively
    dividing each product by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F7 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x10000</mtext></math></mjx-assistive-mml></mjx-container>.
</p>
<p>
    For this unzip operation to work, the vector registers have to be interpreted as 8×16-bit values (even though they
    actually contain 4×32-bit values).
</p>
<p>
    Finally, the 16-bit high half-words of the products are narrowed to 8-bit bytes, while shifting them another 7 bits
    to the right for the final division by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x80</mtext></math></mjx-assistive-mml></mjx-container>.
</p>
<p>
    The result is exact for all possible values of <code>x</code>.
</p>

<h4><a name="rounding2" href="#rounding2">Rounding</a></h4>

<p>
    It is tempting to just replace the final shift (<code>vshrn_n_u16</code>) with a rounding shift
    (<code>vrshrn_n_u16</code>), in an attempt to implement a rounding division by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>255</mn></math></mjx-assistive-mml></mjx-container>.
    Unfortunately, this doesn't work, because rounding the final division by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c38"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>128</mn></math></mjx-assistive-mml></mjx-container> is not the same as rounding the
    original division by <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>255</mn></math></mjx-assistive-mml></mjx-container>. For some inputs, the output will be one unit too low.
    It is a pretty good approximation though, producing an incorrect result for only 127 out of all 65536 possible input
    values (it is correct in <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c39"></mjx-c><mjx-c class="mjx-c39"></mjx-c><mjx-c class="mjx-c2E"></mjx-c><mjx-c class="mjx-c38"></mjx-c><mjx-c class="mjx-c30"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-mi class="mjx-n"><mjx-c class="mjx-c25"></mjx-c></mjx-mi></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>99.806</mn><mi mathvariant="normal">%</mi></math></mjx-assistive-mml></mjx-container> of the cases, with an error of either 0 or -1).
</p>
<p>
    The correct solution is to add the rounding constant <i>before</i> the multiplication. However, we're adding a
    rounding constant of <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c38"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c3D"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn><mjx-TeXAtom texclass="ORD"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2F"></mjx-c></mjx-mo></mjx-TeXAtom><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>128</mn><mo>=</mo><mn>256</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mn>2</mn></math></mjx-assistive-mml></mjx-container>, while in theory, we should be using <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c37"></mjx-c><mjx-c class="mjx-c2E"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c3D"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn><mjx-TeXAtom texclass="ORD"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2F"></mjx-c></mjx-mo></mjx-TeXAtom><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>127.5</mn><mo>=</mo><mn>255</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mn>2</mn></math></mjx-assistive-mml></mjx-container>. It turns out that this
    error of <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c30"></mjx-c><mjx-c class="mjx-c2E"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>0.5</mn></math></mjx-assistive-mml></mjx-container> can be compensated by changing the factor in the next step from <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F7 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x8081</mtext></math></mjx-assistive-mml></mjx-container> to
    <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mtext class="mjx-ty"><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D6A1 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c><mjx-c class="mjx-c1D7FE TEX-T"></mjx-c><mjx-c class="mjx-c1D7F6 TEX-T"></mjx-c></mjx-mtext></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext mathvariant="monospace">0x8080</mtext></math></mjx-assistive-mml></mjx-container>.
</p>
<div class="codesnippet"><style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.pygments297 .hll { background-color: #ffffcc }
.pygments297 { background: #ffffff; }
.pygments297 .c { color: #008000 } /* Comment */
.pygments297 .err { border: 1px solid #FF0000 } /* Error */
.pygments297 .k { color: #0000ff } /* Keyword */
.pygments297 .l { color: #0000FF } /* Literal */
.pygments297 .ch { color: #008000 } /* Comment.Hashbang */
.pygments297 .cm { color: #008000 } /* Comment.Multiline */
.pygments297 .cp { color: #af00db } /* Comment.Preproc */
.pygments297 .cpf { color: #a31515 } /* Comment.PreprocFile */
.pygments297 .c1 { color: #008000 } /* Comment.Single */
.pygments297 .cs { color: #008000 } /* Comment.Special */
.pygments297 .ge { font-style: italic } /* Generic.Emph */
.pygments297 .gh { font-weight: bold } /* Generic.Heading */
.pygments297 .gp { font-weight: bold } /* Generic.Prompt */
.pygments297 .gs { font-weight: bold } /* Generic.Strong */
.pygments297 .gu { font-weight: bold } /* Generic.Subheading */
.pygments297 .kc { color: #4e8ae9 } /* Keyword.Constant */
.pygments297 .kd { color: #0000ff } /* Keyword.Declaration */
.pygments297 .kn { color: #af00db } /* Keyword.Namespace */
.pygments297 .kp { color: #0000ff } /* Keyword.Pseudo */
.pygments297 .kr { color: #0000ff } /* Keyword.Reserved */
.pygments297 .kt { color: #2b91af } /* Keyword.Type */
.pygments297 .ld { color: #0000FF } /* Literal.Date */
.pygments297 .m { color: #0000FF } /* Literal.Number */
.pygments297 .s { color: #a31515 } /* Literal.String */
.pygments297 .na { color: #001080 } /* Name.Attribute */
.pygments297 .nb { color: #795e26 } /* Name.Builtin */
.pygments297 .nc { color: #2b91af } /* Name.Class */
.pygments297 .no { color: #0000FF } /* Name.Constant */
.pygments297 .nf { color: #795e26 } /* Name.Function */
.pygments297 .nl { color: #AF00DB } /* Name.Label */
.pygments297 .nn { color: #000000 } /* Name.Namespace */
.pygments297 .nt { color: #800000 } /* Name.Tag */
.pygments297 .nv { color: #0F1E87 } /* Name.Variable */
.pygments297 .ow { color: #0000ff } /* Operator.Word */
.pygments297 .mb { color: #09885a } /* Literal.Number.Bin */
.pygments297 .mf { color: #09885a } /* Literal.Number.Float */
.pygments297 .mh { color: #09885a } /* Literal.Number.Hex */
.pygments297 .mi { color: #09885a } /* Literal.Number.Integer */
.pygments297 .mo { color: #09885a } /* Literal.Number.Oct */
.pygments297 .sa { color: #a31515 } /* Literal.String.Affix */
.pygments297 .sb { color: #a31515 } /* Literal.String.Backtick */
.pygments297 .sc { color: #a31515 } /* Literal.String.Char */
.pygments297 .dl { color: #a31515 } /* Literal.String.Delimiter */
.pygments297 .sd { color: #a31515 } /* Literal.String.Doc */
.pygments297 .s2 { color: #a31515 } /* Literal.String.Double */
.pygments297 .se { color: #a31515 } /* Literal.String.Escape */
.pygments297 .sh { color: #a31515 } /* Literal.String.Heredoc */
.pygments297 .si { color: #a31515 } /* Literal.String.Interpol */
.pygments297 .sx { color: #a31515 } /* Literal.String.Other */
.pygments297 .sr { color: #a31515 } /* Literal.String.Regex */
.pygments297 .s1 { color: #a31515 } /* Literal.String.Single */
.pygments297 .ss { color: #a31515 } /* Literal.String.Symbol */
.pygments297 .bp { color: #795e26 } /* Name.Builtin.Pseudo */
.pygments297 .fm { color: #795e26 } /* Name.Function.Magic */
.pygments297 .vc { color: #0F1E87 } /* Name.Variable.Class */
.pygments297 .vg { color: #0F1E87 } /* Name.Variable.Global */
.pygments297 .vi { color: #0F1E87 } /* Name.Variable.Instance */
.pygments297 .vm { color: #0F1E87 } /* Name.Variable.Magic */
.pygments297 .il { color: #09885a } /* Literal.Number.Integer.Long */
.pygments297 pre.snippet297 { counter-reset: line 0; }</style>
<a href="https://github.com/tttapa/tttapa.github.io/blob/master/Pages-src/Raw-HTML/Raspberry-Pi/NEON/resources/div_by_255_vector_round.cpp" title="Open on GitHub"><img class="github-mark" src="/Images/GitHub-Mark.svg"></a>

    <div class="copy-button" onclick="copyTextBelow(this)" title="Copy to clipboard">
        <span class="material-icons copy-icon clipboard">content_copy</span>
        <span class="material-icons copy-icon checkmark">check</span>
    </div>
    <div class="pygments297"><pre class="lineNumbers snippet297"><code><span></span><span class="n">uint8x8_t</span><span class="w"> </span><span class="nf">div_by_255_round</span><span class="p">(</span><span class="n">uint16x8_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code>
<code><span class="w">    </span><span class="c1">// Add the rounding constant</span></code>
<code><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vaddq_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">vdupq_n_u16</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">));</span></code>
<code><span class="w">    </span><span class="c1">// Multiply by 0x8080 as 32-bit integers (high and low elements separately)</span></code>
<code><span class="w">    </span><span class="n">uint32x4_t</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmull_high_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8080</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="n">uint32x4_t</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmull_n_u16</span><span class="p">(</span><span class="n">vget_low_u16</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="mh">0x8080</span><span class="p">);</span></code>
<code><span class="w">    </span><span class="c1">// Extract the 16 high bits of all 32-bit products (division by 0x10000)</span></code>
<code><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vuzp2q_u16</span><span class="p">(</span><span class="n">vreinterpretq_u16_u32</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="w"> </span><span class="n">vreinterpretq_u16_u32</span><span class="p">(</span><span class="n">h</span><span class="p">));</span></code>
<code><span class="w">    </span><span class="c1">// Divide by 0x80 and narrow from 16 bits to 8 bits</span></code>
<code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vshrn_n_u16</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span></code>
<code><span class="p">}</span></code></pre></div>
</div>
<p>
    The result of this function is correct as long as the addition of the rounding constant doesn't cause overflow. This
    condition is satisfied if the input is less than <mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-msup><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c></mjx-mn><mjx-script style="vertical-align: 0.363em;"><mjx-TeXAtom size="s" texclass="ORD"><mjx-mn class="mjx-n"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c36"></mjx-c></mjx-mn></mjx-TeXAtom></mjx-script></mjx-msup><mjx-mo class="mjx-n" space="3"><mjx-c class="mjx-c2212"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="3"><mjx-c class="mjx-c31"></mjx-c><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c38"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c3D"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c36"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c34"></mjx-c><mjx-c class="mjx-c30"></mjx-c><mjx-c class="mjx-c38"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>16</mn></mrow></msup><mo>−</mo><mn>128</mn><mo>=</mo><mn>65408</mn></math></mjx-assistive-mml></mjx-container>. Luckily, in this case, the result would
    be meaningless anyway, because the quotient would be too large to fit an 8-bit byte (<mjx-container class="MathJax" jax="CHTML" style="font-size: 113.1%; position: relative;"><mjx-math class=" MJX-TEX" aria-hidden="true"><mjx-mn class="mjx-n"><mjx-c class="mjx-c36"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c34"></mjx-c><mjx-c class="mjx-c30"></mjx-c><mjx-c class="mjx-c38"></mjx-c></mjx-mn><mjx-TeXAtom texclass="ORD"><mjx-mo class="mjx-n"><mjx-c class="mjx-c2F"></mjx-c></mjx-mo></mjx-TeXAtom><mjx-mn class="mjx-n"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c2248"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c36"></mjx-c><mjx-c class="mjx-c2E"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn><mjx-mo class="mjx-n" space="4"><mjx-c class="mjx-c3E"></mjx-c></mjx-mo><mjx-mn class="mjx-n" space="4"><mjx-c class="mjx-c32"></mjx-c><mjx-c class="mjx-c35"></mjx-c><mjx-c class="mjx-c35"></mjx-c></mjx-mn></mjx-math><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>65408</mn><mrow data-mjx-texclass="ORD"><mo>/</mo></mrow><mn>255</mn><mo>≈</mo><mn>256.5</mn><mo>&gt;</mo><mn>255</mn></math></mjx-assistive-mml></mjx-container>).
</p>

</div>
        <hr id="end-of-article">
        <div class="nextupprev"><div class="prevpage"></div><div class="uppage"><a href="index.html" title="NEON">Index</a></div><div class="nextpage"></div></div>
    </article>
    <footer>Last edited: Thursday, 09 July 2020 10:41 UTC</footer>
</body>

</html>
