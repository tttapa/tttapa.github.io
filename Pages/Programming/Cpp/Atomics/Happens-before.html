<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="author" content="Pieter P"/>
    <link rel="stylesheet" type="text/css" href="/CSS/Pages.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- No MathJax -->
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'/>
    <meta name="theme-color" content="#ccc"/>
    <meta name="keywords" content="c++,happens-before,sequenced-before,synchronizes-with"/>
    <meta name="description" content="The C++ Standard's definitions of ordering relationships like sequenced-before, synchronizes-with, happens-before, etc. with diagrams to visualize all relationships."/>
    <title>Happens before</title>
</head>
<body>
    <nav>
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48" style="position:absolute;top:4px;right: 4px;">
                <path d="M0 0h48v48h-48z" fill="none"/>
                <path d="M6 36h36v-4h-36v4zm0-10h36v-4h-36v4zm0-14v4h36v-4h-36z"/>
            </svg>
            <h2><a href="/Pages">Pages</a></h2>
<ul>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/index.html">Raspberry Pi</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/Installation+Setup/index.html">Installation and Setup</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/Installation+Setup/Setting-up-Ubuntu.html">Installing and Setting up Ubuntu</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/Installation+Setup/WiFi-Setup.html">Setting up the WiFi Connection</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/Python-Development/index.html">Python Development</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/index.html">Ubuntu to Raspberry Pi OS Cross C++ Development</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Installation.html">Installation and Setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Development-setup.html">Development setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Building-example-project.html">Building the C++ example project</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development-RPiOS/Debugging.html">Remote debugging</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/C++-Development-Ubuntu/index.html">Ubuntu to Ubuntu Cross C++ Development</a>
        <ul>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/C++-Development/index.html">C++ Development using Docker</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Installation.html">Installation and setup</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Building-The-Toolchain.html">Building the Cross-Compilation Toolchain</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Dependencies.html">Cross-Compiling the Dependencies</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Installing-Dependencies.html">Installing the dependencies on the Pi</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Cpp-Program.html">Cross-Compiling the C++ Example Project</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Debugging.html">Debugging</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/C++-Development/Speedrun.html">Speedrun</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Raspberry-Pi/NEON/index.html">NEON</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Raspberry-Pi/NEON/Division.html">Division</a></li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/index.html">Arduino</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/Audio-and-Signal-Processing/index.html">Audio and Signal Processing</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/Audio-and-Signal-Processing/VU-Meters/index.html">VU Meters</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Audio-and-Signal-Processing/VU-Meters/Model.html">Model of a moving-coil galvanometer</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Audio-and-Signal-Processing/VU-Meters/Damped-Harmonic-Oscillator.html">The Damped Harmonic Oscillator</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/Control-Surface/index.html">Control Surface</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/Control-Surface/Developers/index.html">Developers</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Surface/Developers/Installation.html">Installation</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Surface/Developers/Style.html">Style</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Surface/Developers/Tests.html">Tests</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Surface/Developers/Generating-Documentation.html">Generating Documentation</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/Control-Theory/index.html">Control Theory</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/index.html">Motorized Faders</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/PID-Controllers.html">PID Controllers</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/PID-Cpp-Implementation.html">C++ Implementation</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/PID-Tuning.html">PID Tuning</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/Architecture.html">Architecture and Design Decisions</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/Hardware.html">Hardware</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/Configuration.html">Configuration options and common use cases</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Control-Theory/Motor-Fader/ATmega328P-Code.html">ATmega328P Code</a></li>
            </ul>
            </li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/Bootloaders/index.html">Bootloaders</a>
        <ul>
            <li><span class="ftriangle"></span><a class="" href="../../../Arduino/Bootloaders/ATmega328P-custom-frequency.html">Compiling Optiboot - ATmega328P at custom frequency</a></li>
        </ul>
        </li>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/ESP8266/index.html">ESP8266</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Arduino/ESP8266/Flashing/index.html">Flashing</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Arduino/ESP8266/Flashing/Flashing-With-an-Arduino.html">Flashing the ESP8266 with an Arduino UNO</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/index.html">Mathematics &amp; Engineering</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/index.html">Systems and Control Theory</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Analog-Filters/index.html">Analog Filters &amp; Systems</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Analog-Filters/Butterworth-Filters.html">Butterworth Filters</a></li>
            </ul>
            </li>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/index.html">Digital Filters &amp; Systems</a>
            <ul>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/index.html">DTLTI Systems, Transfer Functions, and the Z-transform</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/DTLTI-Systems.html">DTLTI Systems</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/Impulse-and-Step-Response.html">Impulse and Step Response</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/Convolutions.html">Convolutions</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/DTLTI-Systems,-Transfer-Functions,-and-the-Z-transform/The-Z-transform.html">The Z-transform</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/index.html">Exponential Moving Average</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/Exponential-Moving-Average.html">Exponential Moving Average</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/Filtering-in-MATLAB.html">Filtering in MATLAB</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Exponential Moving Average/C++Implementation.html">C++ Implementation</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/index.html">Simple Moving Average</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/Simple-Moving-Average.html">Simple Moving Average</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Simple Moving Average/C++Implementation.html">C++ Implementation</a></li>
                </ul>
                </li>
                <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/index.html">Discretization</a>
                <ul>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/Bilinear-transform.html">Bilinear Transform</a></li>
                    <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/Discretization/Discretization-of-a-fourth-order-Butterworth-filter.html">Discretization of a Fourth-Order Butterworth Filter</a></li>
                </ul>
                </li>
                <li><span class="ftriangle"></span><a class="" href="../../../Mathematics/Systems-and-Control-Theory/Digital-filters/FIR-Notch.html">Simple Finite Impulse Response Notch Filter</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../index.html">Programming</a>
    <ul>
        <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../index.html">C++</a>
        <ul>
            <li class="expanded"><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="hiddenEntry " href="index.html">Atomics</a>
            <ul>
                <li><span class="ftriangle"></span><a class="openEntry " href="Happens-before.html">Happens before</a></li>
                <li><span class="ftriangle"></span><a class="" href="Memory-order.html">Memory order</a></li>
                <li><span class="ftriangle"></span><a class="" href="Examples.html">Examples</a></li>
            </ul>
            </li>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../Practices/index.html">Best Practices</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../Practices/type-punning.html">Don't use unions or pointer casts for type punning</a></li>
                <li><span class="ftriangle"></span><a class="" href="../Practices/c-style-casts.html">Don't use C-style casts</a></li>
            </ul>
            </li>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../Algorithms/index.html">Algorithms</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../Algorithms/Max_n_elements.html">Maximum N elements</a></li>
            </ul>
            </li>
        </ul>
        </li>
    </ul>
    </li>
    <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Ubuntu/index.html">Ubuntu</a>
    <ul>
        <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Ubuntu/Software-Installation/index.html">Software Installation</a>
        <ul>
            <li><span class="dtriangle" onclick="this.parentElement.classList.toggle('expanded');"></span><a class="" href="../../../Ubuntu/Software-Installation/Arduino/index.html">Arduino</a>
            <ul>
                <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Arduino/Arduino-IDE.html">Arduino IDE</a></li>
                <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Arduino/Hairless-MIDI.html">The Hairless MIDI to Serial Bridge</a></li>
            </ul>
            </li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Installing-Locally.html">Installing Locally</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/BlueZ.html">BlueZ with MIDI over BLE Support</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Doxygen.html">Doxygen</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Eclipse.html">Eclipse</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Eigen3.html">Eigen</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/GoogleTest.html">GoogleTest</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Java.html">Java</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/Python.html">Python</a></li>
            <li><span class="ftriangle"></span><a class="" href="../../../Ubuntu/Software-Installation/VirtualBox.html">VirtualBox</a></li>
        </ul>
        </li>
    </ul>
    </li>
</ul>

            <i class="material-icons">
                <a href="/" title="Home">home</a>
            </i>
            <i class="material-icons">
                <a href="Happens-before.pdf" title="Download as PDF">get_app</a>
            </i>
            <!-- <i class="material-icons">
                <a href="javascript:window.print()" title="Print this article" onclick="window.print(); return false;">print</a>
            </i> -->
            <i class="material-icons">
                <a href="https://github.com/tttapa/tttapa.github.io/issues/new" target="_blank" title="Comment or open an issue">feedback</a>
            </i>
        </div>
    </nav>
    <article>
        <h1 class="title">Happens before</h1>
        <i class="author">Pieter P</i>
        <div class="main-content">
<div class="toc" id="toc">
  <script>
  function updateTocSize() {
    let toc = document.getElementById("toc");
    toc.style.maxHeight = toc.scrollHeight + 'px';
  }
  </script>  <h4 class="toc" onclick="if (this.parentElement.classList.toggle('expanded')) {updateTocSize();window.addEventListener('resize', updateTocSize);} else {this.parentElement.style = undefined;window.removeEventListener('resize', updateTocSize);}">Table of Contents <i class="material-icons">list</i></h4>
  <ul>
        <li><a href="#definitions">Definitions</a></li>
          <ul>
            <li><a href="#sequenced-before">Sequenced before</a></li>
            <li><a href="#synchronizes-with">Synchronizes with</a></li>
            <li><a href="#inter-thread-happens-before">Inter-thread happens before</a></li>
            <li><a href="#happens-before">Happens before</a></li>
            <li><a href="#simply-happens-before">Simply happens before</a></li>
            <li><a href="#strongly-happens-before">Strongly happens before</a></li>
            <li><a href="#modification-order">Modification order</a></li>
              <ul>
                <li><a href="#write-write-coherence">Write-write coherence</a></li>
                <li><a href="#read-read-coherence">Read-read coherence</a></li>
                <li><a href="#read-write-coherence">Read-write coherence</a></li>
                <li><a href="#write-read-coherence">Write-read coherence</a></li>
              </ul>
            <li><a href="#release-sequence">Release sequence</a></li>
            <li><a href="#visible-side-effect">Visible side effect</a></li>
            <li><a href="#potentially-concurrent">Potentially concurrent</a></li>
            <li><a href="#data-race">Data race</a></li>
            </ul>
  </ul></div>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

<h2><a name="definitions" href="#definitions">Definitions</a></h2>

<p>
    This section quotes some definitions from the standard, adding diagrams for easier interpretation.
</p>

<h3><a name="sequenced-before" href="#sequenced-before">Sequenced before</a></h3>

<p>
    Partial evaluation order within a single thread. This is not necessarily the
    order observed by other threads.
</p>
<p>
    Most important rule: <i>“Every value computation and side effect associated
        with a full-expression is sequenced before every value computation and
        side effect associated with the next full-expression to be evaluated.”</i>
</p>
<p>
    <small>
        <a href="https://en.cppreference.com/w/cpp/language/eval_order#Ordering">cppreference: Order of evaluation:
            Ordering</a><br>
        <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/n4868.pdf#page.80">C++ standard:
            [intro.execution]</a>
    </small>
</p>

<h3><a name="synchronizes-with" href="#synchronizes-with">Synchronizes with</a></h3>

<p>
    Certain library calls synchronize with other library calls performed by another thread. For example, an
    atomic store-release synchronizes with a load-acquire that takes its value from the store.
</p>

<h3><a name="inter-thread-happens-before" href="#inter-thread-happens-before">Inter-thread happens before</a></h3>

<p>
    An evaluation <i>A</i> inter-thread happens before an evaluation <i>B</i> if
</p>
<ul>
    <li><i>A</i> synchronizes with <i>B</i>, or
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    A
                end
                subgraph T2
                    B
                end
                A -->|SYNC| B
        </div>
    </li>
    <li style="color: #aab"><i>A</i> is dependency-ordered before <i>B</i>, or</li>
    <li>for some evaluation <i>X</i>
        <ul>
            <li><i>A</i> synchronizes with <i>X</i> and <i>X</i> is sequenced before <i>B</i>, or
                <div class="mermaid">
                    flowchart LR
                        subgraph T1
                            A
                        end
                        subgraph T2
                            direction TB
                            X -->|SEQ| B
                        end
                        A -->|SYNC| X
                </div>
            </li>
            <li><i>A</i> is sequenced before <i>X</i> and <i>X</i> inter-thread happens before <i>B</i>, or
                <div class="mermaid">
                    flowchart LR
                        subgraph T1
                            direction TB
                            A -->|SEQ| X
                        end
                        subgraph T2
                            B
                        end
                        X -->|ITHB| B
                </div>
            </li>
            <li><i>A</i> inter-thread happens before <i>X</i> and <i>X</i> inter-thread happens before <i>B</i>.
                <div class="mermaid">
                    flowchart LR
                        subgraph T1
                            A
                        end
                        subgraph T2
                            X
                        end
                        subgraph T3
                            B
                        end
                        A -->|ITHB| X
                        X -->|ITHB| B
                </div>
            </li>
        </ul>
    </li>
</ul>
<p>
    <small>
        <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/n4868.pdf#page.82">C++ standard:
            [intro.races]</a>
    </small>
</p>

<h3><a name="happens-before" href="#happens-before">Happens before</a></h3>

<p>
    An evaluation <i>A</i> happens before an evaluation <i>B</i> (or, equivalently, <i>B</i> happens after <i>A</i>) if:
</p>
<ul>
    <li><i>A</i> is sequenced before <i>B</i>, or
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    direction LR
                    A -->|SEQ| B
                end
        </div>
    </li>
    <li><i>A</i> inter-thread happens before <i>B</i>.
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    A
                end
                subgraph T2
                    direction TB
                    B
                end
                A -->|ITHB| B
        </div>
    </li>
</ul>
<p>
    <small>
        <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/n4868.pdf#page.82">C++ standard:
            [intro.races]</a>
    </small>
</p>

<h3><a name="simply-happens-before" href="#simply-happens-before">Simply happens before</a></h3>

<p>
    An evaluation <i>A</i> simply happens before an evaluation <i>B</i> if either
</p>
<ul>
    <li><i>A</i> is sequenced before <i>B</i>, or
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    direction LR
                    A -->|SEQ| B
                end
        </div>
    </li>
    <li><i>A</i> synchronizes with <i>B</i>, or
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    A
                end
                subgraph T2
                    direction TB
                    B
                end
                A -->|SYNC| B
        </div>
    </li>
    <li><i>A</i> simply happens before <i>X</i> and <i>X</i> simply happens before <i>B</i>.
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    A
                end
                subgraph T2
                    X
                end
                subgraph T3
                    B
                end
                A -->|simpHB| X
                X -->|simpHB| B
        </div>
    </li>
</ul>
<p>
    In the absence of consume operations, the happens before and simply happens before relations are identical.
</p>
<p>
    <small>
        <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/n4868.pdf#page.82">C++ standard:
            [intro.races]</a>
    </small>
</p>

<h3><a name="strongly-happens-before" href="#strongly-happens-before">Strongly happens before</a></h3>

<p>
    An evaluation <i>A</i> strongly happens before an evaluation <i>D</i> if, either
</p>
<ul>
    <li><i>A</i> is sequenced before <i>D</i>, or
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    direction LR
                    A -->|SEQ| D
                end
        </div>
    </li>
    <li><i>A</i> synchronizes with <i>D</i>, and both <i>A</i> and <i>D</i> are sequentially consistent atomic
        operations, or
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    A["seq_cst A"]
                end
                subgraph T2
                    direction TB
                    D["seq_cst D"]
                end
                A -->|SYNC| D
        </div>
    </li>
    <li>there are evaluations <i>B</i> and <i>C</i> such that <i>A</i> is sequenced before <i>B</i>, <i>B</i> simply
        happens before <i>C</i>, and <i>C</i> is sequenced before <i>D</i>, or
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    A -->|SEQ| B
                end
                subgraph T2
                    direction TB
                    C -->|SEQ| D
                end
                B -->|simpHB| C
        </div>
    </li>
    <li>there is an evaluation <i>B</i> such that <i>A</i> strongly happens before <i>B</i>, and <i>B</i> strongly
        happens before <i>D</i>.
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    A
                end
                subgraph T2
                    direction TB
                    B
                end
            subgraph T3
                direction TB
                D
            end
                A -->|SHB| B
                B -->|SHB| D
        </div>
    </li>
</ul>
<p>
    Informally, if <i>A</i> strongly happens before <i>B</i>, then <i>A</i> appears to be evaluated before <i>B</i> in
    all contexts.
    Strongly happens before excludes consume operations.
</p>
<p>
    <small>
        <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/n4868.pdf#page.82">C++ standard:
            [intro.races]</a>
    </small>
</p>

<h3><a name="modification-order" href="#modification-order">Modification order</a></h3>

<p>
    All modifications to a particular atomic object <i>M</i> occur in some particular total order,
    called the modification order of <i>M</i>.
</p>
<p>
    This order is usually guaranteed by the cache coherence of the hardware.<br>
    Note that there is no total order of modifications of <i>distinct</i>
    atomic objects.
</p>
<p>
    The value of an atomic object <i>M</i>, as determined by evaluation B, shall be the value stored by some side
    effect <i>A</i> that modifies <i>M</i>, where <i>B</i> does not happen before <i>A</i>.
</p>
<div class="mermaid">
    flowchart RL
        subgraph T1
            direction LR
            A["A(M)"]
        end
        subgraph T2
            direction LR
            B["B(M)"]
        end
        B --x|HB| A
</div>

<h4><a name="write-write-coherence" href="#write-write-coherence">Write-write coherence</a></h4>
<p>
    If an operation <i>A</i> that modifies an atomic object <i>M</i> happens before an operation <i>B</i> that modifies
    <i>M</i>, then <i>A</i> shall be earlier than <i>B</i> in the modification order of <i>M</i>.
</p>
<div class="mermaid">
    flowchart LR
        subgraph T1
            direction LR
            A["A(M)"]
        end
        subgraph T2
            direction LR
            B["B(M)"]
        end
        A -->|HB| B
</div>

<h4><a name="read-read-coherence" href="#read-read-coherence">Read-read coherence</a></h4>
<p>
    If a value computation <i>A</i> of an atomic object <i>M</i> happens before a value computation <i>B</i> of
    <i>M</i>, and <i>A</i> takes its value from a side effect <i>X</i> on <i>M</i>,
    then the value computed by <i>B</i> shall either be the value stored by <i>X</i> or
    the value stored by a side effect <i>Y</i> on <i>M</i>, where <i>Y</i> follows <i>X</i> in the modification order of
    <i>M</i>.
</p>
<div class="mermaid">
    flowchart LR
        subgraph T1
            direction LR
            X["X(M)"]
        end
        subgraph T2
            direction LR
            A["A(M)"]
        end
        subgraph T3
            direction LR
            Y["Y(M)"]
        end
        subgraph T4
            direction LR
            B["B(M)"]
        end
        X --> A
        A --->|HB| B
        X --->|MOD| Y
</div>

<h4><a name="read-write-coherence" href="#read-write-coherence">Read-write coherence</a></h4>
<p>
    If a value computation A of an atomic object M happens before an operation B that modifies M, then A
    shall take its value from a side effect X on M, where X precedes B in the modification order of M.
</p>
<div class="mermaid">
    flowchart LR
        subgraph T1
            direction LR
            X["X(M)"]
        end
        subgraph T2
            direction LR
            A["A(M)"]
        end
        subgraph T3
            direction LR
            B["B(M)"]
        end
        X --->|MOD| B
        A -->|HB| B
</div>

<h4><a name="write-read-coherence" href="#write-read-coherence">Write-read coherence</a></h4>
<p>
    If a side effect X on an atomic object M happens before a value computation B of M, then the evaluation B
    shall take its value from X or from a side effect Y that follows X in the modification order of M.
</p>
<div class="mermaid">
    flowchart LR
        subgraph T1
            direction LR
            X["X(M)"]
        end
        subgraph T2
            direction LR
            Y["Y(M)"]
        end
        subgraph T3
            direction LR
            B["B(M)"]
        end
        X -->|MOD| Y
        X --->|HB| B
</div>

<p>
    The four preceding coherence requirements effectively disallow compiler reordering of atomic operations
    to a single object, even if both operations are relaxed loads. This effectively makes the cache coherence guarantee
    provided by most hardware available to C++ atomic operations.
</p>
<p>
    The value observed by a load of an atomic depends on the “happens before” relation, which depends on the
    values observed by loads of atomics. The intended reading is that there must exist an association of atomic loads
    with modifications they observe that, together with suitably chosen modification orders and the “happens before”
    relation derived as described above, satisfy the resulting constraints as imposed here.
</p>

<p>
    <small>
        <a href="https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/n4868.pdf#page.82">C++ standard:
            [intro.races]</a>
    </small>
</p>

<h3><a name="release-sequence" href="#release-sequence">Release sequence</a></h3>

<p>
    A release sequence headed by a release operation A on an atomic object M is a maximal contiguous sub-
    sequence of side effects in the modification order of M, where the first operation is A, and every subsequent
    operation is an atomic read-modify-write operation.
</p>
<div class="mermaid">
    flowchart LR
        A["release A(M)"]
        B["rmw B(M)"]
        C["rmw C(M)"]
        etc["rmw &hellip;"]
        A -->|MOD| B
        B -->|MOD| C
        C -->|MOD| etc
</div>

<h3><a name="visible-side-effect" href="#visible-side-effect">Visible side effect</a></h3>

<p>
    A visible side effect <i>A</i> on a scalar object or bit-field <i>M</i> with respect to a value computation <i>B</i>
    of <i>M</i> satisfies the conditions:
</p>
<ul>
    <li>A happens before B and
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    direction LR
                    A["A(M)"]
                end
                subgraph T2
                    direction LR
                    B["B(M)"]
                end
                A -->|HB| B
        </div>
    </li>
    <li>there is no other side effect <i>X</i> to <i>M</i> such that <i>A</i> happens before <i>X</i> and <i>X</i>
        happens before <i>B</i>.
        <div class="mermaid">
            flowchart LR
                subgraph T1
                    direction LR
                    A["A(M)"]
                end
                subgraph T2
                    direction LR
                    X["X(M)"]
                end
                subgraph T3
                    direction LR
                    B["B(M)"]
                end
                A -->|HB| B
                A --x|HB| X
                X --x|HB| B
        </div>
    </li>
</ul>
<p>
    The value of a non-atomic scalar object or bit-field <i>M</i> , as determined by evaluation <i>B</i>,
    shall be the value stored by the visible side effect <i>A</i>.
</p>

<h3><a name="potentially-concurrent" href="#potentially-concurrent">Potentially concurrent</a></h3>

<p>
    Two actions are potentially concurrent if
</p>
<ul>
    <li>they are performed by different threads, or</li>
    <li>they are unsequenced, at least one is performed by a signal handler, and they are not both performed by the same
        signal handler invocation.</li>
</ul>

<h3><a name="data-race" href="#data-race">Data race</a></h3>

<p>
    The execution of a program contains a data race if it contains two potentially concurrent conflicting actions,
    at least one of which is not atomic, and neither happens before the other, except for the special case for
    signal handlers described below. Any such data race results in undefined behavior.
</p>
<p>
    It can be shown that programs that correctly use mutexes and <code>memory_order::seq_cst</code> operations to
    prevent all data races and use no other synchronization operations behave as if the operations executed by their
    constituent threads were simply interleaved, with each value computation of an object being taken from the last side
    effect on that object in that interleaving. This is normally referred to as “sequential consistency”. However, this
    applies only to data-race-free programs, and data-race-free programs cannot observe most program transformations
    that do not change single-threaded program semantics. In fact, most single-threaded program transformations continue
    to be allowed, since any program that behaves differently as a result has undefined behavior.
</p>
<p>
    Two accesses to the same object of type <code>volatile std::sig_atomic_t</code> do not result in a data race if
    both occur in the same thread, even if one or more occurs in a signal handler. For each signal handler
    invocation, evaluations performed by the thread invoking a signal handler can be divided into two groups A
    and B, such that no evaluations in B happen before evaluations in A, and the evaluations of such <code>volatile
        std::sig_atomic_t objects</code> take values as though all evaluations in A happened before the execution of
    the signal handler and the execution of the signal handler happened before all evaluations in B.
</p>
<div class="mermaid">
    flowchart LR
        subgraph T1
            direction BT
            A
            B
            B --x|HB| A
        end
        subgraph SIG
            direction TB
            S
        end
        A -->|HB| S
        S -->|HB| B
</div>

<!-- END -->

<script>
    mermaid.initialize({
        startOnLoad: true,
        theme: 'base',
        themeVariables: {
            primaryColor: '#f4f4ff',
            secondaryColor: '#f0f0f4',
            tertiaryColor: '#F9FAFC',
            fontFamily: 'monospace',
        },
    });
</script>

</div>
        <hr id="end-of-article">
        <div class="nextupprev"><div class="prevpage"></div><div class="uppage"><a href="index.html" title="Atomics">Index</a></div><div class="nextpage"><a href="Memory-order.html" title="Memory order">Next Page<i class="material-icons" style="vertical-align: middle; text-decoration: none"> chevron_right</i></a></div></div>
    </article>
    <footer>Last edited: Sunday, 26 June 2022 21:22 UTC</footer>
</body>

</html>